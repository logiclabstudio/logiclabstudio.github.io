<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logic Lab Invoice Generator</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#0f172a;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.12);
      --accent:#60a5fa;
      --accent2:#a78bfa;
      --ok:#22c55e;
      --danger:#fb7185;
      --radius:16px;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --max: 1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(900px 520px at 110% 10%, rgba(167,139,250,.20), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.45;
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:28px auto; padding:0 16px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; margin-bottom:16px;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .dot{
      width:12px; height:12px; border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 6px rgba(96,165,250,.14);
    }
    .brand h1{font-size:16px; margin:0; font-weight:800; letter-spacing:.2px}
    .brand p{margin:2px 0 0; color:var(--muted); font-size:12px}
    .actions{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end;
    }
    button, .btn{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover, .btn:hover{background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.18)}
    button:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(96,165,250,.35);
      background: linear-gradient(135deg, rgba(96,165,250,.22), rgba(167,139,250,.18));
    }
    .btn.ok{
      border-color: rgba(34,197,94,.35);
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(96,165,250,.10));
    }
    .btn.danger{
      border-color: rgba(251,113,133,.35);
      background: linear-gradient(135deg, rgba(251,113,133,.18), rgba(167,139,250,.08));
    }

    .grid{
      display:grid; grid-template-columns: 430px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
    }
    .card .hd h2{margin:0; font-size:14px; letter-spacing:.2px;}
    .card .hd .sub{margin:0; font-size:12px; color:var(--muted); font-weight:600;}
    .card .bd{padding:14px}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1.1fr .7fr .7fr; gap:10px}
    .row4{display:grid; grid-template-columns: 1.3fr .7fr .7fr .7fr; gap:10px}
    @media (max-width: 520px){
      .row,.row3,.row4{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:700;
    }
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(5,10,22,.55);
      color: var(--text);
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
      font-size:13px;
    }
    textarea{min-height:84px; resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px rgba(96,165,250,.12);
    }
    .mini{font-size:12px; color:var(--muted);}
    .hint{margin-top:8px; font-size:12px; color:var(--muted);}

    /* FIX: hr used outside preview too */
    .hr{height:1px; background:rgba(255,255,255,.12); margin:18px 0}

    /* Items table */
    .items{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    .items .thead, .items .trow{
      display:grid;
      grid-template-columns: 1.6fr .65fr .65fr .75fr 42px;
      gap:8px;
      padding:10px;
      align-items:center;
    }
    .items .thead{
      background: rgba(255,255,255,.05);
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .items .trow{border-bottom:1px solid rgba(255,255,255,.07);}
    .items .trow:last-child{border-bottom:none}
    .iconbtn{
      width:42px; height:38px;
      border-radius:12px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
    }
    .iconbtn:hover{background: rgba(255,255,255,.10)}
    .items input{padding:9px 10px; border-radius:12px; font-size:13px;}
    .items .num{text-align:right}
    .items .num input{text-align:right}

    /* Preview */
    .previewWrap{padding:0}
    .paper{
      background:#fff;
      color:#111827;
      padding:34px;
      min-height: 860px;
    }
    .paper *{box-sizing:border-box}
    .paper .muted{color:#6b7280}
    .paper .thin{font-weight:500}
    .paper .hr{height:1px; background:#e5e7eb; margin:18px 0}
    .paper .top{display:flex; justify-content:space-between; gap:18px; align-items:flex-start;}
    .paper .logoRow{display:flex; gap:12px; align-items:flex-start;}
    .paper .logo{
      width:56px; height:56px; border-radius:12px;
      object-fit:cover; border:1px solid #e5e7eb; background:#f3f4f6;
    }
    .paper .meta{text-align:right; min-width: 240px;}
    .paper .meta .tag{
      display:inline-block; padding:6px 10px;
      border:1px solid #e5e7eb; border-radius:999px;
      font-weight:700; font-size:12px; background:#f9fafb;
    }
    .paper .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-top:18px;}
    .paper .box{border:1px solid #e5e7eb; border-radius:14px; padding:14px; background:#fff;}
    .paper .box h3{
      margin:0 0 10px; font-size:12px; letter-spacing:.12em;
      text-transform:uppercase; color:#6b7280;
    }
    .paper .box .line{margin:4px 0; font-size:13px;}
    .paper table{width:100%; border-collapse: collapse; margin-top:16px; font-size:13px;}
    .paper thead th{
      text-align:left; padding:10px 8px; border-bottom:1px solid #e5e7eb;
      color:#6b7280; font-size:12px; text-transform:uppercase;
      letter-spacing:.08em;
    }
    .paper tbody td{padding:10px 8px; border-bottom:1px solid #f1f5f9; vertical-align:top;}
    .paper td.r, .paper th.r{text-align:right}
    .paper .totals{
      margin-top:16px;
      display:grid; grid-template-columns: 1fr 320px; gap:18px; align-items:start;
    }
    .paper .notes{border:1px solid #e5e7eb; border-radius:14px; padding:14px; background:#fff; min-height:120px;}
    .paper .sum{border:1px solid #e5e7eb; border-radius:14px; padding:14px; background:#fff;}
    .paper .sum .row{display:flex; justify-content:space-between; margin:8px 0; font-size:13px;}
    .paper .sum .due{
      margin-top:10px; padding-top:10px; border-top:1px dashed #e5e7eb;
      display:flex; justify-content:space-between; align-items:baseline;
    }
    .pillPaid{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:#ecfdf5; border:1px solid #bbf7d0;
      color:#065f46; font-weight:800; font-size:12px;
    }
    .pillUnpaid{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:#fff7ed; border:1px solid #fed7aa;
      color:#9a3412; font-weight:800; font-size:12px;
    }

@media print{
  /* Keep the app visible, only hide editor + toolbars */
  body{
    background:#fff !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* DON'T hide .wrap (that was making the PDF blank) */
  .topbar,
  .leftPane,
  .card.preview .hd,   /* hides the "Preview / Print-ready layout / button" bar */
  #btnPrint2           /* extra safety */
  { display:none !important; }

  .wrap{
    margin:0 !important;
    padding:0 !important;
    max-width:none !important;
  }

  .grid{ display:block !important; }
  .card.preview{
    border:none !important;
    box-shadow:none !important;
    background:transparent !important;
  }

  .previewWrap{ padding:0 !important; }
  .paper{
    padding:0 !important;          /* or keep 12mm if you want spacing */
    min-height:auto !important;
  }

  /* Page settings */
  @page{ size: A4; margin: 12mm; }
}


  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Logic Lab Invoice Generator</h1>
          <p class="mini">Build, print, export/import ‚Äî local-only</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnNew">üßæ New</button>
        <button class="btn" id="btnExport">‚¨áÔ∏è Export JSON</button>
        <label class="btn" for="importFile" style="cursor:pointer;">‚¨ÜÔ∏è Import JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button class="btn primary" id="btnPrint">üñ®Ô∏è Print / Save PDF</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Editor -->
      <div class="card leftPane">
        <div class="hd">
          <div>
            <h2>Invoice Details</h2>
            <p class="sub">No cursor jumping. Updates instantly.</p>
          </div>
          <div class="mini" id="autosaveStatus">Autosave: on</div>
        </div>

        <div class="bd">
          <div class="row">
            <div>
              <label>Business Name</label>
              <input id="bizName" placeholder="Logic Lab" />
            </div>
            <div>
              <label>Invoice #</label>
              <input id="invNumber" placeholder="INV-0001" />
              <div class="hint">Tip: click ‚ÄúNew‚Äù to auto-generate</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Business Email</label>
              <input id="bizEmail" placeholder="hello@company.com" />
            </div>
            <div>
              <label>Business Phone</label>
              <input id="bizPhone" placeholder="+27 00 000 0000" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Business Address</label>
              <textarea id="bizAddress" placeholder="Street, City, Country"></textarea>
            </div>
            <div>
              <label>Logo (optional)</label>
              <input id="logoFile" type="file" accept="image/*" />
              <div class="hint">Local preview only (not uploaded anywhere).</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Bill To (Client Name)</label>
              <input id="clientName" placeholder="Client Name" />
            </div>
            <div>
              <label>Client Email</label>
              <input id="clientEmail" placeholder="client@email.com" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Client Address</label>
              <textarea id="clientAddress" placeholder="Street, City, Country"></textarea>
            </div>
            <div>
              <label>Status</label>
              <select id="status">
                <option value="unpaid" selected>Unpaid</option>
                <option value="paid">Paid</option>
              </select>
              <div class="hint">Status badge appears on invoice.</div>
            </div>
          </div>

          <div class="row3">
            <div>
              <label>Issue Date</label>
              <input id="issueDate" type="date" />
            </div>
            <div>
              <label>Due Date</label>
              <input id="dueDate" type="date" />
            </div>
            <div>
              <label>Currency</label>
              <select id="currency">
                <option value="ZAR" selected>ZAR (R)</option>
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (‚Ç¨)</option>
                <option value="GBP">GBP (¬£)</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px">
            <div>
              <div style="font-weight:900;">Line Items</div>
              <div class="mini">No re-render while typing.</div>
            </div>
            <button class="btn ok" id="btnAddItem" type="button">‚ûï Add item</button>
          </div>

          <div class="items" id="items">
            <div class="thead">
              <div>Description</div>
              <div class="r">Qty</div>
              <div class="r">Rate</div>
              <div class="r">Amount</div>
              <div></div>
            </div>
            <div id="itemsBody"></div>
          </div>

          <div class="hr"></div>

          <div class="row4">
            <div>
              <label>Discount</label>
              <div class="row3" style="grid-template-columns: 1fr .8fr;">
                <input id="discountValue" type="number" min="0" step="0.01" value="0" />
                <select id="discountType">
                  <option value="amount" selected>Amount</option>
                  <option value="percent">Percent</option>
                </select>
              </div>
              <div class="hint">Percent applies to subtotal.</div>
            </div>
            <div>
              <label>Tax %</label>
              <input id="taxRate" type="number" min="0" step="0.01" value="0" />
            </div>
            <div>
              <label>Amount Paid</label>
              <input id="amountPaid" type="number" min="0" step="0.01" value="0" />
            </div>
            <div>
              <label>Shipping/Other</label>
              <input id="shipping" type="number" min="0" step="0.01" value="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Notes</label>
              <textarea id="notes" placeholder="Payment terms, bank details, thanks message..."></textarea>
            </div>
            <div>
              <label>Payment Method (optional)</label>
              <textarea id="payment" placeholder="e.g. Bank: ... | Acc: ... | Ref: Invoice #"></textarea>
            </div>
          </div>

          <div class="hr"></div>
          <button class="btn danger" id="btnClearSaved" type="button">üóëÔ∏è Clear autosaved draft</button>
        </div>
      </div>

      <!-- RIGHT: Preview -->
      <div class="card preview">
        <div class="hd">
          <div>
            <h2>Preview</h2>
            <p class="sub">Print-ready layout (A4 friendly)</p>
          </div>
          <div style="display:flex; gap:10px; align-items:center">
            <button class="btn primary" id="btnPrint2" type="button">üñ®Ô∏è Print / Save PDF</button>
          </div>
        </div>

        <div class="previewWrap">
          <div class="paper" id="paper">
            <div class="top">
              <div>
                <div class="logoRow">
                  <img id="logoPreview" class="logo" alt="" style="display:none" />
                  <div>
                    <div style="font-weight:900; font-size:18px;" id="pBizName">‚Äî</div>
                    <div class="muted thin" id="pBizAddress"></div>
                    <div class="muted thin" id="pBizEmail"></div>
                    <div class="muted thin" id="pBizPhone"></div>
                  </div>
                </div>
              </div>

              <div class="meta">
                <div style="display:flex; justify-content:flex-end; gap:10px; align-items:center; flex-wrap:wrap;">
                  <span class="tag">INVOICE</span>
                  <span id="pStatus" class="pillUnpaid">‚óè UNPAID</span>
                </div>
                <div class="hr" style="margin:12px 0"></div>
                <div class="muted thin" style="font-size:13px; line-height:1.7;">
                  <div><strong>Invoice #:</strong> <span id="pInvNumber">‚Äî</span></div>
                  <div><strong>Issue Date:</strong> <span id="pIssueDate">‚Äî</span></div>
                  <div><strong>Due Date:</strong> <span id="pDueDate">‚Äî</span></div>
                </div>
              </div>
            </div>

            <div class="twoCol">
              <div class="box">
                <h3>Bill To</h3>
                <div class="line" id="pClientName">‚Äî</div>
                <div class="line muted" id="pClientAddress"></div>
                <div class="line muted" id="pClientEmail"></div>
              </div>

              <div class="box">
                <h3>Payment</h3>
                <div class="line muted" id="pPayment">‚Äî</div>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>Description</th>
                  <th class="r">Qty</th>
                  <th class="r">Rate</th>
                  <th class="r">Amount</th>
                </tr>
              </thead>
              <tbody id="pItems"></tbody>
            </table>

            <div class="totals">
              <div class="notes">
                <div style="font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:#6b7280; font-weight:800; margin-bottom:10px;">
                  Notes
                </div>
                <div id="pNotes" style="font-size:13px; white-space:pre-wrap;" class="thin muted">‚Äî</div>
              </div>

              <div class="sum">
                <div class="row"><span class="muted">Subtotal</span><span id="pSubtotal">‚Äî</span></div>
                <div class="row"><span class="muted">Discount</span><span id="pDiscount">‚Äî</span></div>
                <div class="row"><span class="muted">Tax</span><span id="pTax">‚Äî</span></div>
                <div class="row"><span class="muted">Shipping/Other</span><span id="pShipping">‚Äî</span></div>
                <div class="hr" style="margin:12px 0"></div>
                <div class="row"><strong>Total</strong><strong id="pTotal">‚Äî</strong></div>
                <div class="row"><span class="muted">Paid</span><span id="pPaid">‚Äî</span></div>
                <div class="due">
                  <strong>Balance Due</strong>
                  <strong id="pDue">‚Äî</strong>
                </div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="muted thin" style="font-size:12px;">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const LS_KEY = "invoice_generator_draft_v1";

  const currencySymbols = { ZAR: "R", USD: "$", EUR: "‚Ç¨", GBP: "¬£" };

  function pad(n, width=4){
    const s = String(n);
    return s.length >= width ? s : "0".repeat(width - s.length) + s;
  }
  function formatMoney(value, currency){
    const sym = currencySymbols[currency] ?? "";
    const n = Number(value || 0);
    return sym + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function clampMin0(n){
    n = Number(n || 0);
    return isFinite(n) ? Math.max(0, n) : 0;
  }
  function todayISO(){
    const d = new Date();
    const tzOffset = d.getTimezoneOffset() * 60000;
    return new Date(d - tzOffset).toISOString().slice(0,10);
  }
  function addDaysISO(iso, days){
    const d = new Date(iso + "T00:00:00");
    d.setDate(d.getDate() + days);
    const tzOffset = d.getTimezoneOffset() * 60000;
    return new Date(d - tzOffset).toISOString().slice(0,10);
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  // prevent mousewheel changing number fields (annoying)
  document.addEventListener("wheel", (e)=>{
    const t = e.target;
    if(t && t.tagName === "INPUT" && t.type === "number"){
      t.blur();
      setTimeout(()=>t.focus({preventScroll:true}), 0);
    }
  }, { passive:true });

  // ---------- Line Items ----------
  let items = [];

  function makeId(){
    return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Math.random().toString(16).slice(2) + Date.now().toString(16));
  }
  function makeItem(desc="Service / Product", qty=1, rate=0){
    return { id: makeId(), desc, qty, rate };
  }
  function amountOf(it){
    return Number(it.qty||0) * Number(it.rate||0);
  }

  function renderItemsEditor(){
    const body = $("itemsBody");
    body.innerHTML = "";

    for(const it of items){
      const row = document.createElement("div");
      row.className = "trow";
      row.dataset.id = it.id;

      row.innerHTML = `
        <div><input data-k="desc" value="${escapeHtml(it.desc)}" placeholder="Description" /></div>
        <div class="num"><input data-k="qty" value="${it.qty}" type="number" min="0" step="1" /></div>
        <div class="num"><input data-k="rate" value="${it.rate}" type="number" min="0" step="0.01" /></div>
        <div class="num"><input data-k="amount" value="${amountOf(it).toFixed(2)}" disabled /></div>
        <div><button class="iconbtn" type="button" title="Remove" data-remove="1">‚úï</button></div>
      `;
      body.appendChild(row);
    }
  }

  // event delegation: no re-render while typing
  $("itemsBody").addEventListener("input", (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLInputElement)) return;
    const row = t.closest(".trow");
    if(!row) return;

    const id = row.dataset.id;
    const it = items.find(x=>x.id===id);
    if(!it) return;

    const k = t.getAttribute("data-k");
    if(k === "desc") it.desc = t.value;
    if(k === "qty") it.qty = clampMin0(t.value);
    if(k === "rate") it.rate = clampMin0(t.value);

    // update amount field in same row only
    const amtInput = row.querySelector('input[data-k="amount"]');
    if(amtInput) amtInput.value = amountOf(it).toFixed(2);

    updatePreview();
    scheduleAutosave();
  });

  $("itemsBody").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-remove]");
    if(!btn) return;
    const row = btn.closest(".trow");
    if(!row) return;
    const id = row.dataset.id;

    items = items.filter(x=>x.id !== id);
    if(items.length === 0) items = [makeItem()];
    renderItemsEditor();
    updatePreview();
    scheduleAutosave();
  });

  // ---------- Calculations ----------
  function calc(){
    const currency = $("currency").value;
    const subtotal = items.reduce((sum, it) => sum + amountOf(it), 0);

    const discountValue = clampMin0($("discountValue").value);
    const discountType = $("discountType").value;
    let discount = 0;

    if(discountType === "percent"){
      const pct = Math.min(100, discountValue);
      discount = subtotal * (pct/100);
    }else{
      discount = Math.min(subtotal, discountValue);
    }

    const taxRate = clampMin0($("taxRate").value);
    const taxable = Math.max(0, subtotal - discount);
    const tax = taxable * (taxRate/100);

    const shipping = clampMin0($("shipping").value);
    const total = taxable + tax + shipping;

    const paid = clampMin0($("amountPaid").value);
    const due = Math.max(0, total - paid);

    return { currency, subtotal, discount, tax, shipping, total, paid, due };
  }

  // ---------- Preview ----------
  function updatePreview(){
    const c = calc();

    $("pBizName").textContent = $("bizName").value || "‚Äî";
    $("pBizEmail").textContent = $("bizEmail").value ? ("Email: " + $("bizEmail").value) : "";
    $("pBizPhone").textContent = $("bizPhone").value ? ("Phone: " + $("bizPhone").value) : "";
    $("pBizAddress").textContent = $("bizAddress").value || "";

    $("pInvNumber").textContent = $("invNumber").value || "‚Äî";
    $("pIssueDate").textContent = $("issueDate").value || "‚Äî";
    $("pDueDate").textContent = $("dueDate").value || "‚Äî";

    $("pClientName").textContent = $("clientName").value || "‚Äî";
    $("pClientEmail").textContent = $("clientEmail").value ? ("Email: " + $("clientEmail").value) : "";
    $("pClientAddress").textContent = $("clientAddress").value || "";

    const status = $("status").value;
    const statusEl = $("pStatus");
    if(status === "paid"){
      statusEl.className = "pillPaid";
      statusEl.textContent = "‚óè PAID";
    }else{
      statusEl.className = "pillUnpaid";
      statusEl.textContent = "‚óè UNPAID";
    }

    const paymentText = ($("payment").value || "").trim();
    $("pPayment").textContent = paymentText ? paymentText : "‚Äî";

    const notesText = ($("notes").value || "").trim();
    $("pNotes").textContent = notesText ? notesText : "‚Äî";

    // Items table
    const pItems = $("pItems");
    pItems.innerHTML = "";
    for(const it of items){
      const tr = document.createElement("tr");
      const amount = amountOf(it);
      tr.innerHTML = `
        <td style="white-space:pre-wrap;">${escapeHtml(it.desc || "")}</td>
        <td class="r">${Number(it.qty||0)}</td>
        <td class="r">${escapeHtml(formatMoney(it.rate, c.currency))}</td>
        <td class="r">${escapeHtml(formatMoney(amount, c.currency))}</td>
      `;
      pItems.appendChild(tr);
    }

    // Totals
    $("pSubtotal").textContent = formatMoney(c.subtotal, c.currency);

    const discountType = $("discountType").value;
    const discountValue = clampMin0($("discountValue").value);

    if(discountType === "percent" && discountValue > 0){
      $("pDiscount").textContent = "-" + formatMoney(c.discount, c.currency) + ` (${discountValue.toFixed(2)}%)`;
    }else{
      $("pDiscount").textContent = (c.discount > 0) ? ("-" + formatMoney(c.discount, c.currency)) : formatMoney(0, c.currency);
    }

    const taxRate = clampMin0($("taxRate").value);
    $("pTax").textContent = formatMoney(c.tax, c.currency) + (taxRate ? ` (${taxRate.toFixed(2)}%)` : "");

    $("pShipping").textContent = formatMoney(c.shipping, c.currency);
    $("pTotal").textContent = formatMoney(c.total, c.currency);
    $("pPaid").textContent = formatMoney(c.paid, c.currency);
    $("pDue").textContent = formatMoney(c.due, c.currency);
  }

  // ---------- Save/Load JSON ----------
  function collectData(){
    return {
      version: 1,
      biz: {
        name: $("bizName").value,
        email: $("bizEmail").value,
        phone: $("bizPhone").value,
        address: $("bizAddress").value,
        logoDataUrl: ($("logoPreview").src && $("logoPreview").style.display !== "none") ? $("logoPreview").src : ""
      },
      invoice: {
        number: $("invNumber").value,
        issueDate: $("issueDate").value,
        dueDate: $("dueDate").value,
        status: $("status").value,
        currency: $("currency").value
      },
      client: {
        name: $("clientName").value,
        email: $("clientEmail").value,
        address: $("clientAddress").value
      },
      items: items.map(x=>({ desc:x.desc, qty:x.qty, rate:x.rate })),
      totals: {
        discountValue: $("discountValue").value,
        discountType: $("discountType").value,
        taxRate: $("taxRate").value,
        shipping: $("shipping").value,
        amountPaid: $("amountPaid").value
      },
      notes: $("notes").value,
      payment: $("payment").value
    };
  }

  function applyData(data){
    $("bizName").value = data?.biz?.name ?? "";
    $("bizEmail").value = data?.biz?.email ?? "";
    $("bizPhone").value = data?.biz?.phone ?? "";
    $("bizAddress").value = data?.biz?.address ?? "";

    const logo = data?.biz?.logoDataUrl ?? "";
    if(logo){
      $("logoPreview").src = logo;
      $("logoPreview").style.display = "";
    }else{
      $("logoPreview").src = "";
      $("logoPreview").style.display = "none";
    }

    $("invNumber").value = data?.invoice?.number ?? "";
    $("issueDate").value = data?.invoice?.issueDate ?? todayISO();
    $("dueDate").value = data?.invoice?.dueDate ?? addDaysISO($("issueDate").value, 7);
    $("status").value = data?.invoice?.status ?? "unpaid";
    $("currency").value = data?.invoice?.currency ?? "ZAR";

    $("clientName").value = data?.client?.name ?? "";
    $("clientEmail").value = data?.client?.email ?? "";
    $("clientAddress").value = data?.client?.address ?? "";

    const it = Array.isArray(data?.items) ? data.items : [];
    items = it.length ? it.map(x=>makeItem(x.desc ?? "", clampMin0(x.qty), clampMin0(x.rate))) : [makeItem()];

    $("discountValue").value = data?.totals?.discountValue ?? "0";
    $("discountType").value = data?.totals?.discountType ?? "amount";
    $("taxRate").value = data?.totals?.taxRate ?? "0";
    $("shipping").value = data?.totals?.shipping ?? "0";
    $("amountPaid").value = data?.totals?.amountPaid ?? "0";

    $("notes").value = data?.notes ?? "";
    $("payment").value = data?.payment ?? "";

    renderItemsEditor();
    updatePreview();
  }

  function downloadJson(){
    const data = collectData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const file = (data?.invoice?.number ? data.invoice.number : "invoice") + ".json";
    a.download = file.replace(/[^\w\-\.]+/g, "_");
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------- New Invoice ----------
  let invCounter = 1;

  function newInvoice(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    const d = String(now.getDate()).padStart(2,"0");
    const num = `INV-${y}${m}${d}-${pad(invCounter++, 3)}`;
    $("invNumber").value = num;

    const issue = todayISO();
    $("issueDate").value = issue;
    $("dueDate").value = addDaysISO(issue, 7);

    $("status").value = "unpaid";
    $("discountValue").value = "0";
    $("discountType").value = "amount";
    $("taxRate").value = "0";
    $("shipping").value = "0";
    $("amountPaid").value = "0";

    // keep biz details, clear client + notes
    $("clientName").value = "";
    $("clientEmail").value = "";
    $("clientAddress").value = "";
    $("notes").value = "";
    $("payment").value = "";

    items = [
      makeItem("Website design & development", 1, 0),
      makeItem("Hosting / maintenance", 1, 0),
    ];

    renderItemsEditor();
    updatePreview();
    scheduleAutosave();
  }

  // ---------- Logo upload ----------
  $("logoFile").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      $("logoPreview").src = reader.result;
      $("logoPreview").style.display = "";
      updatePreview();
      scheduleAutosave();
    };
    reader.readAsDataURL(file);
  });

  // ---------- Autosave ----------
  let saveTimer = null;
  function setAutosaveStatus(text){
    $("autosaveStatus").textContent = text;
  }
  function scheduleAutosave(){
    setAutosaveStatus("Autosave: pending‚Ä¶");
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      try{
        localStorage.setItem(LS_KEY, JSON.stringify(collectData()));
        setAutosaveStatus("Autosave: saved");
      }catch{
        setAutosaveStatus("Autosave: failed");
      }
    }, 250);
  }
  function loadAutosave(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return false;
      const data = JSON.parse(raw);
      applyData(data);
      setAutosaveStatus("Autosave: loaded");
      return true;
    }catch{
      return false;
    }
  }

  // ---------- Events ----------
  const inputsToWatch = [
    "bizName","bizEmail","bizPhone","bizAddress",
    "invNumber","issueDate","dueDate","status","currency",
    "clientName","clientEmail","clientAddress",
    "discountValue","discountType","taxRate","shipping","amountPaid",
    "notes","payment"
  ];
  inputsToWatch.forEach(id=>{
    $(id).addEventListener("input", ()=>{ updatePreview(); scheduleAutosave(); });
    $(id).addEventListener("change", ()=>{ updatePreview(); scheduleAutosave(); });
  });

  $("btnAddItem").addEventListener("click", ()=>{
    items.push(makeItem("Service / Product", 1, 0));
    renderItemsEditor();
    updatePreview();
    scheduleAutosave();
  });

  $("btnPrint").addEventListener("click", ()=> window.print());
  $("btnPrint2").addEventListener("click", ()=> window.print());

  $("btnExport").addEventListener("click", downloadJson);

  $("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      applyData(data);
      scheduleAutosave();
    }catch{
      alert("Invalid JSON file.");
    }finally{
      e.target.value = "";
    }
  });

  $("btnNew").addEventListener("click", newInvoice);

  $("btnClearSaved").addEventListener("click", ()=>{
    localStorage.removeItem(LS_KEY);
    setAutosaveStatus("Autosave: cleared");
  });

  // ---------- Init ----------
  (function init(){
    $("issueDate").value = todayISO();
    $("dueDate").value = addDaysISO($("issueDate").value, 7);

    items = [makeItem("Service / Product", 1, 0)];
    renderItemsEditor();

    // load autosave if present; otherwise create fresh invoice #
    const loaded = loadAutosave();
    if(!loaded){
      $("bizName").value = "Your Business Name";
      newInvoice();
    }else{
      updatePreview();
    }
  })();
</script>
</body>
</html>
