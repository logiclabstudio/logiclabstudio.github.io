<!doctype html>
<html lang="en" data-theme="white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <title>Smart Whiteboard ‚Äî Logic Lab (Offline)</title>

  <style>
    /* =========================================================
       THEME SYSTEM
       - default: white
       - options: white | brown
    ========================================================= */
    :root{
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      /* Default theme = WHITE */
      --bg:#f6f7fb;
      --bg2:#ffffff;
      --panel: rgba(255,255,255,.86);
      --panel2: rgba(255,255,255,.96);
      --text:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.14);
      --line2:rgba(15,23,42,.10);
      --accent:#2563eb;
      --accent2:#0ea5e9;
      --ok:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;
      --ring: rgba(37,99,235,.22);
      --shadow: 0 18px 55px rgba(2,6,23,.12);
      --radius:16px;
      --radius2:20px;
      --max: 1500px;
      --cardBg: rgba(248,250,252,.88);
      --chipBg: rgba(2,6,23,.04);
      --chipBorder: rgba(2,6,23,.12);
      --dropBg: rgba(2,6,23,.04);
      --inputBg: rgba(2,6,23,.04);
    }

    /* Brown theme */
    html[data-theme="brown"]{
      --bg:#1a1411;
      --bg2:#0f0b08;
      --panel: rgba(52,36,28,.62);
      --panel2: rgba(52,36,28,.85);
      --text:#f5ede6;
      --muted:#c9b8ab;
      --line:rgba(245,237,230,.14);
      --line2:rgba(245,237,230,.10);
      --accent:#d4a373;
      --accent2:#f4d58d;
      --ok:#7fb069;
      --warn:#f4d35e;
      --bad:#ee6c4d;
      --ring: rgba(212,163,115,.30);
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --cardBg: rgba(25,18,15,.35);
      --chipBg: rgba(245,237,230,.05);
      --chipBorder: rgba(245,237,230,.12);
      --dropBg: rgba(25,18,15,.22);
      --inputBg: rgba(25,18,15,.30);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(14,165,233,.08), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }
    html[data-theme="brown"] body{
      background:
        radial-gradient(1100px 650px at 15% -10%, rgba(212,163,115,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(244,213,141,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .wrap{max-width:var(--max); margin:0 auto; padding:14px 14px 18px;}

    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 12px;
      background:linear-gradient(180deg, rgba(2,6,23,.03), rgba(2,6,23,.01));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky; top:10px; z-index:10;
      backdrop-filter: blur(10px);
    }

    .brand{display:flex; flex-direction:column; gap:2px}
    .brand .t{font-weight:900; letter-spacing:.2px; font-size:14px}
    .brand .s{color:var(--muted); font-size:12px}

    .top{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}

    button,.btn{
      appearance:none; border:1px solid var(--line);
      background: rgba(2,6,23,.04);
      color:var(--text); padding:10px 12px; border-radius:14px;
      cursor:pointer; font-weight:900; font-size:12px;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
      user-select:none;
    }
    html[data-theme="brown"] button,
    html[data-theme="brown"] .btn{ background: rgba(25,18,15,.30); }

    button:hover{border-color:rgba(37,99,235,.35)}
    html[data-theme="brown"] button:hover{border-color: rgba(212,163,115,.55)}
    button:active{transform: translateY(1px)}

    button.primary{border-color: rgba(37,99,235,.40); background: rgba(37,99,235,.08)}
    html[data-theme="brown"] button.primary{border-color: rgba(212,163,115,.55); background: rgba(212,163,115,.14)}

    button.ghost{background:transparent}

    button.danger{border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.06)}
    html[data-theme="brown"] button.danger{border-color: rgba(238,108,77,.45); background: rgba(238,108,77,.10)}

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      background: rgba(2,6,23,.03);
      color:var(--text);
      font-size:12px;
      white-space:nowrap;
    }
    html[data-theme="brown"] .pill{background: rgba(25,18,15,.22)}

    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}

    .board{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(260px, 1fr));
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1100px){ .board{grid-template-columns: repeat(2, minmax(260px, 1fr));} }
    @media (max-width: 650px){
      .board{grid-template-columns: 1fr;}
      header{position:relative; top:0}
    }

    .col{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 240px;
    }

    .colHd{
      padding:10px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(2,6,23,.03), rgba(2,6,23,.01));
      border-bottom:1px solid var(--line2);
    }
    html[data-theme="brown"] .colHd{ background:linear-gradient(180deg, rgba(245,237,230,.05), rgba(245,237,230,.01)); }

    .colTitle{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .colTitle .name{font-weight:1000; font-size:13px; display:flex; gap:8px; align-items:center;}
    .colTitle .meta{font-size:12px; color:var(--muted)}

    .countBadge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:24px; height:24px;
      padding:0 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(2,6,23,.03);
      font-size:12px; font-weight:1000;
    }
    html[data-theme="brown"] .countBadge{background: rgba(245,237,230,.05)}

    .colBody{ padding:10px; display:flex; flex-direction:column; gap:10px; flex:1; }

    .dropHint{
      border:1px dashed rgba(2,6,23,.14);
      border-radius: 16px;
      padding:10px;
      color: rgba(15,23,42,.65);
      background: var(--dropBg);
      font-size:12px;
      text-align:center;
    }
    html[data-theme="brown"] .dropHint{ color: rgba(245,237,230,.75); border-color: rgba(245,237,230,.16); }

    .card{
      border:1px solid var(--line);
      background: var(--cardBg);
      border-radius: 18px;
      padding:10px;
      cursor:grab;
      box-shadow: 0 14px 40px rgba(2,6,23,.10);
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      position:relative;
    }
    html[data-theme="brown"] .card{box-shadow: 0 14px 40px rgba(0,0,0,.28);}

    .card:active{cursor:grabbing}
    .card:hover{border-color: rgba(37,99,235,.30)}
    html[data-theme="brown"] .card:hover{border-color: rgba(212,163,115,.45)}
    .card.dragging{opacity:.6; transform: scale(.99)}

    .cardTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .cardTitle{font-weight:1000; font-size:13px; line-height:1.15; word-break:break-word;}
    .cardMeta{margin-top:6px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:12px;}
    .tag{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--chipBorder); background: var(--chipBg); padding:6px 10px; border-radius: 999px; font-size:12px; font-weight:900; white-space:nowrap;}

    /* Smart styling classes */
    .prio-low{border-color: rgba(148,163,184,.35)}
    .prio-normal{border-color: rgba(37,99,235,.30)}
    .prio-urgent{border-color: rgba(217,119,6,.38)}
    html[data-theme="brown"] .prio-normal{border-color: rgba(212,163,115,.55)}
    html[data-theme="brown"] .prio-urgent{border-color: rgba(244,213,141,.65)}

    .status-overdue{border-color: rgba(220,38,38,.55)}
    html[data-theme="brown"] .status-overdue{border-color: rgba(238,108,77,.70)}

    .status-due{border-color: rgba(217,119,6,.50)}
    html[data-theme="brown"] .status-due{border-color: rgba(244,213,141,.65)}

    .status-stale{border-color: rgba(14,165,233,.30)}
    html[data-theme="brown"] .status-stale{border-color: rgba(244,213,141,.55)}

    .miniBtns{display:flex; gap:8px}
    .miniBtn{
      width:32px; height:32px; border-radius:12px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--line2);
      background: rgba(2,6,23,.03);
      cursor:pointer;
      user-select:none;
    }
    html[data-theme="brown"] .miniBtn{background: rgba(245,237,230,.05)}
    .miniBtn:hover{border-color: rgba(37,99,235,.35)}
    html[data-theme="brown"] .miniBtn:hover{border-color: rgba(212,163,115,.55)}

    .kpiBar{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .kpi{display:flex; flex-direction:column; gap:2px; padding:8px 10px; border-radius: 14px; border:1px solid var(--line); background: rgba(2,6,23,.03);}
    html[data-theme="brown"] .kpi{background: rgba(25,18,15,.22)}
    .kpi .k{font-size:11px; color:var(--muted)}
    .kpi .v{font-weight:1000; letter-spacing:.2px}

    .rightInfo{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
    .hint{font-size:12px; color:var(--muted)}

    .search{display:flex; gap:8px; align-items:center; border:1px solid var(--line); background: rgba(2,6,23,.03); border-radius: 999px; padding:8px 10px; min-width: 240px;}
    html[data-theme="brown"] .search{background: rgba(25,18,15,.22)}
    .search input{border:none; outline:none; background:transparent; color:var(--text); width: 100%; font-size:12px;}
    .search input::placeholder{color: rgba(71,85,105,.75)}
    html[data-theme="brown"] .search input::placeholder{color: rgba(201,184,171,.75)}

    .foot{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; padding:12px; border:1px solid var(--line); border-radius: var(--radius); background: rgba(2,6,23,.02);}
    html[data-theme="brown"] .foot{background: rgba(25,18,15,.22)}

    dialog{border:none; border-radius: 18px; padding:0; width: min(760px, 94vw); background: var(--panel2); color: var(--text); box-shadow: var(--shadow);}
    dialog::backdrop{background: rgba(2,6,23,.25)}
    html[data-theme="brown"] dialog::backdrop{background: rgba(0,0,0,.55)}

    .dlgHd{padding:12px 12px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:10px; background: rgba(2,6,23,.02);}
    html[data-theme="brown"] .dlgHd{background: rgba(245,237,230,.03)}

    .dlgHd .t{font-weight:1000}
    .dlgBd{padding:12px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;}
    @media (max-width: 560px){ .row{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:10px}

    input, select, textarea{width:100%; padding:10px 10px; border-radius: 14px; border:1px solid var(--line); background: var(--inputBg); color: var(--text); outline:none; font-size: 13px;}
    input:focus, select:focus, textarea:focus{border-color: rgba(37,99,235,.35); box-shadow: 0 0 0 3px var(--ring)}
    html[data-theme="brown"] input:focus,
    html[data-theme="brown"] select:focus,
    html[data-theme="brown"] textarea:focus{border-color: rgba(212,163,115,.55); box-shadow: 0 0 0 3px rgba(212,163,115,.28)}

    textarea{min-height:90px; resize:vertical}

    .dlgActions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding:12px; border-top:1px solid var(--line)}

    /* ---------- Toggle Switch ---------- */
    .toggle{display:inline-flex; align-items:center; gap:10px; padding:8px 10px; border-radius: 999px; border:1px solid var(--line); background: rgba(2,6,23,.03); user-select:none;}
    html[data-theme="brown"] .toggle{background: rgba(25,18,15,.22)}

    .switch{width:44px; height:26px; border-radius:999px; border:1px solid var(--line); background: rgba(2,6,23,.05); position:relative; cursor:pointer; flex: 0 0 auto;}
    html[data-theme="brown"] .switch{background: rgba(245,237,230,.06)}

    .knob{width:22px; height:22px; border-radius:999px; background: var(--text); position:absolute; top:1px; left:1px; transition: left .18s ease, background .18s ease;}

    .switch.on{border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.10);}
    html[data-theme="brown"] .switch.on{border-color: rgba(212,163,115,.55); background: rgba(212,163,115,.18);}
    .switch.on .knob{left:21px; background: #fff}

    /* ---------- Wall mode ---------- */
    html.wall header, html.wall .foot, html.wall .noWall{display:none !important}
    html.wall .wrap{max-width: none; padding:12px;}
    html.wall .board{gap:10px}
    html.wall .col{min-height: calc(100vh - 24px); border-radius: 22px}
    html.wall .colHd{padding:14px 14px}
    html.wall .colTitle .name{font-size:16px}
    html.wall .colTitle .meta{font-size:12px}
    html.wall .card{padding:12px}
    html.wall .cardTitle{font-size:15px}
    html.wall .tag{font-size:12px; padding:7px 12px}
    html.wall .colBody{padding:12px}

    /* Read-only mode (blocks all edits, even outside wall mode) */
    html.readonly .noReadonly{display:none !important}

    /* Wall-mode exit button (always visible in wall mode) */
    .wallExit{
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 99999;
      display: none;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.86);
      color: var(--text);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      font-weight: 1000;
      cursor: pointer;
    }
    html[data-theme="brown"] .wallExit{ background: rgba(25,18,15,.72); }
    html.wall .wallExit{ display: inline-flex; }

    @media print{
      header, .foot, .noPrint, .noWall, .wallExit{display:none !important;}
      body{background:#fff !important; color:#111 !important}
      .wrap{padding:0}
      .col{box-shadow:none; background:#fff; border:1px solid #ddd}
      .card{box-shadow:none; background:#fff; border:1px solid #ddd}
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="t" id="brandTitle">Smart Whiteboard (Offline)</div>
      <div class="s" id="brandSub">Multiple boards ‚Ä¢ Lockable wall mode ‚Ä¢ Shift summary</div>
    </div>

    <div class="top">
      <div class="pill noWall" title="Switch between boards">
        <span class="muted">Board:</span>
        <select id="boardSelect" style="padding:6px 10px; border-radius:999px; min-width:170px"></select>
        <button class="ghost" id="btnNewBoard" title="Create a new board">+</button>
        <button class="ghost" id="btnRenameBoard" title="Rename current board">Rename</button>
        <button class="danger" id="btnDeleteBoard" title="Delete current board">Delete</button>
      </div>

      <div class="pill noWall" title="Theme">
        <span class="muted">Theme:</span>
        <select id="themeSelect" style="padding:6px 10px; border-radius:999px">
          <option value="white">White</option>
          <option value="brown">Brown</option>
        </select>
      </div>

      <div class="search noWall" title="Search cards by title, owner, tag, notes">
        <span class="muted">üîé</span>
        <input id="q" placeholder="Search‚Ä¶" />
      </div>

      <div class="pill noWall" id="clock">‚Äî</div>

      <button class="ghost noWall noReadonly" id="btnFocus">Focus: Off</button>
      <button class="ghost noWall noReadonly" id="btnArchiveDone">Archive Done</button>
      <button class="ghost noWall noReadonly" id="btnColumns">Columns</button>
      <button class="ghost noWall" id="btnShiftSummary">Shift Summary</button>
      <button class="ghost noWall" id="btnQR">QR Board</button>
      <button class="ghost noWall" id="btnReport">Export Report</button>
      <button class="ghost noWall" id="btnWallScreen" title="Open a wall-view in a new window">Open Wall Screen</button>
      <button class="primary noWall noReadonly" id="btnAdd">+ Add Card</button>

      <div class="toggle" title="Wall Mode toggle (ESC to exit)">
        <span class="muted">Wall</span>
        <div class="switch" id="wallSwitch" role="switch" aria-checked="false">
          <div class="knob"></div>
        </div>
      </div>

      <button class="ghost noWall noReadonly" id="btnLock">Lock</button>
      <button class="ghost noWall noReadonly" id="btnUnlock" style="display:none">Unlock</button>

      <button class="ghost noWall noReadonly" id="btnData">Import/Export</button>
      <button class="danger noWall noReadonly" id="btnReset">Reset</button>
    </div>
  </header>

  <div class="foot noWall">
    <div class="kpiBar" id="kpis"></div>
    <div class="rightInfo">
      <div class="hint">
        Smart rules: <span class="mono">Due today</span> ‚Üí yellow ‚Ä¢ <span class="mono">Overdue</span> ‚Üí red ‚Ä¢
        <span class="mono">No update</span> ‚Üí blue ‚Ä¢ Blocked too long ‚Üí yellow/red
      </div>
    </div>
  </div>

  <main class="board" id="board"></main>
</div>

<button class="wallExit" id="btnExitWall" title="Exit wall mode (ESC)">
  ‚§∫ Exit Wall <span class="muted">(ESC)</span>
</button>

<!-- QR Board -->
<dialog id="dlgQR">
  <div class="dlgHd">
    <div>
      <div class="t">QR Board Access</div>
      <div class="muted" style="font-size:12px">Scan to open this board (read-only wall link included)</div>
    </div>
    <button class="ghost" id="closeQR">Close</button>
  </div>
  <div class="dlgBd">
    <div class="row">
      <div class="field">
        <label>Normal link</label>
        <input id="qrLinkNormal" readonly />
      </div>
      <div class="field">
        <label>Wall (read-only) link</label>
        <input id="qrLinkWall" readonly />
      </div>
    </div>

    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start">
      <div style="flex:0 0 auto; padding:10px; border:1px solid var(--line); border-radius:16px; background: rgba(2,6,23,.06)">
        <canvas id="qrCanvas" width="220" height="220" style="display:block"></canvas>
      </div>

      <div style="flex:1; min-width:240px">
        <div class="muted" style="font-size:12px; line-height:1.45">
          ‚Ä¢ <b>Normal link</b>: opens board normally (editable if unlocked).<br/>
          ‚Ä¢ <b>Wall link</b>: forces Wall Mode + read-only (no edits).<br/><br/>
          Tip: Print this QR and stick it near the workshop TV.
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="ghost" id="btnCopyQRNormal">Copy Normal</button>
          <button class="ghost" id="btnCopyQRWall">Copy Wall</button>
        </div>
      </div>
    </div>
  </div>
  <div class="dlgActions">
    <button class="primary" id="btnPrintQR">Print</button>
  </div>
</dialog>

<!-- Export Report -->
<dialog id="dlgReport">
  <div class="dlgHd">
    <div>
      <div class="t">Export Report</div>
      <div class="muted" style="font-size:12px">Generate a printable client report + CSV export</div>
    </div>
    <button class="ghost" id="closeReport">Close</button>
  </div>
  <div class="dlgBd">
    <div class="row">
      <div class="field">
        <label>Report title</label>
        <input id="r_title" placeholder="e.g., Site A ‚Äî Daily Work Report" />
      </div>
      <div class="field">
        <label>Client / Location</label>
        <input id="r_client" placeholder="e.g., ABC Mining / Workshop 2" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>Include sections</label>
        <select id="r_sections">
          <option value="full" selected>Full (KPIs + all columns)</option>
          <option value="ops">Operations (Doing/Blocked/Done only)</option>
          <option value="handover">Handover (Done + Blocked only)</option>
        </select>
      </div>
      <div class="field">
        <label>Branding</label>
        <select id="r_brand">
          <option value="logiclab" selected>Logic Lab</option>
          <option value="none">None</option>
        </select>
      </div>
    </div>

    <div class="muted" style="font-size:12px; line-height:1.45">
      Exports:
      ‚Ä¢ <b>Print/PDF</b> opens a print-ready report page.<br/>
      ‚Ä¢ <b>CSV</b> downloads all cards (useful for Excel).<br/>
    </div>
  </div>
  <div class="dlgActions">
    <button class="ghost" id="btnExportCSV">Download CSV</button>
    <button class="primary" id="btnExportPDF">Print / PDF</button>
  </div>
</dialog>

<!-- Add/Edit Card -->
<dialog id="dlgCard">
  <div class="dlgHd">
    <div>
      <div class="t" id="dlgCardTitle">Add Card</div>
      <div class="muted" style="font-size:12px" id="dlgCardSub">Fast, clean, printable.</div>
    </div>
    <button class="ghost" id="closeCard">Close</button>
  </div>
  <div class="dlgBd">
    <div class="row">
      <div class="field">
        <label>Title <small class="muted">required</small></label>
        <input id="c_title" placeholder="e.g., Fix leaking pipe at Site A" />
      </div>
      <div class="field">
        <label>Owner</label>
        <input id="c_owner" placeholder="e.g., Thabo" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>Tag</label>
        <input id="c_tag" placeholder="e.g., Job / Maintenance / Delivery / Safety" />
      </div>
      <div class="field">
        <label>Priority</label>
       <select id="c_prio">
  <option value="normal" selected>Normal</option>
  <option value="urgent">Urgent</option>
  <option value="low">Low</option>
</select>

      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>Due date/time</label>
        <input id="c_due" type="datetime-local" />
      </div>
      <div class="field">
        <label>Status prompt</label>
        <select id="c_prompt">
          <option value="none" selected>None</option>
          <option value="done">When moved to Done ‚Üí ask ‚ÄúAny issues?‚Äù</option>
          <option value="blocked">When moved to Blocked ‚Üí ask reason</option>
          <option value="progress">When moved to In Progress ‚Üí auto-start timer</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label>Notes <small class="muted">short</small></label>
      <textarea id="c_notes" placeholder="Parts needed, customer name, instructions‚Ä¶"></textarea>
    </div>
  </div>
  <div class="dlgActions">
    <button class="danger" id="btnDeleteCard" style="display:none">Delete</button>
    <button class="ghost" id="btnCancelCard">Cancel</button>
    <button class="primary" id="btnSaveCard">Save</button>
  </div>
</dialog>

<!-- Columns manager -->
<dialog id="dlgCols">
  <div class="dlgHd">
    <div>
      <div class="t">Columns</div>
      <div class="muted" style="font-size:12px">Rename columns (simple, fast)</div>
    </div>
    <button class="ghost" id="closeCols">Close</button>
  </div>
  <div class="dlgBd">
    <div class="muted" style="font-size:12px; margin-bottom:10px">Tip: keep them short for wall screens.</div>
    <div id="colsForm" style="display:flex; flex-direction:column; gap:10px"></div>
  </div>
  <div class="dlgActions">
    <button class="ghost" id="btnCancelCols">Cancel</button>
    <button class="primary" id="btnSaveCols">Save</button>
  </div>
</dialog>

<!-- Import/Export -->
<dialog id="dlgData">
  <div class="dlgHd">
    <div>
      <div class="t">Import / Export</div>
      <div class="muted" style="font-size:12px">Backup your boards as JSON</div>
    </div>
    <button class="ghost" id="closeData">Close</button>
  </div>
  <div class="dlgBd">
    <div class="row">
      <div class="field">
        <label>Export</label>
        <button class="ghost" id="btnCopyJson">Copy JSON</button>
      </div>
      <div class="field">
        <label>Import</label>
        <button class="primary" id="btnImportJson">Import JSON</button>
      </div>
    </div>
    <div class="field">
      <label>Boards JSON</label>
      <textarea id="jsonBox" class="mono" placeholder='{"activeBoardId":"...","boards":[...],"prefs":{...}}'></textarea>
    </div>
    <div class="muted" style="font-size:12px">Import replaces everything.</div>
  </div>
  <div class="dlgActions">
    <button class="ghost" id="btnCloseData2">Done</button>
  </div>
</dialog>

<!-- Shift Summary -->
<dialog id="dlgSummary">
  <div class="dlgHd">
    <div>
      <div class="t">Shift Summary</div>
      <div class="muted" style="font-size:12px" id="sumSub">‚Äî</div>
    </div>
    <button class="ghost" id="closeSummary">Close</button>
  </div>
  <div class="dlgBd" id="sumBody"></div>
  <div class="dlgActions">
    <button class="ghost" id="btnCopySummary">Copy</button>
    <button class="primary" id="btnPrintSummary">Print / PDF</button>
  </div>
</dialog>

<!-- Lock / Unlock -->
<dialog id="dlgLock">
  <div class="dlgHd">
    <div>
      <div class="t" id="lockTitle">Lock Board</div>
      <div class="muted" style="font-size:12px">Prevents edits (perfect for wall TV)</div>
    </div>
    <button class="ghost" id="closeLock">Close</button>
  </div>
  <div class="dlgBd">
    <div class="field">
      <label>Password</label>
      <input id="lockPass" type="password" placeholder="Set / enter password" />
    </div>
    <div class="muted" style="font-size:12px; margin-top:8px" id="lockMsg">Tip: use something simple but not obvious.</div>
  </div>
  <div class="dlgActions">
    <button class="ghost" id="btnCancelLock">Cancel</button>
    <button class="primary" id="btnConfirmLock">Confirm</button>
  </div>
</dialog>

<script>
(() => {
  /* =========================================================
     MULTI-BOARD SMART WHITEBOARD (Offline)
     - Multiple boards
     - Lock/unlock (password)
     - Wall mode toggle + ALWAYS-VISIBLE EXIT
     - Themes: white / brown
     - Shift Summary (printable)
     - QR board access (normal + wall/read-only link)
     - Export report (Print/PDF + CSV)
     - Open Wall Screen (new window)
  ========================================================= */

  const STORAGE_KEY = "ll_whiteboard_multi_v3";

  const now = () => new Date();
  const iso = (d) => new Date(d).toISOString();
  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  const $ = (id) => document.getElementById(id);

  /* ---------------- Defaults ---------------- */
  const defaultBoard = (name="Workshop Board") => ({
    id: uid(),
    name,
    settings: {
      focus: false,
      wall: false,
      locked: false,
      passwordHash: "",      // naive hash (not crypto)
      staleHours: 6,
      blockedWarnHours: 4,
      blockedOverdueHours: 12
    },
    columns: [
      { id: "todo", title: "To Do", hint: "New tasks" },
      { id: "doing", title: "In Progress", hint: "Currently being worked" },
      { id: "blocked", title: "Blocked", hint: "Waiting / stuck" },
      { id: "done", title: "Done", hint: "Completed" }
    ],
    lanes: { todo: [], doing: [], blocked: [], done: [] },
    cards: {}
  });

  const defaultAppState = () => ({
    version: 3,
    prefs: { theme: "white" },
    activeBoardId: "",
    boards: [
      defaultBoard("Workshop Board"),
      defaultBoard("Dispatch Board"),
      defaultBoard("Site A Board")
    ]
  });

  /* ---------------- Persistence ---------------- */
  let app = load() || defaultAppState();
  if(!app.activeBoardId) app.activeBoardId = app.boards[0].id;
  applyTheme(app.prefs.theme);

  // query flags for special modes
  const QS = new URLSearchParams(location.search);
  const qsWall = QS.get("wall") === "1";
  const qsReadonly = QS.get("readonly") === "1";

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const s = JSON.parse(raw);
      if(!s || !Array.isArray(s.boards) || !s.prefs) return null;
      return s;
    }catch(e){ return null; }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(app));
  }

  function getBoard(){
    return app.boards.find(b => b.id === app.activeBoardId) || app.boards[0];
  }

  /* ---------------- Theme (white/brown only) ---------------- */
  function applyTheme(theme){
    const t = (theme === "brown") ? "brown" : "white";
    document.documentElement.setAttribute("data-theme", t);
    app.prefs.theme = t;
    save();
    const sel = $("themeSelect");
    if(sel && sel.value !== t) sel.value = t;
  }

  /* ---------------- Simple hash (not crypto) ---------------- */
  function tinyHash(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0).toString(16);
  }

  /* ---------------- Helpers ---------------- */
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

  function toLocalInputValue(d){
    if(!d) return "";
    const x = new Date(d);
    const pad = (n) => String(n).padStart(2,"0");
    return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}T${pad(x.getHours())}:${pad(x.getMinutes())}`;
  }
  function parseLocalDateTime(val){
    if(!val) return null;
    const d = new Date(val);
    return isNaN(d) ? null : d.toISOString();
  }
  function startOfToday(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return d;
  }
  function isDueToday(dueIso){
    if(!dueIso) return false;
    const d = new Date(dueIso);
    const t0 = startOfToday();
    const t1 = new Date(t0); t1.setDate(t1.getDate()+1);
    return d >= t0 && d < t1;
  }
  function isOverdue(dueIso){
    if(!dueIso) return false;
    return new Date(dueIso) < now();
  }
  function hoursSince(isoDate){
    if(!isoDate) return Infinity;
    const ms = now().getTime() - new Date(isoDate).getTime();
    return ms / (1000*60*60);
  }
  function laneTitle(board, colId){
    return board.columns.find(c=>c.id===colId)?.title ?? colId;
  }

  /* ---------------- Locking ---------------- */
  function isLocked(board){ return !!board.settings.locked; }
  function isReadonly(){ return document.documentElement.classList.contains("readonly"); }

  function requireUnlocked(board){
    if(isReadonly()){
      alert("Read-only mode. Editing is disabled.");
      return false;
    }
    if(!isLocked(board)) return true;
    alert("Board is locked. Tap Unlock and enter the password.");
    return false;
  }

  function setReadonly(on){
    document.documentElement.classList.toggle("readonly", !!on);
  }

  /* ---------------- Wall mode toggle ---------------- */
  function setWallSwitchUI(board){
    const sw = $("wallSwitch");
    if(!sw) return;
    const on = !!board.settings.wall;
    sw.classList.toggle("on", on);
    sw.setAttribute("aria-checked", on ? "true" : "false");
  }

  function setWallMode(board, on){
    board.settings.wall = !!on;
    document.documentElement.classList.toggle("wall", !!on);
    setWallSwitchUI(board);
    save();
    render();
  }

  /* ---------------- Timer ---------------- */
  function ensureTimer(card){
    if(!card.timer) card.timer = { running:false, startedAt:null, totalMs:0 };
  }
  function startTimer(card){
    ensureTimer(card);
    if(card.timer.running) return;
    card.timer.running = true;
    card.timer.startedAt = iso(now());
  }
  function stopTimer(card){
    ensureTimer(card);
    if(!card.timer.running) return;
    const start = new Date(card.timer.startedAt).getTime();
    const add = now().getTime() - start;
    card.timer.totalMs += Math.max(0, add);
    card.timer.running = false;
    card.timer.startedAt = null;
  }
  function formatTimer(cardTimer){
    const t = cardTimer || {running:false, startedAt:null, totalMs:0};
    let ms = t.totalMs || 0;
    if(t.running && t.startedAt) ms += now().getTime() - new Date(t.startedAt).getTime();
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }

  /* ---------------- Smart styling ---------------- */
  function smartClass(board, card, laneId){
    const cls = [];
    if(card.priority === "urgent") cls.push("prio-urgent");
    else if(card.priority === "low") cls.push("prio-low");
    else cls.push("prio-normal");

    if(card.dueAt){
      if(isOverdue(card.dueAt)) cls.push("status-overdue");
      else if(isDueToday(card.dueAt)) cls.push("status-due");
    }

    const staleH = board.settings.staleHours ?? 6;
    if(hoursSince(card.updatedAt) >= staleH && laneId !== "done") cls.push("status-stale");

    if(laneId === "blocked"){
      const h = hoursSince(card.movedToLaneAt?.blocked || card.updatedAt);
      if(h >= (board.settings.blockedOverdueHours ?? 12)) cls.push("status-overdue");
      else if(h >= (board.settings.blockedWarnHours ?? 4)) cls.push("status-due");
    }

    return cls.join(" ");
  }

  /* ---------------- Board selector ---------------- */
  function renderBoardSelector(){
    const sel = $("boardSelect");
    sel.innerHTML = "";
    app.boards.forEach(b=>{
      const op = document.createElement("option");
      op.value = b.id;
      op.textContent = b.name;
      sel.appendChild(op);
    });
    sel.value = app.activeBoardId;
  }

  function switchBoard(id){
    const b = app.boards.find(x=>x.id===id);
    if(!b) return;
    app.activeBoardId = id;
    save();
    document.documentElement.classList.toggle("wall", !!b.settings.wall);
    setWallSwitchUI(b);
    syncLockButtons(b);
    render();
  }

  /* ---------------- Render KPIs ---------------- */
  function renderKPIs(board){
    const k = $("kpis");
    if(!k) return;

    const counts = {};
    board.columns.forEach(c => counts[c.id] = (board.lanes[c.id] || []).length);

    let overdue=0, dueToday=0, stale=0, blockedOld=0;
    const staleH = board.settings.staleHours ?? 6;

    Object.values(board.cards).forEach(card=>{
      const lane = card.lane;
      if(lane === "done") return;
      if(card.dueAt){
        if(isOverdue(card.dueAt)) overdue++;
        else if(isDueToday(card.dueAt)) dueToday++;
      }
      if(hoursSince(card.updatedAt) >= staleH) stale++;
      if(lane === "blocked"){
        const h = hoursSince(card.movedToLaneAt?.blocked || card.updatedAt);
        if(h >= (board.settings.blockedWarnHours ?? 4)) blockedOld++;
      }
    });

    k.innerHTML = `
      <div class="kpi"><div class="k">Total</div><div class="v">${Object.keys(board.cards).length}</div></div>
      <div class="kpi"><div class="k">To Do</div><div class="v">${counts.todo ?? 0}</div></div>
      <div class="kpi"><div class="k">In Progress</div><div class="v">${counts.doing ?? 0}</div></div>
      <div class="kpi"><div class="k">Blocked</div><div class="v">${counts.blocked ?? 0}</div></div>
      <div class="kpi"><div class="k">Done</div><div class="v">${counts.done ?? 0}</div></div>
      <div class="kpi"><div class="k">Due Today</div><div class="v">${dueToday}</div></div>
      <div class="kpi"><div class="k">Overdue</div><div class="v">${overdue}</div></div>
      <div class="kpi"><div class="k">Stale</div><div class="v">${stale}</div></div>
      <div class="kpi"><div class="k">Blocked Aging</div><div class="v">${blockedOld}</div></div>
    `;
  }

  /* ---------------- Dragging ---------------- */
  let dragging = { cardId: null };

  /* ---------------- Render board ---------------- */
  function render(){
    const board = getBoard();

    // clock
    const clk = $("clock");
    if(clk){
      const d = new Date();
      clk.textContent = d.toLocaleString(undefined, {
        weekday:"short", year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"
      });
    }

    // focus button
    const focusBtn = $("btnFocus");
    if(focusBtn) focusBtn.textContent = `Focus: ${board.settings.focus ? "On" : "Off"}`;

    // brand
    $("brandTitle").textContent = `${board.name} ‚Äî Smart Whiteboard`;
    const lockedText = isLocked(board) ? "LOCKED" : "UNLOCKED";
    const roText = isReadonly() ? "READ-ONLY" : "EDITABLE";
    $("brandSub").textContent = `${roText} ‚Ä¢ ${lockedText} ‚Ä¢ Wall mode available`;

    renderKPIs(board);
    setWallSwitchUI(board);
    syncLockButtons(board);

    const q = ($("q")?.value || "").trim().toLowerCase();
    const focus = !!board.settings.focus;

    const root = $("board");
    root.innerHTML = "";

    board.columns.forEach(col=>{
      const lane = col.id;
      const ids = board.lanes[lane] || [];

      const visibleIds = ids.filter(cid=>{
        const c = board.cards[cid];
        if(!c) return false;

        if(focus){
          if(lane === "done") return false;
          if(c.priority === "low") return false;
        }

        if(q){
          const blob = `${c.title} ${c.owner||""} ${c.tag||""} ${c.notes||""}`.toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      const colEl = document.createElement("section");
      colEl.className = "col";
      colEl.dataset.lane = lane;

      colEl.innerHTML = `
        <div class="colHd">
          <div class="colTitle">
            <div class="name">
              <span>${escapeHtml(col.title || lane)}</span>
              <span class="countBadge" title="Visible cards">${visibleIds.length}</span>
            </div>
            <div class="meta">${escapeHtml(col.hint || "")}</div>
          </div>
          <div class="miniBtns noWall noReadonly">
            <div class="miniBtn" title="Add card here" data-act="addHere" data-lane="${lane}">Ôºã</div>
          </div>
        </div>
        <div class="colBody" data-dropzone="1">
          <div class="dropHint">Drop cards here</div>
          <div class="cards"></div>
        </div>
      `;

      const body = colEl.querySelector(".colBody");
      const cardsWrap = colEl.querySelector(".cards");

      // drop handlers (disabled if locked/readonly)
      body.addEventListener("dragover", (e)=>{
        if(isLocked(board) || isReadonly()) return;
        e.preventDefault();
        body.style.outline = "2px solid rgba(37,99,235,.20)";
        body.style.outlineOffset="4px";
      });
      body.addEventListener("dragleave", ()=>{ body.style.outline = ""; });
      body.addEventListener("drop", (e)=>{
        if(isLocked(board) || isReadonly()) return;
        e.preventDefault();
        body.style.outline = "";
        const cid = dragging.cardId;
        if(!cid) return;
        moveCard(board, cid, lane);
      });

      // cards
      visibleIds.forEach(cid=>{
        const c = board.cards[cid];
        if(!c) return;

        const cardEl = document.createElement("article");
        cardEl.className = `card ${smartClass(board, c, lane)}`;
        cardEl.draggable = (!isLocked(board) && !isReadonly());
        cardEl.dataset.id = cid;

        const dueTxt = c.dueAt
          ? new Date(c.dueAt).toLocaleString(undefined, { month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" })
          : "‚Äî";
        const updH = Math.floor(hoursSince(c.updatedAt) * 10) / 10;

        cardEl.innerHTML = `
          <div class="cardTop">
            <div style="min-width:0">
              <div class="cardTitle">${escapeHtml(c.title || "")}</div>
              <div class="cardMeta">
                ${c.owner ? `<span class="tag" title="Owner">üë§ ${escapeHtml(c.owner)}</span>` : ""}
                ${c.tag ? `<span class="tag" title="Tag">üè∑Ô∏è ${escapeHtml(c.tag)}</span>` : ""}
                ${c.dueAt ? `<span class="tag" title="Due">‚è∞ ${escapeHtml(dueTxt)}</span>` : ""}
                ${c.timer?.running ? `<span class="tag" title="Timer">‚è±Ô∏è ${escapeHtml(formatTimer(c.timer))}</span>` : ""}
              </div>
            </div>

            <div class="miniBtns noWall noReadonly">
              <div class="miniBtn" title="Edit" data-act="edit" data-id="${cid}">‚úé</div>
              <div class="miniBtn" title="Delete" data-act="del" data-id="${cid}">üóë</div>
            </div>
          </div>

          ${c.notes ? `<div class="muted" style="margin-top:8px; font-size:12px; line-height:1.35">${escapeHtml(c.notes)}</div>` : ""}

          <div class="muted" style="margin-top:10px; font-size:11px; display:flex; justify-content:space-between; gap:10px">
            <span class="mono">updated ${isFinite(updH) ? updH : "‚Äî"}h ago</span>
            ${c.timer?.running ? `<span class="mono">running</span>` : ""}
          </div>
        `;

        if(!isLocked(board) && !isReadonly()){
          cardEl.addEventListener("dragstart", ()=>{
            dragging.cardId = cid;
            cardEl.classList.add("dragging");
          });
          cardEl.addEventListener("dragend", ()=>{
            dragging.cardId = null;
            cardEl.classList.remove("dragging");
          });
        }

        cardsWrap.appendChild(cardEl);
      });

      if(visibleIds.length) colEl.querySelector(".dropHint").style.display = "none";

      // add here
      colEl.querySelectorAll('[data-act="addHere"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(!requireUnlocked(board)) return;
          openCardDialog({ lane });
        });
      });

      root.appendChild(colEl);
    });

    // edit/delete actions
    root.querySelectorAll("[data-act='edit']").forEach(b => b.addEventListener("click", ()=>{
      if(!requireUnlocked(getBoard())) return;
      openCardDialog({ id: b.dataset.id });
    }));
    root.querySelectorAll("[data-act='del']").forEach(b => b.addEventListener("click", ()=>{
      if(!requireUnlocked(getBoard())) return;
      deleteCard(getBoard(), b.dataset.id);
    }));
  }

  /* ---------------- Ensure board consistency ---------------- */
  function normalizeBoard(board){
    board.columns.forEach(c => { if(!board.lanes[c.id]) board.lanes[c.id] = []; });
    Object.values(board.cards).forEach(c=>{
      if(!c.lane) c.lane = "todo";
      if(!board.lanes[c.lane]) board.lanes[c.lane] = [];
      const inLane = Object.values(board.lanes).some(arr => arr.includes(c.id));
      if(!inLane) board.lanes[c.lane].unshift(c.id);
      if(!c.updatedAt) c.updatedAt = iso(now());
      if(!c.createdAt) c.createdAt = iso(now());
      if(!c.movedToLaneAt) c.movedToLaneAt = { [c.lane]: iso(now()) };
      if(!c.timer) c.timer = { running:false, startedAt:null, totalMs:0 };
    });
  }

  /* ---------------- Card CRUD ---------------- */
  let editingId = null;
  let defaultLaneForNew = "todo";

  function openCardDialog(opts = {}){
    const board = getBoard();
    editingId = opts.id || null;
    defaultLaneForNew = opts.lane || "todo";

    $("btnDeleteCard").style.display = editingId ? "inline-flex" : "none";

    if(editingId){
      const c = board.cards[editingId];
      $("dlgCardTitle").textContent = "Edit Card";
      $("dlgCardSub").textContent = `Currently in: ${laneTitle(board, c.lane)}`;
      $("c_title").value = c.title || "";
      $("c_owner").value = c.owner || "";
      $("c_tag").value = c.tag || "";
      $("c_prio").value = c.priority || "normal";
      $("c_due").value = toLocalInputValue(c.dueAt);
      $("c_notes").value = c.notes || "";
      $("c_prompt").value = c.prompt || "none";
    }else{
      $("dlgCardTitle").textContent = "Add Card";
      $("dlgCardSub").textContent = `Will add to: ${laneTitle(board, defaultLaneForNew)}`;
      $("c_title").value = "";
      $("c_owner").value = "";
      $("c_tag").value = "";
      $("c_prio").value = "normal";
      $("c_due").value = "";
      $("c_notes").value = "";
      $("c_prompt").value = "none";
    }

    $("dlgCard").showModal();
    setTimeout(()=> $("c_title").focus(), 50);
  }
  function closeCardDialog(){
    $("dlgCard").close();
    editingId = null;
  }

  function upsertCard(){
    const board = getBoard();
    if(!requireUnlocked(board)) return;

    const title = $("c_title").value.trim();
    if(!title){ alert("Title is required."); return; }

    const owner = $("c_owner").value.trim();
    const tag = $("c_tag").value.trim();
    const prio = $("c_prio").value;
    const dueAt = parseLocalDateTime($("c_due").value);
    const notes = $("c_notes").value.trim();
    const prompt = $("c_prompt").value;

    if(editingId){
      const c = board.cards[editingId];
      c.title = title;
      c.owner = owner;
      c.tag = tag;
      c.priority = prio;
      c.dueAt = dueAt;
      c.notes = notes;
      c.prompt = prompt;
      c.updatedAt = iso(now());
      save();
      render();
      closeCardDialog();
      return;
    }

    const id = uid();
    const lane = (defaultLaneForNew in board.lanes) ? defaultLaneForNew : "todo";
    const card = {
      id, title, owner, tag,
      priority: prio,
      dueAt, notes, prompt,
      lane,
      createdAt: iso(now()),
      updatedAt: iso(now()),
      movedToLaneAt: { [lane]: iso(now()) },
      timer: { running:false, startedAt:null, totalMs:0 }
    };
    board.cards[id] = card;
    board.lanes[lane].unshift(id);

    save();
    render();
    closeCardDialog();
  }

  function deleteCard(board, id){
    if(!id || !board.cards[id]) return;
    if(!confirm("Delete this card?")) return;

    const lane = board.cards[id].lane;
    board.lanes[lane] = (board.lanes[lane] || []).filter(x => x !== id);
    delete board.cards[id];

    save();
    render();
  }

  /* ---------------- Move logic + smart prompts ---------------- */
  function moveCard(board, id, toLane){
    if(!requireUnlocked(board)) return;
    const c = board.cards[id];
    if(!c) return;
    const fromLane = c.lane;
    if(fromLane === toLane) return;

    board.lanes[fromLane] = (board.lanes[fromLane] || []).filter(x => x !== id);
    board.lanes[toLane] = board.lanes[toLane] || [];
    board.lanes[toLane].unshift(id);

    ensureTimer(c);
    if(toLane === "doing"){
      if(c.prompt === "progress") startTimer(c);
    }else{
      if(fromLane === "doing") stopTimer(c);
    }

    if(toLane === "blocked" && c.prompt === "blocked"){
      const reason = prompt("Blocked reason? (e.g., waiting for parts / client / approval)");
      if(reason) c.notes = (c.notes ? (c.notes + "\n") : "") + "Blocked: " + reason;
    }
    if(toLane === "done" && c.prompt === "done"){
      const issues = confirm("Any issues found? OK = Yes, Cancel = No");
      if(issues){
        const note = prompt("Quick issue note (optional):");
        if(note) c.notes = (c.notes ? (c.notes + "\n") : "") + "Issues: " + note;
      }
      stopTimer(c);
    }

    c.lane = toLane;
    c.updatedAt = iso(now());
    c.movedToLaneAt = c.movedToLaneAt || {};
    c.movedToLaneAt[toLane] = iso(now());

    save();
    render();
  }

  /* ---------------- Columns ---------------- */
  function openColsDialog(){
    const board = getBoard();
    if(!requireUnlocked(board)) return;

    const wrap = $("colsForm");
    wrap.innerHTML = "";

    board.columns.forEach((col, idx)=>{
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="field">
          <label>Column ${idx+1} title</label>
          <input data-col-id="${col.id}" data-k="title" value="${escapeAttr(col.title || "")}" />
        </div>
        <div class="field">
          <label>Hint (small)</label>
          <input data-col-id="${col.id}" data-k="hint" value="${escapeAttr(col.hint || "")}" />
        </div>
      `;
      wrap.appendChild(row);
    });

    $("dlgCols").showModal();
  }
  function closeColsDialog(){ $("dlgCols").close(); }

  function saveColsDialog(){
    const board = getBoard();
    if(!requireUnlocked(board)) return;

    const inputs = $("colsForm").querySelectorAll("input[data-col-id]");
    inputs.forEach(inp=>{
      const id = inp.dataset.colId;
      const k = inp.dataset.k;
      const v = inp.value.trim();
      const col = board.columns.find(c=>c.id===id);
      if(col) col[k] = v;
    });

    save();
    render();
    closeColsDialog();
  }

  /* ---------------- Archive Done ---------------- */
  function archiveDone(){
    const board = getBoard();
    if(!requireUnlocked(board)) return;

    const doneIds = (board.lanes.done || []).slice();
    if(!doneIds.length){ alert("No Done cards to archive."); return; }

    const ok = confirm(`Archive ${doneIds.length} Done cards?\n\nThis removes them from the board.`);
    if(!ok) return;

    doneIds.forEach(id => { delete board.cards[id]; });
    board.lanes.done = [];

    save();
    render();
  }

  /* ---------------- Focus ---------------- */
  function toggleFocus(){
    const board = getBoard();
    if(!requireUnlocked(board)) return;
    board.settings.focus = !board.settings.focus;
    save();
    render();
  }

  /* ---------------- Shift Summary ---------------- */
  function openShiftSummary(){
    const board = getBoard();
    const dt = new Date().toLocaleString(undefined, {
      weekday:"short", year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"
    });
    $("sumSub").textContent = `${board.name} ‚Ä¢ ${dt}`;

    const done = (board.lanes.done || []).map(id => board.cards[id]).filter(Boolean);
    const blocked = (board.lanes.blocked || []).map(id => board.cards[id]).filter(Boolean);
    const doing = (board.lanes.doing || []).map(id => board.cards[id]).filter(Boolean);
    const todo = (board.lanes.todo || []).map(id => board.cards[id]).filter(Boolean);

    const list = (arr)=>{
      if(!arr.length) return `<div class="muted">None</div>`;
      return `<ol style="margin:8px 0 0; padding-left:18px; line-height:1.45">
        ${arr.map(c=>{
          const due = c.dueAt
            ? new Date(c.dueAt).toLocaleString(undefined, { month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" })
            : "";
          const bits = [
            c.owner ? `Owner: ${escapeHtml(c.owner)}` : "",
            c.tag ? `Tag: ${escapeHtml(c.tag)}` : "",
            due ? `Due: ${escapeHtml(due)}` : "",
            c.priority ? `Priority: ${escapeHtml(c.priority)}` : ""
          ].filter(Boolean).join(" ‚Ä¢ ");
          return `<li><b>${escapeHtml(c.title)}</b><div class="muted" style="font-size:12px">${bits}</div></li>`;
        }).join("")}
      </ol>`;
    };

    const overdue = Object.values(board.cards).filter(c => c.lane !== "done" && c.dueAt && isOverdue(c.dueAt));
    const stale = Object.values(board.cards).filter(c => c.lane !== "done" && hoursSince(c.updatedAt) >= (board.settings.staleHours ?? 6));

    $("sumBody").innerHTML = `
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
    <div class="pill"><span class="muted">Overdue</span> <b class="mono">${overdue.length}</b></div>
        <div class="pill"><span class="muted">Stale</span> <b class="mono">${stale.length}</b></div>
        <div class="pill"><span class="muted">Done</span> <b class="mono">${done.length}</b></div>
        <div class="pill"><span class="muted">In Progress</span> <b class="mono">${doing.length}</b></div>
        <div class="pill"><span class="muted">Blocked</span> <b class="mono">${blocked.length}</b></div>
      </div>

      <div class="col" style="box-shadow:none; background:transparent; border:none; padding:0">
        <div class="colHd" style="border-radius:18px; margin-bottom:10px">
          <div class="colTitle">
            <div class="name">‚úÖ Completed</div>
            <div class="meta">What was finished this shift</div>
          </div>
        </div>
        <div class="colBody" style="padding:0">${list(done)}</div>
      </div>

      <div class="col" style="box-shadow:none; background:transparent; border:none; padding:0; margin-top:14px">
        <div class="colHd" style="border-radius:18px; margin-bottom:10px">
          <div class="colTitle">
            <div class="name">‚õî Blocked</div>
            <div class="meta">Anything stuck / waiting</div>
          </div>
        </div>
        <div class="colBody" style="padding:0">${list(blocked)}</div>
      </div>

      <div class="col" style="box-shadow:none; background:transparent; border:none; padding:0; margin-top:14px">
        <div class="colHd" style="border-radius:18px; margin-bottom:10px">
          <div class="colTitle">
            <div class="name">üü¶ In Progress</div>
            <div class="meta">Still being worked</div>
          </div>
        </div>
        <div class="colBody" style="padding:0">${list(doing)}</div>
      </div>

      <div class="col" style="box-shadow:none; background:transparent; border:none; padding:0; margin-top:14px">
        <div class="colHd" style="border-radius:18px; margin-bottom:10px">
          <div class="colTitle">
            <div class="name">üìù To Do</div>
            <div class="meta">Next tasks / upcoming</div>
          </div>
        </div>
        <div class="colBody" style="padding:0">${list(todo)}</div>
      </div>
    `;

    $("dlgSummary").showModal();
  }

  function copyShiftSummary(){
    const board = getBoard();
    const done = (board.lanes.done || []).map(id => board.cards[id]).filter(Boolean);
    const blocked = (board.lanes.blocked || []).map(id => board.cards[id]).filter(Boolean);
    const doing = (board.lanes.doing || []).map(id => board.cards[id]).filter(Boolean);
    const todo = (board.lanes.todo || []).map(id => board.cards[id]).filter(Boolean);

    const fmt = (arr)=> arr.length ? arr.map((c,i)=>`${i+1}. ${c.title}${c.owner?` (Owner: ${c.owner})`:""}${c.tag?` [${c.tag}]`:""}${c.dueAt?` (Due: ${new Date(c.dueAt).toLocaleString()})`:""}`).join("\n") : "None";

    const text =
`Shift Summary ‚Äî ${board.name}
${new Date().toLocaleString()}

DONE:
${fmt(done)}

BLOCKED:
${fmt(blocked)}

IN PROGRESS:
${fmt(doing)}

TO DO:
${fmt(todo)}
`;

    navigator.clipboard?.writeText(text).then(()=>alert("Copied."), ()=>prompt("Copy this:", text));
  }

  function printShiftSummary(){
    const board = getBoard();
    const html = `
<!doctype html><html><head><meta charset="utf-8">
<title>Shift Summary ‚Äî ${escapeHtml(board.name)}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:24px; color:#111}
  h1{font-size:18px;margin:0 0 4px}
  .m{color:#555;font-size:12px;margin:0 0 18px}
  h2{font-size:14px;margin:18px 0 8px}
  li{margin:6px 0}
  .meta{color:#555;font-size:12px}
</style>
</head><body>
  <h1>Shift Summary ‚Äî ${escapeHtml(board.name)}</h1>
  <div class="m">${new Date().toLocaleString()}</div>
  ${$("sumBody").innerHTML}
<script>window.print();<\/script>
</body></html>`;
    const w = window.open("", "_blank", "noopener,noreferrer,width=980,height=720");
    w.document.open(); w.document.write(html); w.document.close();
  }

  /* ---------------- Report Export (Print/PDF + CSV) ---------------- */
  function openReportDialog(){
    $("dlgReport").showModal();
    $("r_title").value = $("r_title").value || `${getBoard().name} ‚Äî Report`;
    $("r_client").value = $("r_client").value || "";
  }

  function exportCSV(){
    const board = getBoard();
    const cols = ["lane","title","owner","tag","priority","dueAt","updatedAt","createdAt","notes","timerHours"];
    const esc = (v)=> `"${String(v??"").replaceAll('"','""')}"`;
    const rows = [cols.join(",")];

    Object.values(board.cards).forEach(c=>{
      ensureTimer(c);
      const hours = Math.round(((c.timer.totalMs||0)/3600000)*100)/100;
      rows.push([
        c.lane, c.title, c.owner, c.tag, c.priority, c.dueAt, c.updatedAt, c.createdAt, (c.notes||"").replaceAll("\n"," ‚Ä¢ "), hours
      ].map(esc).join(","));
    });

    const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${(board.name||"board").replaceAll(/\s+/g,"_")}_export.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  function exportReportPrint(){
    const board = getBoard();
    const title = ($("r_title").value || `${board.name} ‚Äî Report`).trim();
    const client = ($("r_client").value || "").trim();
    const sections = $("r_sections").value;
    const brand = $("r_brand").value;

    const lanePick = (lane)=> (board.lanes[lane]||[]).map(id=>board.cards[id]).filter(Boolean);
    const list = (arr)=> arr.length ? `<ol>${arr.map(c=>{
      const due = c.dueAt ? new Date(c.dueAt).toLocaleString() : "";
      const t = c.timer ? formatTimer(c.timer) : "";
      const meta = [
        c.owner ? `Owner: ${escapeHtml(c.owner)}` : "",
        c.tag ? `Tag: ${escapeHtml(c.tag)}` : "",
        c.priority ? `Priority: ${escapeHtml(c.priority)}` : "",
        due ? `Due: ${escapeHtml(due)}` : "",
        (c.timer?.running || (c.timer?.totalMs||0)>0) ? `Time: ${escapeHtml(t)}` : ""
      ].filter(Boolean).join(" ‚Ä¢ ");
      return `<li><b>${escapeHtml(c.title)}</b>${meta?`<div class="meta">${meta}</div>`:""}${c.notes?`<div class="notes">${escapeHtml(c.notes)}</div>`:""}</li>`;
    }).join("")}</ol>` : `<div class="muted">None</div>`;

    const kpi = (()=> {
      const counts = {};
      board.columns.forEach(c => counts[c.id] = (board.lanes[c.id]||[]).length);
      const total = Object.keys(board.cards).length;
      return `
        <div class="kpis">
          <div class="k"><span>Total</span><b>${total}</b></div>
          <div class="k"><span>To Do</span><b>${counts.todo||0}</b></div>
          <div class="k"><span>In Progress</span><b>${counts.doing||0}</b></div>
          <div class="k"><span>Blocked</span><b>${counts.blocked||0}</b></div>
          <div class="k"><span>Done</span><b>${counts.done||0}</b></div>
        </div>`;
    })();

    const blocks = [];
    const addSection = (name, lane)=> blocks.push(`<h2>${name}</h2>${list(lanePick(lane))}`);

    if(sections === "full"){
      blocks.push(`<h2>KPIs</h2>${kpi}`);
      board.columns.forEach(c => addSection(c.title || c.id, c.id));
    }else if(sections === "ops"){
      blocks.push(`<h2>KPIs</h2>${kpi}`);
      addSection("In Progress", "doing");
      addSection("Blocked", "blocked");
      addSection("Done", "done");
    }else{
      addSection("Done", "done");
      addSection("Blocked", "blocked");
    }

    const logo = brand === "logiclab"
      ? `<div class="logo">Logic Lab ‚Ä¢ Smart Whiteboard</div>`
      : ``;

    const html = `
<!doctype html><html><head><meta charset="utf-8">
<title>${escapeHtml(title)}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:24px; color:#111}
  .logo{font-weight:900; margin:0 0 8px; color:#111}
  h1{font-size:18px;margin:0 0 4px}
  .m{color:#555;font-size:12px;margin:0 0 18px}
  h2{font-size:14px;margin:18px 0 8px}
  ol{padding-left:18px; line-height:1.45}
  li{margin:8px 0}
  .meta{color:#555;font-size:12px;margin-top:3px}
  .notes{color:#333;font-size:12px;margin-top:6px; white-space:pre-wrap}
  .muted{color:#777;font-size:12px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .k{border:1px solid #ddd;border-radius:12px;padding:8px 10px;display:flex;gap:10px;align-items:center}
  .k span{color:#555;font-size:12px}
  @media print{ button{display:none} }
</style>
</head><body>
  ${logo}
  <h1>${escapeHtml(title)}</h1>
  <div class="m">${client ? `Client/Location: <b>${escapeHtml(client)}</b> ‚Ä¢ ` : ""}${new Date().toLocaleString()}</div>
  ${blocks.join("\n")}
<script>window.print();<\/script>
</body></html>`;

    const w = window.open("", "_blank", "noopener,noreferrer,width=980,height=720");
    w.document.open(); w.document.write(html); w.document.close();
  }

  /* ---------------- QR (Normal + Wall/Read-only) ---------------- */
  function currentBoardUrl(){
    // keep same file; just change query params
    const u = new URL(location.href);
    u.searchParams.delete("wall");
    u.searchParams.delete("readonly");
    return u.toString();
  }
  function currentWallUrl(){
    const u = new URL(location.href);
    u.searchParams.set("wall","1");
    u.searchParams.set("readonly","1");
    return u.toString();
  }

  function openQRDialog(){
    const normal = currentBoardUrl();
    const wall = currentWallUrl();
    $("qrLinkNormal").value = normal;
    $("qrLinkWall").value = wall;
    drawQR("qrCanvas", normal); // default show normal
    $("dlgQR").showModal();
  }

  function copyText(v){
    navigator.clipboard?.writeText(v).then(()=>alert("Copied."), ()=>prompt("Copy this:", v));
  }

  function printQR(){
    const normal = $("qrLinkNormal").value;
    const wall = $("qrLinkWall").value;
    const png = $("qrCanvas").toDataURL("image/png");
    const html = `
<!doctype html><html><head><meta charset="utf-8"><title>QR Board</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:24px; color:#111}
  .row{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start}
  .card{border:1px solid #ddd;border-radius:14px;padding:12px}
  img{width:260px;height:260px;display:block}
  .m{color:#555;font-size:12px}
  code{display:block;background:#f6f6f6;padding:8px;border-radius:10px;word-break:break-all}
</style></head><body>
<h1 style="margin:0 0 6px">Board QR</h1>
<div class="m">Normal + Wall (read-only) links included</div>
<div class="row" style="margin-top:14px">
  <div class="card">
    <div style="font-weight:800;margin-bottom:8px">Normal</div>
    <img src="${png}" alt="QR">
    <div class="m" style="margin-top:10px">Link:</div>
    <code>${escapeHtml(normal)}</code>
  </div>
  <div class="card">
    <div style="font-weight:800;margin-bottom:8px">Wall (read-only)</div>
    <div class="m">Use this on Display 2 / TV:</div>
    <code>${escapeHtml(wall)}</code>
  </div>
</div>
<script>window.print();<\/script>
</body></html>`;
    const w = window.open("", "_blank", "noopener,noreferrer,width=980,height=720");
    w.document.open(); w.document.write(html); w.document.close();
  }

  /* ---------------- Import/Export JSON ---------------- */
  function openDataDialog(){
    const payload = JSON.stringify(app, null, 2);
    $("jsonBox").value = payload;
    $("dlgData").showModal();
  }

  function copyJson(){
    copyText($("jsonBox").value || "");
  }

  function importJson(){
    if(!requireUnlocked(getBoard())) return;
    const raw = $("jsonBox").value.trim();
    if(!raw){ alert("Paste JSON first."); return; }
    if(!confirm("Import will replace EVERYTHING. Continue?")) return;
    try{
      const next = JSON.parse(raw);
      if(!next || !Array.isArray(next.boards) || !next.prefs){ throw new Error("Invalid format"); }
      app = next;
      if(!app.activeBoardId && app.boards[0]) app.activeBoardId = app.boards[0].id;
      app.prefs = app.prefs || { theme:"white" };
      applyTheme(app.prefs.theme);
      save();
      renderBoardSelector();
      switchBoard(app.activeBoardId);
      $("dlgData").close();
      alert("Imported.");
    }catch(e){
      alert("Import failed: " + e.message);
    }
  }

  /* ---------------- Board CRUD ---------------- */
  function newBoard(){
    if(!requireUnlocked(getBoard())) return;
    const name = prompt("New board name:", "New Board");
    if(!name) return;
    const b = defaultBoard(name.trim());
    app.boards.unshift(b);
    app.activeBoardId = b.id;
    save();
    renderBoardSelector();
    switchBoard(b.id);
  }

  function renameBoard(){
    if(!requireUnlocked(getBoard())) return;
    const b = getBoard();
    const name = prompt("Rename board:", b.name);
    if(!name) return;
    b.name = name.trim();
    save();
    renderBoardSelector();
    render();
  }

  function deleteBoard(){
    if(!requireUnlocked(getBoard())) return;
    if(app.boards.length <= 1){ alert("You must keep at least 1 board."); return; }
    const b = getBoard();
    const ok = confirm(`Delete board "${b.name}"?\n\nThis cannot be undone.`);
    if(!ok) return;
    app.boards = app.boards.filter(x=>x.id !== b.id);
    app.activeBoardId = app.boards[0].id;
    save();
    renderBoardSelector();
    switchBoard(app.activeBoardId);
  }

  /* ---------------- Reset ---------------- */
  function resetAll(){
    if(!confirm("Reset EVERYTHING back to defaults?")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  /* ---------------- Lock / Unlock ---------------- */
  function syncLockButtons(board){
    const locked = isLocked(board);
    $("btnLock").style.display = locked ? "none" : "inline-flex";
    $("btnUnlock").style.display = locked ? "inline-flex" : "none";

    // disable add/edit controls visually when locked/readonly
// keep readonly state driven by setReadonly(), not hard-forced here
// document.documentElement.classList.toggle("readonly", !!qsReadonly);
  }

  function openLockDialog(mode){
    const board = getBoard();
    const locking = (mode === "lock");
    $("lockTitle").textContent = locking ? "Lock Board" : "Unlock Board";
    $("lockMsg").textContent = locking
      ? "Set a password to prevent edits."
      : "Enter the password to enable edits.";
    $("lockPass").value = "";
    $("dlgLock").dataset.mode = mode;
    $("dlgLock").showModal();
    setTimeout(()=> $("lockPass").focus(), 50);
  }

  function confirmLockDialog(){
    const board = getBoard();
    const pass = ($("lockPass").value || "").trim();
    const mode = $("dlgLock").dataset.mode;

    if(mode === "lock"){
      if(!pass){ alert("Password required."); return; }
      board.settings.passwordHash = tinyHash(pass);
      board.settings.locked = true;
      save();
      render();
      $("dlgLock").close();
      alert("Locked.");
      return;
    }

    // unlock
    if(!board.settings.passwordHash){
      // if no password stored, allow unlock
      board.settings.locked = false;
      save(); render();
      $("dlgLock").close();
      return;
    }
    if(tinyHash(pass) !== board.settings.passwordHash){
      alert("Wrong password.");
      return;
    }
    board.settings.locked = false;
    save();
    render();
    $("dlgLock").close();
    alert("Unlocked.");
  }

  /* ---------------- Open Wall Screen ---------------- */
  function openWallScreen(){
    const u = new URL(location.href);
    u.searchParams.set("wall","1");
    u.searchParams.set("readonly","1");
    window.open(u.toString(), "_blank", "noopener,noreferrer,width=1400,height=900");
  }

  /* ---------------- Wall exit ---------------- */
  function exitWall(){
  const board = getBoard();
  const u = new URL(location.href);

  if(u.searchParams.get("wall")==="1" || u.searchParams.get("readonly")==="1"){
    u.searchParams.delete("wall");
    u.searchParams.delete("readonly");
    location.href = u.toString();
    return;
  }

  setWallMode(board, false);
  setReadonly(false);
}


  /* ---------------- Init: apply query modes ---------------- */
  (function initModes(){
    const board = getBoard();
    normalizeBoard(board);

    // If opened via URL flags:
    if(qsWall){
      document.documentElement.classList.add("wall");
      board.settings.wall = true; // local UI
    }
    setReadonly(!!qsReadonly);

    // If readonly, make sure locked buttons hidden from wall/readonly UI already
    applyTheme(app.prefs.theme || "white");
  })();

  /* ---------------- Events wiring ---------------- */
  function wire(){
    // theme
    $("themeSelect").addEventListener("change", (e)=> applyTheme(e.target.value));

    // board select
    renderBoardSelector();
    $("boardSelect").addEventListener("change", (e)=> switchBoard(e.target.value));
    $("btnNewBoard").addEventListener("click", newBoard);
    $("btnRenameBoard").addEventListener("click", renameBoard);
    $("btnDeleteBoard").addEventListener("click", deleteBoard);

    // search rerender
    $("q").addEventListener("input", ()=> render());

    // add card
    $("btnAdd").addEventListener("click", ()=> openCardDialog({ lane:"todo" }));

    // dialogs close
    $("closeCard").addEventListener("click", closeCardDialog);
    $("btnCancelCard").addEventListener("click", closeCardDialog);
    $("btnSaveCard").addEventListener("click", upsertCard);
    $("btnDeleteCard").addEventListener("click", ()=> {
      const board = getBoard();
      if(editingId) deleteCard(board, editingId);
      closeCardDialog();
    });

    // columns
    $("btnColumns").addEventListener("click", openColsDialog);
    $("closeCols").addEventListener("click", closeColsDialog);
    $("btnCancelCols").addEventListener("click", closeColsDialog);
    $("btnSaveCols").addEventListener("click", saveColsDialog);

    // focus
    $("btnFocus").addEventListener("click", toggleFocus);

    // archive
    $("btnArchiveDone").addEventListener("click", archiveDone);

    // shift summary
    $("btnShiftSummary").addEventListener("click", openShiftSummary);
    $("closeSummary").addEventListener("click", ()=> $("dlgSummary").close());
    $("btnCopySummary").addEventListener("click", copyShiftSummary);
    $("btnPrintSummary").addEventListener("click", printShiftSummary);

    // report
    $("btnReport").addEventListener("click", openReportDialog);
    $("closeReport").addEventListener("click", ()=> $("dlgReport").close());
    $("btnExportCSV").addEventListener("click", exportCSV);
    $("btnExportPDF").addEventListener("click", exportReportPrint);

    // QR
    $("btnQR").addEventListener("click", openQRDialog);
    $("closeQR").addEventListener("click", ()=> $("dlgQR").close());
    $("btnCopyQRNormal").addEventListener("click", ()=> {
      drawQR("qrCanvas", $("qrLinkNormal").value);
      copyText($("qrLinkNormal").value);
    });
    $("btnCopyQRWall").addEventListener("click", ()=> {
      drawQR("qrCanvas", $("qrLinkWall").value);
      copyText($("qrLinkWall").value);
    });
    $("btnPrintQR").addEventListener("click", printQR);

    // wall screen
    $("btnWallScreen").addEventListener("click", openWallScreen);

    // wall switch
    $("wallSwitch").addEventListener("click", ()=>{
      const board = getBoard();
      // if readonly, allow viewing wall but don't store if from qsReadonly? still ok
      setWallMode(board, !board.settings.wall);
    });

    // exit wall
    $("btnExitWall").addEventListener("click", exitWall);

    // lock / unlock
    $("btnLock").addEventListener("click", ()=> openLockDialog("lock"));
    $("btnUnlock").addEventListener("click", ()=> openLockDialog("unlock"));
    $("closeLock").addEventListener("click", ()=> $("dlgLock").close());
    $("btnCancelLock").addEventListener("click", ()=> $("dlgLock").close());
    $("btnConfirmLock").addEventListener("click", confirmLockDialog);

    // data
    $("btnData").addEventListener("click", openDataDialog);
    $("closeData").addEventListener("click", ()=> $("dlgData").close());
    $("btnCloseData2").addEventListener("click", ()=> $("dlgData").close());
    $("btnCopyJson").addEventListener("click", copyJson);
    $("btnImportJson").addEventListener("click", importJson);

    // reset
    $("btnReset").addEventListener("click", resetAll);

    // ESC to exit wall + close dialogs
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        // if any dialog open, browser handles first; if not, exit wall
        if(document.querySelector("dialog[open]")) return;
        if(document.documentElement.classList.contains("wall")) exitWall();
      }
    });

    // periodic refresh for timers / clock / stale statuses
    setInterval(()=> {
      // just rerender lightweight
      render();
    }, 30_000);
  }

  /* ---------------- QR generator (offline) ----------------
     Lightweight QR via "qrcode-generator" (Kazuhiko Arase) compacted.
  --------------------------------------------------------- */
  // Minimal qrcode-generator (MIT)
  // Source: https://github.com/kazuhikoarase/qrcode-generator (concept)
  // (trimmed/compact for this single-file offline tool)
  function QRCode(typeNumber, errorCorrectionLevel) {
    const PAD0 = 0xEC, PAD1 = 0x11;
    const _typeNumber = typeNumber;
    const _errorCorrectionLevel = errorCorrectionLevel;
    let _modules = null;
    let _moduleCount = 0;
    let _dataCache = null;
    const _dataList = [];

    const RS_BLOCK_TABLE = {
      L: [
        [], [1,26,19],[1,44,34],[1,70,55],[1,100,80],[1,134,108],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],
        [4,101,81],[2,116,92],[4,133,107],[3,145,115],[5,109,87],[5,122,98],[1,135,107],[5,150,120],[3,141,113],[3,135,107]
      ],
      M: [
        [], [1,26,16],[1,44,28],[1,70,44],[2,50,32],[2,67,43],[4,43,27],[4,49,31],[2,60,38],[3,58,36],[4,69,43],
        [1,80,50],[6,58,36],[8,59,37],[4,64,40],[5,65,41],[7,73,45],[10,74,46],[9,69,43],[3,70,44],[3,67,41]
      ],
      Q: [
        [], [1,26,13],[1,44,22],[2,35,17],[2,50,24],[2,33,15,2,34,16],[4,43,19],[2,32,14,4,33,15],[4,40,18,2,41,19],[4,36,16,4,37,17],[6,43,19,2,44,20],
        [4,50,22,4,51,23],[4,46,20,6,47,21],[8,44,20,4,45,21],[11,36,16,5,37,17],[5,54,24,7,55,25],[15,43,19,2,44,20],[1,50,22,15,51,23],[17,50,22,1,51,23],[17,47,21,4,48,22],[15,54,24,5,55,25]
      ],
      H: [
        [], [1,26,9],[1,44,16],[2,35,13],[4,25,9],[2,33,11,2,34,12],[4,43,15],[4,39,13,1,40,14],[4,40,14,2,41,15],[4,36,12,4,37,13],[6,43,15,2,44,16],
        [3,36,12,8,37,13],[7,42,14,4,43,15],[12,33,11,4,34,12],[11,36,12,5,37,13],[11,36,12,7,37,13],[3,45,15,13,46,16],[2,42,14,17,43,15],[2,42,14,19,43,15],[9,39,13,16,40,14],[15,43,15,10,44,16]
      ]
    };

    function getBCHTypeInfo(data){
      let d = data << 10;
      const g = 0x537;
      while (getBCHDigit(d) - getBCHDigit(g) >= 0) d ^= (g << (getBCHDigit(d) - getBCHDigit(g)));
      return ((data << 10) | d) ^ 0x5412;
    }
    function getBCHDigit(data){
      let digit = 0;
      while (data != 0) { digit++; data >>>= 1; }
      return digit;
    }
    function getPatternPosition(typeNumber){
      return [
        [], [], [6,18], [6,22], [6,26], [6,30], [6,34], [6,22,38], [6,24,42], [6,26,46], [6,28,50],
        [6,30,54], [6,32,58], [6,34,62], [6,26,46,66], [6,26,48,70], [6,26,50,74], [6,30,54,78], [6,30,56,82], [6,30,58,86], [6,34,62,90]
      ][typeNumber] || [];
    }
    function getMask(maskPattern, i, j){
      switch(maskPattern){
        case 0: return (i + j) % 2 == 0;
        case 1: return i % 2 == 0;
        case 2: return j % 3 == 0;
        case 3: return (i + j) % 3 == 0;
        case 4: return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 == 0;
        case 5: return ((i * j) % 2) + ((i * j) % 3) == 0;
        case 6: return (((i * j) % 2) + ((i * j) % 3)) % 2 == 0;
        case 7: return (((i + j) % 2) + ((i * j) % 3)) % 2 == 0;
        default: return false;
      }
    }

    function QRBitBuffer(){
      this.buffer = [];
      this.length = 0;
    }
    QRBitBuffer.prototype = {
      get: function(index){
        const bufIndex = Math.floor(index / 8);
        return ((this.buffer[bufIndex] >>> (7 - index % 8)) & 1) == 1;
      },
      put: function(num, length){
        for(let i=0;i<length;i++) this.putBit(((num >>> (length - i - 1)) & 1) == 1);
      },
      putBit: function(bit){
        const bufIndex = Math.floor(this.length / 8);
        if(this.buffer.length <= bufIndex) this.buffer.push(0);
        if(bit) this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));
        this.length++;
      }
    };

    function QR8bitByte(data){
      this.mode = 1; // 8bit
      this.data = data;
      this.parsed = [];
      for(let i=0;i<data.length;i++){
        const c = data.charCodeAt(i);
        if(c < 0x80) this.parsed.push(c);
        else if(c < 0x800){
          this.parsed.push(0xC0 | (c >> 6));
          this.parsed.push(0x80 | (c & 0x3F));
        }else{
          this.parsed.push(0xE0 | (c >> 12));
          this.parsed.push(0x80 | ((c >> 6) & 0x3F));
          this.parsed.push(0x80 | (c & 0x3F));
        }
      }
    }
    QR8bitByte.prototype = {
      getLength: function(){ return this.parsed.length; },
      write: function(buffer){
        for(let i=0;i<this.parsed.length;i++) buffer.put(this.parsed[i], 8);
      }
    };

    function getRSBlocks(typeNumber, errorCorrectionLevel){
      const tbl = RS_BLOCK_TABLE[errorCorrectionLevel][typeNumber];
      if(!tbl) throw new Error("RS block table not found");
      const list = [];
      for(let i=0;i<tbl.length;){
        const count = tbl[i++], totalCount = tbl[i++], dataCount = tbl[i++];
        for(let j=0;j<count;j++) list.push({totalCount, dataCount});
      }
      return list;
    }

    function createData(typeNumber, errorCorrectionLevel, dataList){
      const rsBlocks = getRSBlocks(typeNumber, errorCorrectionLevel);
      const buffer = new QRBitBuffer();
      for(let i=0;i<dataList.length;i++){
        const data = dataList[i];
        buffer.put(0b0100, 4); // mode 8bit
        buffer.put(data.getLength(), typeNumber < 10 ? 8 : 16);
        data.write(buffer);
      }
      // terminator
      const totalDataCount = rsBlocks.reduce((s,b)=>s+b.dataCount,0);
      if(buffer.length + 4 <= totalDataCount * 8) buffer.put(0, 4);
      while(buffer.length % 8 != 0) buffer.putBit(false);

      // padding
      while(buffer.buffer.length < totalDataCount){
        buffer.put(PAD0, 8);
        if(buffer.buffer.length >= totalDataCount) break;
        buffer.put(PAD1, 8);
      }
      return buffer.buffer;
    }

    function makeImpl(test, maskPattern){
      _moduleCount = _typeNumber * 4 + 17;
      _modules = new Array(_moduleCount);
      for(let r=0;r<_moduleCount;r++){
        _modules[r] = new Array(_moduleCount);
        for(let c=0;c<_moduleCount;c++) _modules[r][c] = null;
      }

      setupPositionProbePattern(0, 0);
      setupPositionProbePattern(_moduleCount - 7, 0);
      setupPositionProbePattern(0, _moduleCount - 7);
      setupPositionAdjustPattern();
      setupTimingPattern();
      setupTypeInfo(test, maskPattern);

      if(_dataCache == null) _dataCache = createData(_typeNumber, _errorCorrectionLevel, _dataList);
      mapData(_dataCache, maskPattern);
    }

    function setupPositionProbePattern(row, col){
      for(let r=-1;r<=7;r++){
        if(row+r <= -1 || _moduleCount <= row+r) continue;
        for(let c=-1;c<=7;c++){
          if(col+c <= -1 || _moduleCount <= col+c) continue;
          if((0 <= r && r <= 6 && (c == 0 || c == 6)) ||
             (0 <= c && c <= 6 && (r == 0 || r == 6)) ||
             (2 <= r && r <= 4 && 2 <= c && c <= 4)){
            _modules[row+r][col+c] = true;
          }else{
            _modules[row+r][col+c] = false;
          }
        }
      }
    }

    function setupTimingPattern(){
      for(let i=8;i<_moduleCount-8;i++){
        if(_modules[i][6] == null) _modules[i][6] = (i % 2 == 0);
        if(_modules[6][i] == null) _modules[6][i] = (i % 2 == 0);
      }
    }

    function setupPositionAdjustPattern(){
      const pos = getPatternPosition(_typeNumber);
      for(let i=0;i<pos.length;i++){
        for(let j=0;j<pos.length;j++){
          const row = pos[i], col = pos[j];
          if(_modules[row][col] != null) continue;
          for(let r=-2;r<=2;r++){
            for(let c=-2;c<=2;c++){
              if(r == -2 || r == 2 || c == -2 || c == 2 || (r==0 && c==0)){
                _modules[row+r][col+c] = true;
              }else{
                _modules[row+r][col+c] = false;
              }
            }
          }
        }
      }
    }

    function setupTypeInfo(test, maskPattern){
      const data = (_errorCorrectionLevel === "L" ? 1 :
                   _errorCorrectionLevel === "M" ? 0 :
                   _errorCorrectionLevel === "Q" ? 3 : 2);
      const bits = getBCHTypeInfo((data << 3) | maskPattern);

      for(let i=0;i<15;i++){
        const mod = (!test && ((bits >> i) & 1) == 1);
        // vertical
        if(i < 6) _modules[i][8] = mod;
        else if(i < 8) _modules[i + 1][8] = mod;
        else _modules[_moduleCount - 15 + i][8] = mod;

        // horizontal
        if(i < 8) _modules[8][_moduleCount - i - 1] = mod;
        else if(i < 9) _modules[8][15 - i - 1 + 1] = mod;
        else _modules[8][15 - i - 1] = mod;
      }
      _modules[_moduleCount - 8][8] = (!test);
    }

    function mapData(data, maskPattern){
      let inc = -1;
      let row = _moduleCount - 1;
      let bitIndex = 7;
      let byteIndex = 0;

      for(let col = _moduleCount - 1; col > 0; col -= 2){
        if(col == 6) col--;
        while(true){
          for(let c=0;c<2;c++){
            if(_modules[row][col - c] == null){
              let dark = false;
              if(byteIndex < data.length) dark = (((data[byteIndex] >>> bitIndex) & 1) == 1);
              const mask = getMask(maskPattern, row, col - c);
              _modules[row][col - c] = mask ? !dark : dark;
              bitIndex--;
              if(bitIndex == -1){ byteIndex++; bitIndex = 7; }
            }
          }
          row += inc;
          if(row < 0 || _moduleCount <= row){
            row -= inc;
            inc = -inc;
            break;
          }
        }
      }
    }

    function getBestMaskPattern(){
      // simple pick 0 (good enough for our use)
      return 0;
    }

    this.addData = function(data){ _dataList.push(new QR8bitByte(data)); _dataCache = null; };
    this.make = function(){
      // choose a safe typeNumber automatically (<= 10 is enough for URLs normally)
      // try type 4..10
       let t = _typeNumber || 0;
      if(!t){
        for(let n=4;n<=10;n++){
          try{
            _dataCache = null;
            createData(n, _errorCorrectionLevel, _dataList);
            t = n; break;
          }catch(e){}
        }
        if(!t) t = 10;
      }
      // override internal type
      // (quick hack for this minimal port)
      // eslint-disable-next-line no-unused-vars
      const __ = t;
    };

    this.getModuleCount = function(){ return _moduleCount; };
    this.isDark = function(r,c){ return _modules[r][c]; };

    this.make2 = function(){
      // auto typeNumber selection (simple)
      let chosen = _typeNumber || 0;
      if(!chosen){
        for(let n=4;n<=10;n++){
          try{
            _dataCache = null;
            createData(n, _errorCorrectionLevel, _dataList);
            chosen = n; break;
          }catch(e){}
        }
        if(!chosen) chosen = 10;
      }
      // rebuild with chosen
      // re-init internal by recreating object state we rely on
      // (we keep chosen via closure by overwriting _typeNumber use)
      // For this trimmed version: just set global-ish by reassigning through a hack:
      // NOTE: For our use (URLs), n=6~10 is typical.
      // We'll rebuild by calling makeImpl with chosen via a quick proxy:
      // Create a temp QRCode with chosen as constructor param.
      return chosen;
    };

    this._build = function(realType){
      // rebuild using realType as _typeNumber
      // we "simulate" by creating a new QRCode and copying modules
      const tmp = new QRCode(realType, _errorCorrectionLevel);
      tmp.addData(_dataList[0].data);
      tmp._finalize();
      _modules = tmp._modules;
      _moduleCount = tmp._moduleCount;
    };

    this._finalize = function(){
      const mask = getBestMaskPattern();
      makeImpl(false, mask);
      // expose internals for _build copy
      this._modules = _modules;
      this._moduleCount = _moduleCount;
    };
  }

  function drawQR(canvasId, text){
    const canvas = $(canvasId);
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const qr = new QRCode(0, "M");
    qr.addData(text);
    const t = qr.make2();
    qr._build(t);

    const count = qr.getModuleCount();
    const size = canvas.width;
    const margin = 10;
    const cell = Math.floor((size - margin*2) / count);
    const offset = Math.floor((size - cell*count) / 2);

    // background
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,size,size);

    ctx.fillStyle = "#000";
    for(let r=0;r<count;r++){
      for(let c=0;c<count;c++){
        if(qr.isDark(r,c)){
          ctx.fillRect(offset + c*cell, offset + r*cell, cell, cell);
        }
      }
    }
  }

  /* ---------------- Boot ---------------- */
  wire();
  render();

})();
</script>
</body>
</html>
