<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Digital Flyer Maker Pro</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:rgba(255,255,255,.12);
      --accent:#60a5fa;
      --accent2:#a78bfa;
      --danger:#fb7185;
      --ok:#22c55e;
      --warn:#fbbf24;
      --radius:16px;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(167,139,250,.14), transparent 55%),
        linear-gradient(180deg, #070a12, var(--bg));
      color:var(--text);
    }

    /* Print-to-PDF mode */
    @media print {
      body{ background:#fff !important; }
      .panel, .topbar, .status{ display:none !important; }
      .app{ display:block !important; padding:0 !important; }
      .canvasWrap{ border:none !important; box-shadow:none !important; }
      .stage{ padding:0 !important; overflow:visible !important; background:#fff !important; }
      .paper{
        transform:none !important;
        box-shadow:none !important;
        border:none !important;
        border-radius:0 !important;
      }
    }

    .app{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      padding:16px;
      height:100%;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:auto;
    }
    .panel-inner{padding:14px}
    .title{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding-bottom:10px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background: rgba(15,23,42,.75); backdrop-filter: blur(10px);
      z-index:5;
    }
    .title h1{font-size:14px; margin:0; letter-spacing:.4px; color:#fff}
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted); background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .tabs{display:flex; gap:10px; margin-top:12px;}
    .tab{
      flex:1; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      cursor:pointer;
      font-weight:800;
      text-align:center;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(96,165,250,.45);
      background: linear-gradient(180deg, rgba(96,165,250,.18), rgba(96,165,250,.08));
    }
    .group{
      margin-top:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(17,24,39,.55)
    }
    .group h2{margin:0 0 10px; font-size:12px; color:#cbd5e1; letter-spacing:.35px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    input[type="color"]{
      width:100%;
      height:40px;
      background: transparent;
      border:1px solid var(--line);
      border-radius:12px;
      padding:4px;
    }
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .inline{
      display:flex; align-items:center; gap:10px;
      padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .btns{display:flex; flex-wrap:wrap; gap:10px}
    button{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:800;
      letter-spacing:.2px;
    }
    button:hover{border-color: rgba(255,255,255,.22)}
    .primary{background: linear-gradient(180deg, rgba(96,165,250,.22), rgba(96,165,250,.12)); border-color: rgba(96,165,250,.35)}
    .danger{background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.35)}
    .ok{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.35)}
    .warn{background: rgba(251,191,36,.10); border-color: rgba(251,191,36,.35)}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .divider{height:1px; background:var(--line); margin:12px 0}

    .canvasWrap{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
      overflow:hidden;
      min-width: 520px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(15,23,42,.65);
      backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }
    .topbar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .kbd{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.03)
    }

    .stage{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      overflow:auto;
      background:
        linear-gradient(0deg, rgba(255,255,255,.03), rgba(255,255,255,.03)),
        repeating-conic-gradient(from 45deg, rgba(255,255,255,.03) 0 25%, transparent 0 50%) 0/28px 28px;
    }

    .paper{
      position:relative;
      width: 794px;
      height:1123px;
      background:#0b1220;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      overflow:hidden;
      transform-origin: top left;
    }
    .gridOverlay{
      pointer-events:none;
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity:.25;
      display:none;
    }
    .paper.show-grid .gridOverlay{display:block}

    .guides{pointer-events:none; position:absolute; inset:0; display:none;}
    .paper.show-guides .guides{display:block}
    .guide-bleed, .guide-safe{position:absolute; inset:0; border:2px dashed rgba(255,255,255,.22); border-radius:10px;}
    .guide-safe{ border-style: solid; border-color: rgba(96,165,250,.28); }

    .centerGuides{pointer-events:none; position:absolute; inset:0; display:none;}
    .paper.show-centers .centerGuides{display:block}
    .centerGuides::before,.centerGuides::after{content:""; position:absolute; background: rgba(167,139,250,.25);}
    .centerGuides::before{width:2px; top:0; bottom:0; left:50%; transform: translateX(-1px);}
    .centerGuides::after{height:2px; left:0; right:0; top:50%; transform: translateY(-1px);}

    .item{
      position:absolute;
      min-width: 40px; min-height: 28px;
      user-select:none;
      border:1px solid transparent;
      border-radius:10px;
      touch-action: none; /* ✅ important for mobile drag */
    }
    .item.selected{border-color: rgba(96,165,250,.7); box-shadow: 0 0 0 3px rgba(96,165,250,.18)}
    .item.hidden{display:none}
    .item .content{width:100%; height:100%; border-radius:10px; overflow:hidden;}
    .textBox{
      padding:10px 12px;
      white-space:pre-wrap;
      line-height:1.2;
      font-weight:700;
    }
    .shape{ width:100%; height:100%; }
    .handle{
      position:absolute;
      width:12px; height:12px;
      border-radius:4px;
      background: rgba(229,231,235,.9);
      border:1px solid rgba(0,0,0,.25);
      right:-6px; bottom:-6px;
      cursor: nwse-resize;
      display:none;
      touch-action: none; /* ✅ important for mobile resize */
    }
    .item.selected .handle{display:block}
    .img{width:100%; height:100%; object-fit:cover; display:block; border-radius:10px;}

    .status{
      padding:10px 12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background: rgba(15,23,42,.55);
    }
    .zoom{ width:140px; }

    /* Layers list */
    .layersList{display:flex; flex-direction:column; gap:8px; margin-top:8px;}
    .layerRow{
      display:grid; grid-template-columns: 1fr auto;
      gap:10px; align-items:center;
      padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .layerRow.active{
      border-color: rgba(96,165,250,.5);
      background: rgba(96,165,250,.10);
    }
    .layerTitle{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .layerTitle .name{font-weight:900; font-size:12px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .layerTitle .meta{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .layerBtns{display:flex; gap:6px;}
    .iconBtn{
      width:34px; height:34px;
      display:grid; place-items:center;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      cursor:pointer;
    }
    .iconBtn:hover{border-color: rgba(255,255,255,.22)}
    .iconBtn svg{width:16px; height:16px; opacity:.9}
    .iconBtn.warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10)}

    /* =========================
       Mobile / Tablet Responsive
       ========================= */
    @media (max-width: 980px){
      .app{
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        height: 100dvh;
        padding: 10px;
        gap: 10px;
      }
      aside.panel{
        max-height: 42dvh;
        overflow: auto;
      }
      .canvasWrap{
        min-width: 0; /* stop forced overflow */
      }
      .topbar{
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .stage{
        padding: 10px;
      }
    }

    @media (max-width: 640px){
      .app{ padding: 8px; gap: 8px; }
      aside.panel{ max-height: 48dvh; }

      .row{ grid-template-columns: 1fr; }
      .row3{ grid-template-columns: 1fr; }

      .tabs{ gap: 8px; }
      .tab{ padding: 9px 10px; font-size: 12px; }

      /* ✅ Only make grouped buttons full width */
      button{ padding: 10px 10px; width: auto; }
      .btns{ gap: 8px; }
      .btns button{ width: 100%; }

      .zoom{ width: 120px; }
      .stage{ overflow: auto; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT PANEL -->
    <aside class="panel">
      <div class="title panel-inner">
        <h1>Digital Flyer Maker Pro</h1>
        <div class="badge" id="badgeSize">A4 • 96DPI Edit</div>
      </div>

      <div class="panel-inner">
        <div class="tabs">
          <div class="tab active" id="tabDesign">Design</div>
          <div class="tab" id="tabLayers">Layers</div>
        </div>

        <!-- DESIGN TAB -->
        <div id="designTab">
          <div class="group">
            <h2>Canvas</h2>

            <label>Flyer Size</label>
            <select id="sizePreset"></select>

            <div class="row">
              <div>
                <label>Orientation</label>
                <select id="orientation">
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>
              <div>
                <label>Background Color</label>
                <input id="bgColor" type="color" value="#0b1220">
              </div>
            </div>

            <div class="row">
              <div class="inline">
                <input id="scaleLayout" type="checkbox" checked />
                <label for="scaleLayout" style="margin:0;color:var(--text)">Scale layout when resizing</label>
              </div>
              <div class="inline">
                <input id="snapToGrid" type="checkbox" checked />
                <label for="snapToGrid" style="margin:0;color:var(--text)">Snap to grid (10px)</label>
              </div>
            </div>

            <div class="row">
              <div class="inline">
                <input id="showGuides" type="checkbox" />
                <label for="showGuides" style="margin:0;color:var(--text)">Show print guides</label>
              </div>
              <div class="inline">
                <input id="showCenters" type="checkbox" />
                <label for="showCenters" style="margin:0;color:var(--text)">Show center lines</label>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Show Grid</label>
                <button id="toggleGrid" class="primary" type="button">Toggle</button>
              </div>
              <div>
                <label>Export DPI</label>
                <select id="exportDpi">
                  <option value="96">96 (Web)</option>
                  <option value="150">150 (Print)</option>
                  <option value="300" selected>300 (Pro Print)</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="btns">
              <button type="button" class="ok" id="exportPng">Export PNG</button>
              <button type="button" class="primary" id="exportPdf">Export PDF</button>
              <button type="button" id="downloadJson">Save JSON</button>
              <button type="button" id="uploadJsonBtn">Load JSON</button>
              <input id="uploadJson" type="file" accept="application/json" hidden>
            </div>

            <p class="hint" style="margin:10px 0 0">
              PDF export opens the print dialog. Choose “Save as PDF”.
            </p>
          </div>

          <div class="group">
            <h2>Add Elements</h2>
            <div class="btns">
              <button type="button" class="primary" id="addText">Add Text</button>
              <button type="button" id="addCta">Add Button</button>
              <button type="button" id="addRect">Add Rectangle</button>
              <button type="button" id="addCircle">Add Circle</button>
            </div>

            <label>Upload Image / Logo</label>
            <input id="imgUpload" type="file" accept="image/*" />
            <p class="hint" style="margin:8px 0 0">Uploads stay local in your browser.</p>
          </div>

          <div class="group">
            <h2>Selected Element</h2>

            <div id="noSelection" class="hint">Select something on the flyer to edit.</div>

            <div id="editPanel" style="display:none">
              <label>Name</label>
              <input id="elName" type="text" placeholder="Layer name (optional)"/>

              <label>Type</label>
              <input id="elType" type="text" disabled />

              <div class="row">
                <div>
                  <label>X</label>
                  <input id="posX" type="number" />
                </div>
                <div>
                  <label>Y</label>
                  <input id="posY" type="number" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Width</label>
                  <input id="sizeW" type="number" />
                </div>
                <div>
                  <label>Height</label>
                  <input id="sizeH" type="number" />
                </div>
              </div>

              <div id="textControls">
                <label>Text</label>
                <textarea id="textValue"></textarea>

                <div class="row3">
                  <div>
                    <label>Font</label>
                    <select id="fontFamily">
                      <option value="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" selected>System Sans</option>
                      <option value="Georgia, 'Times New Roman', Times, serif">Serif</option>
                      <option value="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace">Mono</option>
                    </select>
                  </div>
                  <div>
                    <label>Size</label>
                    <input id="fontSize" type="number" min="8" max="220" />
                  </div>
                  <div>
                    <label>Weight</label>
                    <select id="fontWeight">
                      <option value="400">400</option>
                      <option value="600">600</option>
                      <option value="700" selected>700</option>
                      <option value="800">800</option>
                      <option value="900">900</option>
                    </select>
                  </div>
                </div>

                <div class="row3">
                  <div>
                    <label>Text Color</label>
                    <input id="textColor" type="color" value="#ffffff">
                  </div>
                  <div>
                    <label>Align</label>
                    <select id="textAlign">
                      <option value="left">Left</option>
                      <option value="center">Center</option>
                      <option value="right">Right</option>
                    </select>
                  </div>
                  <div>
                    <label>Line Height</label>
                    <input id="lineHeight" type="number" min="0.8" max="2.4" step="0.05" value="1.2">
                  </div>
                </div>

                <div class="row3">
                  <div>
                    <label>Letter Spacing</label>
                    <input id="letterSpacing" type="number" min="-2" max="10" step="0.25" value="0">
                  </div>
                  <div>
                    <label>Padding</label>
                    <input id="textPad" type="number" min="0" max="60" step="1" value="12">
                  </div>
                  <div>
                    <label>BG Opacity</label>
                    <input id="textBgAlpha" type="number" min="0" max="1" step="0.05" value="0">
                  </div>
                </div>

                <label>Background (Text Box)</label>
                <input id="textBg" type="color" value="#000000">
              </div>

              <div id="shapeControls">
                <div class="row3">
                  <div>
                    <label>Fill</label>
                    <input id="shapeFill" type="color" value="#60a5fa">
                  </div>
                  <div>
                    <label>Opacity</label>
                    <input id="shapeAlpha" type="number" min="0" max="1" step="0.05" value="0.25">
                  </div>
                  <div>
                    <label>Border Width</label>
                    <input id="shapeBorderW" type="number" min="0" max="20" value="1">
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>Border</label>
                    <input id="shapeBorder" type="color" value="#60a5fa">
                  </div>
                  <div>
                    <label>Corner Radius (Rect)</label>
                    <input id="shapeRadius" type="number" min="0" max="120" value="12">
                  </div>
                </div>
              </div>

              <div id="imageControls">
                <div class="row">
                  <div>
                    <label>Image Fit</label>
                    <select id="imgFit">
                      <option value="cover">Cover</option>
                      <option value="contain">Contain</option>
                    </select>
                  </div>
                  <div>
                    <label>Corner Radius</label>
                    <input id="imgRadius" type="number" min="0" max="120" value="10">
                  </div>
                </div>
              </div>

              <div class="divider"></div>

              <label>Arrange</label>
              <div class="btns">
                <button type="button" id="bringFront">Bring Front</button>
                <button type="button" id="sendBack">Send Back</button>
                <button type="button" id="alignLeft">Align Left</button>
                <button type="button" id="alignCenter">Align Center</button>
                <button type="button" id="alignRight">Align Right</button>
              </div>

              <div class="divider"></div>

              <div class="btns">
                <button type="button" class="danger" id="deleteEl">Delete</button>
                <button type="button" id="duplicateEl">Duplicate</button>
              </div>
            </div>
          </div>
        </div>

        <!-- LAYERS TAB -->
        <div id="layersTab" style="display:none">
          <div class="group">
            <h2>Layers</h2>
            <div class="hint">Top = front.</div>
            <div class="layersList" id="layersList"></div>
            <div class="divider"></div>
            <div class="btns">
              <button type="button" class="warn" id="moveUp">Move Up</button>
              <button type="button" class="warn" id="moveDown">Move Down</button>
              <button type="button" class="danger" id="deleteLayer">Delete</button>
              <button type="button" class="danger" id="clearAll">Clear Canvas</button>
            </div>
          </div>
        </div>

      </div>
    </aside>

    <!-- RIGHT CANVAS -->
    <main class="canvasWrap">
      <div class="topbar">
        <div class="left">
          <span class="kbd" id="topSize">A4</span>
          <span class="kbd" id="topPx">794×1123 px</span>
        </div>
        <div class="right">
          <span class="kbd">Zoom</span>
          <input class="zoom" id="zoom" type="range" min="40" max="140" value="100">
          <span class="kbd" id="zoomLabel">100%</span>
        </div>
      </div>

      <div class="stage">
        <div class="paper" id="paper">
          <div class="gridOverlay"></div>
          <div class="centerGuides"></div>
          <div class="guides">
            <div class="guide-bleed" id="guideBleed"></div>
            <div class="guide-safe" id="guideSafe"></div>
          </div>
        </div>
      </div>

      <div class="status">
        <div id="statusLeft">No selection</div>
        <div id="statusRight">Ready</div>
      </div>
    </main>
  </div>

  <script>
    // ===== Utilities =====
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const rgba = (hex, a=1) => {
      const h = hex.replace("#","").trim();
      const full = h.length === 3 ? h.split("").map(x=>x+x).join("") : h;
      const r = parseInt(full.slice(0,2),16);
      const g = parseInt(full.slice(2,4),16);
      const b = parseInt(full.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    };
    const inchesToPx = (inches, dpi) => Math.round(inches * dpi);

    // ===== Size presets (inches) =====
    const SIZE_PRESETS = {
      a4:        { label: "A4 (8.27×11.69 in)", wIn: 8.27, hIn: 11.69 },
      letter:    { label: "Letter (8.5×11 in)", wIn: 8.5,  hIn: 11 },
      a5:        { label: "A5 (5.83×8.27 in)", wIn: 5.83, hIn: 8.27 },
      half:      { label: "Half-page (5.5×8.5 in)", wIn: 5.5,  hIn: 8.5 },
      quarter:   { label: "Quarter-page (4.25×5.5 in)", wIn: 4.25, hIn: 5.5 },
      postcard4x6:{ label: "Postcard (4×6 in)", wIn: 4,    hIn: 6 },
      postcard6x9:{ label: "Postcard (6×9 in)", wIn: 6,    hIn: 9 },
      rack35:    { label: "Rack card (3.5×8.5 in)", wIn: 3.5,  hIn: 8.5 },
      rack367:   { label: "Rack card (3.67×8.5 in)", wIn: 3.67, hIn: 8.5 },
    };

    // ===== DOM =====
    const paper = document.getElementById("paper");
    const bgColor = document.getElementById("bgColor");
    const toggleGrid = document.getElementById("toggleGrid");
    const statusLeft = document.getElementById("statusLeft");
    const statusRight = document.getElementById("statusRight");
    const zoom = document.getElementById("zoom");
    const zoomLabel = document.getElementById("zoomLabel");
    const badgeSize = document.getElementById("badgeSize");
    const topSize = document.getElementById("topSize");
    const topPx = document.getElementById("topPx");

    const sizePreset = document.getElementById("sizePreset");
    const orientation = document.getElementById("orientation");
    const scaleLayout = document.getElementById("scaleLayout");
    const exportDpi = document.getElementById("exportDpi");
    const showGuides = document.getElementById("showGuides");
    const showCenters = document.getElementById("showCenters");
    const snapToGrid = document.getElementById("snapToGrid");
    const guideBleed = document.getElementById("guideBleed");
    const guideSafe = document.getElementById("guideSafe");

    const layersList = document.getElementById("layersList");

    // Tabs
    const tabDesign = document.getElementById("tabDesign");
    const tabLayers = document.getElementById("tabLayers");
    const designTab = document.getElementById("designTab");
    const layersTab = document.getElementById("layersTab");

    // Selected edit
    const noSelection = document.getElementById("noSelection");
    const editPanel = document.getElementById("editPanel");
    const elName = document.getElementById("elName");
    const elType = document.getElementById("elType");
    const posX = document.getElementById("posX");
    const posY = document.getElementById("posY");
    const sizeW = document.getElementById("sizeW");
    const sizeH = document.getElementById("sizeH");

    const textControls = document.getElementById("textControls");
    const textValue = document.getElementById("textValue");
    const fontFamily = document.getElementById("fontFamily");
    const fontSize = document.getElementById("fontSize");
    const fontWeight = document.getElementById("fontWeight");
    const textColor = document.getElementById("textColor");
    const textAlign = document.getElementById("textAlign");
    const lineHeight = document.getElementById("lineHeight");
    const letterSpacing = document.getElementById("letterSpacing");
    const textPad = document.getElementById("textPad");
    const textBg = document.getElementById("textBg");
    const textBgAlpha = document.getElementById("textBgAlpha");

    const shapeControls = document.getElementById("shapeControls");
    const shapeFill = document.getElementById("shapeFill");
    const shapeAlpha = document.getElementById("shapeAlpha");
    const shapeBorder = document.getElementById("shapeBorder");
    const shapeBorderW = document.getElementById("shapeBorderW");
    const shapeRadius = document.getElementById("shapeRadius");

    const imageControls = document.getElementById("imageControls");
    const imgFit = document.getElementById("imgFit");
    const imgRadius = document.getElementById("imgRadius");

    // ===== State =====
    const EDIT_DPI = 96;
    const BLEED_IN = 0.125;
    const SAFE_IN  = 0.25;
    const SNAP = 10;

    let canvasPresetKey = "a4";
    let canvasLandscape = false;

    let elements = [];
    let selectedId = null;
    let drag = null;
    let resize = null;
    let zCounter = 1;

    // ===== Helpers =====
    function setStatus(left, right){ statusLeft.textContent = left; statusRight.textContent = right; }
    function getSelected(){ return elements.find(e=>e.id===selectedId) || null; }
    function snap(n){ return snapToGrid.checked ? Math.round(n / SNAP) * SNAP : n; }

    function currentCanvasInches(){
      const p = SIZE_PRESETS[canvasPresetKey] || SIZE_PRESETS.a4;
      let wIn = p.wIn, hIn = p.hIn;
      if(canvasLandscape) [wIn,hIn] = [hIn,wIn];
      return { wIn, hIn, base: p.label.split(" (")[0] };
    }
    function currentCanvasPx(){
      const { wIn, hIn } = currentCanvasInches();
      return { wPx: inchesToPx(wIn, EDIT_DPI), hPx: inchesToPx(hIn, EDIT_DPI) };
    }
    function updateSizeLabels(){
      const { wPx, hPx } = currentCanvasPx();
      const { base } = currentCanvasInches();
      badgeSize.textContent = `${base} • ${canvasLandscape ? "Landscape" : "Portrait"} • 96DPI Edit`;
      topSize.textContent = `${base} (${canvasLandscape ? "Land" : "Port"})`;
      topPx.textContent = `${wPx}×${hPx} px`;

      const bleedPx = inchesToPx(BLEED_IN, EDIT_DPI);
      const safePx  = inchesToPx(SAFE_IN,  EDIT_DPI);
      guideBleed.style.inset = `${bleedPx}px`;
      guideSafe.style.inset  = `${safePx}px`;
    }

    function applyCanvasSize({presetKey, landscape, scale}){
      const oldW = paper.clientWidth;
      const oldH = paper.clientHeight;

      canvasPresetKey = presetKey;
      canvasLandscape = landscape;

      const { wPx, hPx } = currentCanvasPx();
      paper.style.width  = wPx + "px";
      paper.style.height = hPx + "px";

      if(scale && oldW && oldH && elements.length){
        const sx = wPx / oldW;
        const sy = hPx / oldH;
        const sFont = Math.min(sx, sy);
        for(const el of elements){
          el.x *= sx; el.y *= sy; el.w *= sx; el.h *= sy;
          if(el.type === "text") el.fontSize *= sFont;
        }
      }

      for(const el of elements){
        el.x = clamp(el.x, 0, wPx - 10);
        el.y = clamp(el.y, 0, hPx - 10);
        el.w = clamp(el.w, 30, wPx - el.x);
        el.h = clamp(el.h, 24, hPx - el.y);
        if(el.type === "text") el.fontSize = clamp(el.fontSize, 8, 260);
      }

      updateSizeLabels();
      render();
      renderLayers();
      updateEditPanel();
      setStatus("Canvas resized", `${wPx}×${hPx}px`);
    }

    // ===== Auto-fit to screen (mobile friendly) =====
    function autoFitToScreen(force=false){
      if(!force && window.matchMedia("(min-width: 981px)").matches) return;

      const wrap = document.querySelector(".stage");
      if(!wrap) return;

      const maxW = wrap.clientWidth - 24;
      const maxH = wrap.clientHeight - 24;

      const w = paper.clientWidth || 1;
      const h = paper.clientHeight || 1;

      const scaleW = maxW / w;
      const scaleH = maxH / h;

      const z = clamp(Math.min(scaleW, scaleH, 1), 0.4, 1);
      const pct = Math.round(z * 100);

      paper.style.transform = `scale(${z})`;
      zoom.value = pct;
      zoomLabel.textContent = `${pct}%`;
    }

    // ===== PDF sizing injection =====
    function setPrintPageSizeCss(widthIn, heightIn){
      const css = `@page { size: ${widthIn}in ${heightIn}in; margin: 0; }`;
      let tag = document.getElementById("printPageSize");
      if(!tag){
        tag = document.createElement("style");
        tag.id = "printPageSize";
        document.head.appendChild(tag);
      }
      tag.textContent = css;
    }
    function exportPdf(){
      const { wIn, hIn } = currentCanvasInches();
      setPrintPageSizeCss(wIn, hIn);

      const gridWas = paper.classList.contains("show-grid");
      const guidesWas = paper.classList.contains("show-guides");
      const centersWas = paper.classList.contains("show-centers");
      paper.classList.remove("show-grid","show-guides","show-centers");

      setStatus("Export PDF", "Save as PDF");
      window.print();

      paper.classList.toggle("show-grid", gridWas);
      paper.classList.toggle("show-guides", guidesWas);
      paper.classList.toggle("show-centers", centersWas);
    }

    // ===== Elements =====
    function addText(opts={}){
      const id = uid();
      const el = {
        id,
        name: opts.name ?? "Text",
        hidden:false,
        type:"text",
        x: opts.x ?? 70,
        y: opts.y ?? 90,
        w: opts.w ?? 520,
        h: opts.h ?? 90,
        z: ++zCounter,
        text: opts.text ?? "",
        fontFamily: opts.fontFamily ?? "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",
        fontSize: opts.fontSize ?? 36,
        fontWeight: opts.fontWeight ?? 700,
        lineHeight: opts.lineHeight ?? 1.2,
        letterSpacing: opts.letterSpacing ?? 0,
        pad: opts.pad ?? 12,
        color: opts.color ?? "#ffffff",
        align: opts.align ?? "left",
        bg: opts.bg ?? "#000000",
        bgAlpha: opts.bgAlpha ?? 0
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
      setTimeout(()=>{ textValue?.focus(); }, 0);
    }

    function addShape(kind="rect", opts={}){
      const id = uid();
      const el = {
        id,
        name: opts.name ?? (kind === "circle" ? "Circle" : "Rectangle"),
        hidden:false,
        type:"shape",
        kind,
        x: opts.x ?? 60,
        y: opts.y ?? 60,
        w: opts.w ?? (kind === "circle" ? 180 : 680),
        h: opts.h ?? (kind === "circle" ? 180 : 140),
        z: ++zCounter,
        fill: opts.fill ?? "#60a5fa",
        alpha: opts.alpha ?? 0.18,
        border: opts.border ?? "#60a5fa",
        borderW: opts.borderW ?? 1,
        radius: opts.radius ?? 12,
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
    }

    function addButton(opts={}){
      const id = uid();
      const el = {
        id,
        name: opts.name ?? "Button",
        hidden:false,
        type:"text",
        x: opts.x ?? 70,
        y: opts.y ?? Math.max(70, paper.clientHeight - 220),
        w: opts.w ?? 520,
        h: opts.h ?? 86,
        z: ++zCounter,
        text: opts.text ?? "",
        fontFamily: opts.fontFamily ?? "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",
        fontSize: opts.fontSize ?? 28,
        fontWeight: opts.fontWeight ?? 900,
        lineHeight: opts.lineHeight ?? 1.05,
        letterSpacing: opts.letterSpacing ?? 0,
        pad: opts.pad ?? 14,
        color: opts.color ?? "#0b1220",
        align: opts.align ?? "center",
        bg: opts.bg ?? "#60a5fa",
        bgAlpha: opts.bgAlpha ?? 1
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
      setTimeout(()=>{ textValue?.focus(); }, 0);
    }

    function addImage(dataUrl, opts={}){
      const id = uid();
      const el = {
        id,
        name: opts.name ?? "Image",
        hidden:false,
        type:"image",
        x: opts.x ?? Math.max(40, paper.clientWidth - 280),
        y: opts.y ?? 220,
        w: opts.w ?? 240,
        h: opts.h ?? 240,
        z: ++zCounter,
        src: dataUrl,
        fit: opts.fit ?? "cover",
        radius: opts.radius ?? 12
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
    }

    function clearAll(){
      elements = [];
      selectedId = null;
      zCounter = 1;
      render();
      renderLayers();
      updateEditPanel();
      setStatus("Canvas cleared", "Ready");
    }

    // ===== Pointer Drag/Resize (mobile + desktop) =====
    function startDragPointer(e, id){
      const el = elements.find(x=>x.id===id);
      if(!el) return;
      drag = { id, startX: e.clientX, startY: e.clientY, elX: el.x, elY: el.y };
      window.addEventListener("pointermove", onDragMovePointer);
      window.addEventListener("pointerup", onDragEndPointer, { once:true });
    }
    function onDragMovePointer(e){
      if(!drag) return;
      const el = elements.find(x=>x.id===drag.id);
      if(!el) return;
      const dx = e.clientX - drag.startX;
      const dy = e.clientY - drag.startY;
      el.x = snap(clamp(drag.elX + dx, 0, paper.clientWidth - 10));
      el.y = snap(clamp(drag.elY + dy, 0, paper.clientHeight - 10));
      render();
      updateEditPanelQuiet();
      setStatus("Moving", `x:${Math.round(el.x)} y:${Math.round(el.y)}`);
    }
    function onDragEndPointer(){
      drag = null;
      window.removeEventListener("pointermove", onDragMovePointer);
      renderLayers();
      setStatus("Moved", "Ready");
    }

    function startResizePointer(e, id){
      const el = elements.find(x=>x.id===id);
      if(!el) return;
      resize = { id, startX: e.clientX, startY: e.clientY, w: el.w, h: el.h };
      window.addEventListener("pointermove", onResizeMovePointer);
      window.addEventListener("pointerup", onResizeEndPointer, { once:true });
    }
    function onResizeMovePointer(e){
      if(!resize) return;
      const el = elements.find(x=>x.id===resize.id);
      if(!el) return;
      const dx = e.clientX - resize.startX;
      const dy = e.clientY - resize.startY;
      el.w = snap(clamp(resize.w + dx, 30, paper.clientWidth - el.x));
      el.h = snap(clamp(resize.h + dy, 24, paper.clientHeight - el.y));
      render();
      updateEditPanelQuiet();
      setStatus("Resizing", `w:${Math.round(el.w)} h:${Math.round(el.h)}`);
    }
    function onResizeEndPointer(){
      resize = null;
      window.removeEventListener("pointermove", onResizeMovePointer);
      renderLayers();
      setStatus("Resized", "Ready");
    }

    // ===== Render =====
    function render(){
      paper.querySelectorAll(".item").forEach(n=>n.remove());
      paper.style.background = bgColor.value;

      const sorted = [...elements].sort((a,b)=>a.z-b.z);
      for(const el of sorted){
        const node = document.createElement("div");
        node.className = "item";
        node.dataset.id = el.id;
        node.style.left = el.x + "px";
        node.style.top = el.y + "px";
        node.style.width = el.w + "px";
        node.style.height = el.h + "px";
        node.style.zIndex = el.z;

        if(el.hidden) node.classList.add("hidden");
        if(el.id === selectedId) node.classList.add("selected");

        const content = document.createElement("div");
        content.className = "content";

        if(el.type === "text"){
          const t = document.createElement("div");
          t.className = "textBox";
          t.textContent = el.text || "";
          t.style.fontFamily = el.fontFamily;
          t.style.fontSize = el.fontSize + "px";
          t.style.fontWeight = el.fontWeight;
          t.style.lineHeight = String(el.lineHeight);
          t.style.letterSpacing = (el.letterSpacing ?? 0) + "px";
          t.style.padding = (el.pad ?? 12) + "px";
          t.style.color = el.color;
          t.style.textAlign = el.align;
          t.style.background = rgba(el.bg, el.bgAlpha);
          t.style.width = "100%";
          t.style.height = "100%";
          t.style.display = "flex";
          t.style.alignItems = "center";
          t.style.justifyContent = el.align === "left" ? "flex-start" : (el.align === "center" ? "center" : "flex-end");
          content.appendChild(t);
        }

        if(el.type === "shape"){
          const s = document.createElement("div");
          s.className = "shape";
          s.style.background = rgba(el.fill, el.alpha);
          s.style.border = `${el.borderW}px solid ${rgba(el.border, 1)}`;
          s.style.width = "100%";
          s.style.height = "100%";
          s.style.borderRadius = el.kind === "circle" ? "999px" : (el.radius ?? 12) + "px";
          content.appendChild(s);
        }

        if(el.type === "image"){
          const img = document.createElement("img");
          img.className = "img";
          img.src = el.src;
          img.style.objectFit = el.fit || "cover";
          img.style.borderRadius = (el.radius ?? 12) + "px";
          content.appendChild(img);
        }

        const handle = document.createElement("div");
        handle.className = "handle";
        handle.title = "Resize";
        node.appendChild(content);
        node.appendChild(handle);

        // ✅ Pointer events: works for mouse + touch
        node.addEventListener("pointerdown", (e) => {
          if(el.hidden) return;

          // keep receiving moves even if finger leaves the element
          node.setPointerCapture?.(e.pointerId);

          const isHandle = e.target.classList.contains("handle");
          if(isHandle){
            e.preventDefault();
            select(el.id);
            startResizePointer(e, el.id);
            return;
          }
          e.preventDefault();
          select(el.id);
          startDragPointer(e, el.id);
        });

        paper.appendChild(node);
      }

      // deselect when clicking blank area
      paper.onpointerdown = (e) => {
        const t = e.target;
        if(t === paper || t.classList.contains("gridOverlay") || t.classList.contains("guides") || t.classList.contains("guide-bleed") || t.classList.contains("guide-safe") || t.classList.contains("centerGuides")){
          selectedId = null;
          updateEditPanel();
          renderLayers();
          render();
          setStatus("No selection", "Ready");
        }
      };
    }

    function select(id){
      selectedId = id;
      updateEditPanel();
      renderLayers();
      render();
      const el = getSelected();
      if(el) setStatus("Selected", el.name || "");
    }

    // ===== Edit panel =====
    function updateEditPanel(){
      const el = getSelected();
      if(!el){
        noSelection.style.display = "block";
        editPanel.style.display = "none";
        return;
      }
      noSelection.style.display = "none";
      editPanel.style.display = "block";

      elName.value = el.name || "";
      elType.value = el.type + (el.type==="shape" ? ` (${el.kind})` : "");

      posX.value = Math.round(el.x);
      posY.value = Math.round(el.y);
      sizeW.value = Math.round(el.w);
      sizeH.value = Math.round(el.h);

      textControls.style.display  = (el.type === "text") ? "block" : "none";
      shapeControls.style.display = (el.type === "shape") ? "block" : "none";
      imageControls.style.display = (el.type === "image") ? "block" : "none";

      if(el.type === "text"){
        textValue.value = el.text ?? "";
        fontFamily.value = el.fontFamily || fontFamily.value;
        fontSize.value = Math.round(el.fontSize);
        fontWeight.value = String(el.fontWeight);
        lineHeight.value = el.lineHeight ?? 1.2;
        letterSpacing.value = el.letterSpacing ?? 0;
        textPad.value = el.pad ?? 12;
        textColor.value = el.color;
        textAlign.value = el.align;
        textBg.value = el.bg;
        textBgAlpha.value = el.bgAlpha;
      }
      if(el.type === "shape"){
        shapeFill.value = el.fill;
        shapeAlpha.value = el.alpha;
        shapeBorder.value = el.border;
        shapeBorderW.value = el.borderW;
        shapeRadius.value = el.radius ?? 12;
      }
      if(el.type === "image"){
        imgFit.value = el.fit || "cover";
        imgRadius.value = el.radius ?? 12;
      }
    }
    function updateEditPanelQuiet(){
      const el = getSelected();
      if(!el) return;
      posX.value = Math.round(el.x);
      posY.value = Math.round(el.y);
      sizeW.value = Math.round(el.w);
      sizeH.value = Math.round(el.h);
    }
    function bindInput(input, fn){
      input.addEventListener("input", () => {
        const el = getSelected();
        if(!el) return;
        fn(el);
        render();
        renderLayers();
        updateEditPanelQuiet();
      });
    }

    // name
    elName.addEventListener("input", ()=>{
      const el = getSelected(); if(!el) return;
      el.name = elName.value;
      renderLayers();
    });

    bindInput(posX, (el)=> el.x = snap(clamp(Number(posX.value)||0, 0, paper.clientWidth-10)));
    bindInput(posY, (el)=> el.y = snap(clamp(Number(posY.value)||0, 0, paper.clientHeight-10)));
    bindInput(sizeW, (el)=> el.w = snap(clamp(Number(sizeW.value)||50, 30, paper.clientWidth - el.x)));
    bindInput(sizeH, (el)=> el.h = snap(clamp(Number(sizeH.value)||30, 24, paper.clientHeight - el.y)));

    // text
    bindInput(textValue, (el)=> el.text = textValue.value);
    bindInput(fontFamily, (el)=> el.fontFamily = fontFamily.value);
    bindInput(fontSize, (el)=> el.fontSize = clamp(Number(fontSize.value)||16, 8, 260));
    bindInput(fontWeight, (el)=> el.fontWeight = Number(fontWeight.value)||700);
    bindInput(lineHeight, (el)=> el.lineHeight = clamp(Number(lineHeight.value)||1.2, 0.8, 2.4));
    bindInput(letterSpacing, (el)=> el.letterSpacing = clamp(Number(letterSpacing.value)||0, -2, 10));
    bindInput(textPad, (el)=> el.pad = clamp(Number(textPad.value)||12, 0, 60));
    bindInput(textColor, (el)=> el.color = textColor.value);
    bindInput(textAlign, (el)=> el.align = textAlign.value);
    bindInput(textBg, (el)=> el.bg = textBg.value);
    bindInput(textBgAlpha, (el)=> el.bgAlpha = clamp(Number(textBgAlpha.value)||0, 0, 1));

    // shape
    bindInput(shapeFill, (el)=> el.fill = shapeFill.value);
    bindInput(shapeAlpha, (el)=> el.alpha = clamp(Number(shapeAlpha.value)||0, 0, 1));
    bindInput(shapeBorder, (el)=> el.border = shapeBorder.value);
    bindInput(shapeBorderW, (el)=> el.borderW = clamp(Number(shapeBorderW.value)||0, 0, 30));
    bindInput(shapeRadius, (el)=> el.radius = clamp(Number(shapeRadius.value)||0, 0, 160));

    // image
    bindInput(imgFit, (el)=> el.fit = imgFit.value);
    bindInput(imgRadius, (el)=> el.radius = clamp(Number(imgRadius.value)||0, 0, 160));

    // ===== Layers =====
    const ICON_EYE = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>`;
    const ICON_EYE_OFF = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l18 18"/><path d="M10.6 10.6A3 3 0 0 0 12 15a3 3 0 0 0 2.4-4.4"/><path d="M9.9 4.2A10.7 10.7 0 0 1 12 4c6.5 0 10 8 10 8a18.2 18.2 0 0 1-3.4 4.7"/><path d="M6.1 6.1C3.4 8.2 2 12 2 12s3.5 8 10 8a10.5 10.5 0 0 0 4.2-.9"/></svg>`;
    const ICON_UP = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>`;
    const ICON_DOWN = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg>`;

    function normalizeZ(){
      elements = elements.sort((a,b)=>a.z-b.z).map((e,i)=>({ ...e, z:i+1 }));
      zCounter = elements.length + 1;
    }
    function moveLayer(id, dir){
      normalizeZ();
      const idx = elements.findIndex(e=>e.id===id);
      if(idx<0) return;
      const swapIdx = dir>0 ? Math.min(elements.length-1, idx+1) : Math.max(0, idx-1);
      if(swapIdx === idx) return;
      const tmp = elements[idx].z;
      elements[idx].z = elements[swapIdx].z;
      elements[swapIdx].z = tmp;
      render();
      renderLayers();
    }
    function renderLayers(){
      const sorted = [...elements].sort((a,b)=>b.z-a.z);
      layersList.innerHTML = "";
      for(const el of sorted){
        const row = document.createElement("div");
        row.className = "layerRow" + (el.id===selectedId ? " active" : "");
        row.onclick = ()=> select(el.id);

        const title = document.createElement("div");
        title.className = "layerTitle";
        const nm = document.createElement("div");
        nm.className = "name";
        nm.textContent = el.name || el.type;
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${el.type}${el.type==="shape" ? `/${el.kind}` : ""} • z:${el.z}` + (el.hidden ? " • hidden" : "");
        title.appendChild(nm);
        title.appendChild(meta);

        const btns = document.createElement("div");
        btns.className = "layerBtns";

        const eye = document.createElement("div");
        eye.className = "iconBtn";
        eye.innerHTML = el.hidden ? ICON_EYE_OFF : ICON_EYE;
        eye.title = el.hidden ? "Show" : "Hide";
        eye.onclick = (ev)=>{
          ev.stopPropagation();
          el.hidden = !el.hidden;
          if(el.hidden && el.id===selectedId){ selectedId=null; updateEditPanel(); }
          render(); renderLayers();
        };

        const up = document.createElement("div");
        up.className = "iconBtn warn";
        up.innerHTML = ICON_UP;
        up.title = "Move Up";
        up.onclick = (ev)=>{ ev.stopPropagation(); moveLayer(el.id, +1); };

        const down = document.createElement("div");
        down.className = "iconBtn warn";
        down.innerHTML = ICON_DOWN;
        down.title = "Move Down";
        down.onclick = (ev)=>{ ev.stopPropagation(); moveLayer(el.id, -1); };

        btns.appendChild(eye);
        btns.appendChild(up);
        btns.appendChild(down);

        row.appendChild(title);
        row.appendChild(btns);
        layersList.appendChild(row);
      }
    }

    // ===== Export PNG =====
    async function exportToPng(){
      const exportDpiVal = Number(exportDpi.value) || 300;
      const scale = exportDpiVal / EDIT_DPI;

      setStatus("Exporting...", `PNG @ ${exportDpiVal} DPI`);

      const clone = paper.cloneNode(true);
      clone.classList.remove("show-grid","show-guides","show-centers");
      clone.querySelectorAll(".gridOverlay,.guides,.centerGuides").forEach(n=>n.remove());
      clone.querySelectorAll(".item").forEach(n=>n.classList.remove("selected"));

      const w = paper.clientWidth;
      const h = paper.clientHeight;
      const outW = Math.round(w * scale);
      const outH = Math.round(h * scale);

      const serializer = new XMLSerializer();
      const html = serializer.serializeToString(clone);

      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${outW}" height="${outH}">
          <foreignObject width="100%" height="100%">
            <div xmlns="http://www.w3.org/1999/xhtml"
                 style="transform: scale(${scale}); transform-origin: top left; width:${w}px; height:${h}px;">
              ${html}
            </div>
          </foreignObject>
        </svg>
      `;

      const svgBlob = new Blob([svg], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = outW;
        canvas.height = outH;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);

        canvas.toBlob((blob)=>{
          if(!blob){
            setStatus("Export failed", "Try Chrome");
            alert("Export failed in this browser. Try Chrome.");
            return;
          }
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `flyer_${canvasPresetKey}_${canvasLandscape ? "land" : "port"}_${exportDpiVal}dpi.png`;
          a.click();
          setStatus("Exported", a.download);
        }, "image/png");
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        setStatus("Export failed", "Try Chrome");
        alert("Export failed in this browser. Try Chrome.");
      };
      img.src = url;
    }

    // ===== Save/Load =====
    function toJSON(){
      return JSON.stringify({
        version: 4,
        editDpi: EDIT_DPI,
        presetKey: canvasPresetKey,
        landscape: canvasLandscape,
        background: bgColor.value,
        showGuides: !!showGuides.checked,
        showCenters: !!showCenters.checked,
        snapToGrid: !!snapToGrid.checked,
        elements
      }, null, 2);
    }
    function download(filename, text){
      const blob = new Blob([text], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    // ===== UI wiring =====
    function initSizeDropdown(){
      const order = ["a4","letter","a5","half","quarter","postcard4x6","postcard6x9","rack35","rack367"];
      for(const key of order){
        const p = SIZE_PRESETS[key];
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = p.label;
        sizePreset.appendChild(opt);
      }
      sizePreset.value = canvasPresetKey;
    }
    function onCanvasSettingsChange(){
      const presetKey = sizePreset.value;
      const landscape = (orientation.value === "landscape");
      const scale = !!scaleLayout.checked;
      applyCanvasSize({ presetKey, landscape, scale });
      autoFitToScreen();
    }

    // Tabs
    function setTab(which){
      const design = (which === "design");
      tabDesign.classList.toggle("active", design);
      tabLayers.classList.toggle("active", !design);
      designTab.style.display = design ? "block" : "none";
      layersTab.style.display = design ? "none" : "block";
    }
    tabDesign.onclick = ()=>setTab("design");
    tabLayers.onclick = ()=>setTab("layers");

    // Buttons
    document.getElementById("addText").onclick = () => addText({ name:"Text", x:70, y:90, w:520, h:90 });
    document.getElementById("addCta").onclick = () => addButton({ name:"Button" });
    document.getElementById("addRect").onclick = () => addShape("rect",{});
    document.getElementById("addCircle").onclick = () => addShape("circle",{ w:220, h:220, x:Math.max(40, paper.clientWidth - 280), y:220 });

    document.getElementById("exportPng").onclick = exportToPng;
    document.getElementById("exportPdf").onclick = exportPdf;

    document.getElementById("downloadJson").onclick = ()=>{ download("flyer.json", toJSON()); setStatus("Saved", "flyer.json downloaded"); };
    document.getElementById("uploadJsonBtn").onclick = ()=> document.getElementById("uploadJson").click();

    document.getElementById("uploadJson").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data || !Array.isArray(data.elements)) throw new Error("Invalid");
          canvasPresetKey = (data.presetKey && SIZE_PRESETS[data.presetKey]) ? data.presetKey : "a4";
          canvasLandscape = !!data.landscape;
          sizePreset.value = canvasPresetKey;
          orientation.value = canvasLandscape ? "landscape" : "portrait";

          bgColor.value = data.background || "#0b1220";
          paper.style.background = bgColor.value;

          showGuides.checked = !!data.showGuides;
          showCenters.checked = !!data.showCenters;
          snapToGrid.checked = data.snapToGrid !== false;

          paper.classList.toggle("show-guides", showGuides.checked);
          paper.classList.toggle("show-centers", showCenters.checked);

          elements = data.elements;
          zCounter = elements.reduce((m,x)=>Math.max(m, x.z||1), 1);

          applyCanvasSize({ presetKey: canvasPresetKey, landscape: canvasLandscape, scale:false });

          selectedId=null;
          render(); renderLayers(); updateEditPanel();
          setStatus("Loaded", "JSON applied");

          autoFitToScreen();
        }catch(err){
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(f);
      e.target.value = "";
    });

    document.getElementById("imgUpload").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> addImage(reader.result, {});
      reader.readAsDataURL(f);
      e.target.value = "";
    });

    // Grid / Guides / Centers
    toggleGrid.onclick = ()=> paper.classList.toggle("show-grid");
    showGuides.addEventListener("change", ()=> paper.classList.toggle("show-guides", showGuides.checked));
    showCenters.addEventListener("change", ()=> paper.classList.toggle("show-centers", showCenters.checked));

    // Size + orientation
    sizePreset.addEventListener("change", onCanvasSettingsChange);
    orientation.addEventListener("change", onCanvasSettingsChange);

    // Zoom (manual overrides)
    zoom.addEventListener("input", ()=>{
      const z = Number(zoom.value) / 100;
      paper.style.transform = `scale(${z})`;
      zoomLabel.textContent = `${zoom.value}%`;
    });

    // Background
    bgColor.addEventListener("input", ()=> paper.style.background = bgColor.value);

    // Arrange/Align
    document.getElementById("bringFront").onclick = ()=>{
      const el = getSelected(); if(!el) return;
      el.z = ++zCounter;
      render(); renderLayers();
    };
    document.getElementById("sendBack").onclick = ()=>{
      const el = getSelected(); if(!el) return;
      el.z = 1;
      normalizeZ();
      render(); renderLayers();
    };
    document.getElementById("alignLeft").onclick = ()=>{
      const el = getSelected(); if(!el) return;
      el.x = snap(20);
      render(); updateEditPanelQuiet(); renderLayers();
    };
    document.getElementById("alignCenter").onclick = ()=>{
      const el = getSelected(); if(!el) return;
      el.x = snap(Math.round((paper.clientWidth - el.w)/2));
      render(); updateEditPanelQuiet(); renderLayers();
    };
    document.getElementById("alignRight").onclick = ()=>{
      const el = getSelected(); if(!el) return;
      el.x = snap(Math.round(paper.clientWidth - el.w - 20));
      render(); updateEditPanelQuiet(); renderLayers();
    };

    function removeSelected(){
      if(!selectedId) return;
      elements = elements.filter(e=>e.id !== selectedId);
      selectedId = null;
      render(); renderLayers(); updateEditPanel();
      setStatus("Deleted", "Ready");
    }
    function duplicateSelected(){
      const el = getSelected(); if(!el) return;
      const copy = JSON.parse(JSON.stringify(el));
      copy.id = uid();
      copy.x = clamp(copy.x + 20, 0, paper.clientWidth - 10);
      copy.y = clamp(copy.y + 20, 0, paper.clientHeight - 10);
      copy.z = ++zCounter;
      elements.push(copy);
      render();
      select(copy.id);
      renderLayers();
      setStatus("Duplicated", "Ready");
    }
    document.getElementById("deleteEl").onclick = removeSelected;
    document.getElementById("duplicateEl").onclick = duplicateSelected;

    // Layer actions
    document.getElementById("moveUp").onclick = ()=> selectedId && moveLayer(selectedId, +1);
    document.getElementById("moveDown").onclick = ()=> selectedId && moveLayer(selectedId, -1);
    document.getElementById("deleteLayer").onclick = removeSelected;
    document.getElementById("clearAll").onclick = clearAll;

    // Shortcuts (Backspace does NOT delete)
    window.addEventListener("keydown", (e) => {
      const t = e.target;
      const typing =
        t &&
        (t.tagName === "INPUT" ||
         t.tagName === "TEXTAREA" ||
         t.tagName === "SELECT" ||
         t.isContentEditable);

      if (typing) return;

      const el = getSelected();
      const isMac = navigator.platform.toLowerCase().includes("mac");
      const mod = isMac ? e.metaKey : e.ctrlKey;

      // Duplicate: Ctrl/Cmd + D
      if (mod && e.key.toLowerCase() === "d") {
        e.preventDefault();
        duplicateSelected();
        return;
      }

      // Delete element ONLY with Delete key
      if (e.key === "Delete") {
        if (selectedId) {
          e.preventDefault();
          removeSelected();
        }
        return;
      }

      if (!el) return;

      // Move with arrows (Shift = bigger)
      const step = e.shiftKey ? 10 : 2;
      if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(e.key)) {
        e.preventDefault();
        if (e.key === "ArrowLeft")  el.x = snap(clamp(el.x - step, 0, paper.clientWidth - 10));
        if (e.key === "ArrowRight") el.x = snap(clamp(el.x + step, 0, paper.clientWidth - 10));
        if (e.key === "ArrowUp")    el.y = snap(clamp(el.y - step, 0, paper.clientHeight - 10));
        if (e.key === "ArrowDown")  el.y = snap(clamp(el.y + step, 0, paper.clientHeight - 10));
        render();
        updateEditPanelQuiet();
        renderLayers();
      }
    });

    // ===== Init =====
    initSizeDropdown();

    // default canvas A4 portrait
    sizePreset.value = "a4";
    orientation.value = "portrait";
    canvasPresetKey = "a4";
    canvasLandscape = false;

    paper.style.transform = "scale(1)";
    zoom.value = 100;
    zoomLabel.textContent = "100%";

    paper.classList.toggle("show-guides", false);
    paper.classList.toggle("show-centers", false);

    applyCanvasSize({ presetKey:"a4", landscape:false, scale:false });

    // IMPORTANT: start BLANK
    clearAll();

    // Auto-fit on load for small screens, and keep fitting on resize/orientation change
    autoFitToScreen();
    window.addEventListener("resize", ()=> autoFitToScreen());
    window.addEventListener("orientationchange", ()=> setTimeout(()=>autoFitToScreen(true), 150));
  </script>
</body>
</html>
