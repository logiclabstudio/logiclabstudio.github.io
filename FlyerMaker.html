<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Digital Flyer Maker Pro</title>
  <script src="./qrcode.min.js"></script>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:rgba(255,255,255,.12);
      --accent:#60a5fa;
      --accent2:#a78bfa;
      --danger:#fb7185;
      --ok:#22c55e;
      --warn:#fbbf24;
      --radius:16px;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(167,139,250,.14), transparent 55%),
        linear-gradient(180deg, #070a12, var(--bg));
      color:var(--text);
    }

    /* Print-to-PDF mode */
    @media print {
      body{ background:#fff !important; }
      .panel, .topbar, .status{ display:none !important; }
      .app{ display:block !important; padding:0 !important; }
      .canvasWrap{ border:none !important; box-shadow:none !important; }
      .stage{ padding:0 !important; overflow:visible !important; background:#fff !important; }
      .paper{
        transform:none !important;
        box-shadow:none !important;
        border:none !important;
        border-radius:0 !important;
      }
    }

    .app{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      padding:16px;
      height:100%;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:auto;
    }
    .panel-inner{padding:14px}
    .title{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding-bottom:10px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background: rgba(15,23,42,.75); backdrop-filter: blur(10px);
      z-index:5;
    }
    .title h1{font-size:14px; margin:0; letter-spacing:.4px; color:#fff}
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted); background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .tabs{display:flex; gap:10px; margin-top:12px;}
    .tab{
      flex:1; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      cursor:pointer;
      font-weight:800;
      text-align:center;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(96,165,250,.45);
      background: linear-gradient(180deg, rgba(96,165,250,.18), rgba(96,165,250,.08));
    }
    .group{
      margin-top:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(17,24,39,.55)
    }
    .group h2{margin:0 0 10px; font-size:12px; color:#cbd5e1; letter-spacing:.35px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    select{
      background-color:#0f172a;
      color:#f8fafc;
      font-weight:700;
    }
    select:focus{
      border-color: rgba(96,165,250,.6);
      box-shadow: 0 0 0 3px rgba(96,165,250,.2);
    }
    select option{
      background:#0b1220;
      color:#e5e7eb;
      font-weight:600;
    }
    select option:checked{
      background:#1d4ed8;
      color:#ffffff;
    }
    select optgroup{
      background:#0b1220;
      color:#93c5fd;
      font-weight:800;
    }
    textarea{min-height:84px; resize:vertical}
    input[type="color"]{
      width:100%;
      height:40px;
      background: transparent;
      border:1px solid var(--line);
      border-radius:12px;
      padding:4px;
    }
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .inline{
      display:flex; align-items:center; gap:10px;
      padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .btns{display:flex; flex-wrap:wrap; gap:10px}
    button{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:800;
      letter-spacing:.2px;
    }
    button:hover{border-color: rgba(255,255,255,.22)}
    .primary{background: linear-gradient(180deg, rgba(96,165,250,.22), rgba(96,165,250,.12)); border-color: rgba(96,165,250,.35)}
    .danger{background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.35)}
    .ok{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.35)}
    .warn{background: rgba(251,191,36,.10); border-color: rgba(251,191,36,.35)}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .divider{height:1px; background:var(--line); margin:12px 0}

    .canvasWrap{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
      overflow:hidden;
      min-width: 520px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(15,23,42,.65);
      backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }
    .topbar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .kbd{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.03)
    }

    .stage{
      flex:1;
      display:flex;
      position: relative;
      align-items:center;
      justify-content:center;
      padding:16px;
      overflow:auto;
      background:
        linear-gradient(0deg, rgba(255,255,255,.03), rgba(255,255,255,.03)),
        repeating-conic-gradient(from 45deg, rgba(255,255,255,.03) 0 25%, transparent 0 50%) 0/28px 28px;
    }

    .paper{
      position:relative;
      width: 794px;
      height:1123px;
      background:#0b1220;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      overflow:hidden;
      transform-origin: top left;
    }
    .gridOverlay{
      pointer-events:none;
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity:.25;
      display:none;
    }
    .paper.show-grid .gridOverlay{display:block}

    .guides{pointer-events:none; position:absolute; inset:0; display:none;}
    .paper.show-guides .guides{display:block}
    .guide-bleed, .guide-safe{position:absolute; inset:0; border:2px dashed rgba(255,255,255,.22); border-radius:10px;}
    .guide-safe{ border-style: solid; border-color: rgba(96,165,250,.28); }

    .centerGuides{pointer-events:none; position:absolute; inset:0; display:none;}
    .paper.show-centers .centerGuides{display:block}
    .centerGuides::before,.centerGuides::after{content:""; position:absolute; background: rgba(167,139,250,.25);}
    .centerGuides::before{width:2px; top:0; bottom:0; left:50%; transform: translateX(-1px);}
    .centerGuides::after{height:2px; left:0; right:0; top:50%; transform: translateY(-1px);}

    .item{
      position:absolute;
      min-width: 40px; min-height: 28px;
      user-select:none;
      border:1px solid transparent;
      border-radius:10px;
      touch-action: none; /* ✅ important for mobile drag */
    }
    .item.selected{border-color: rgba(96,165,250,.7); box-shadow: 0 0 0 3px rgba(96,165,250,.18)}
    .item.hidden{display:none}
    .item .content{width:100%; height:100%; border-radius:10px; overflow:hidden;}
    .textBox{
      padding:10px 12px;
      white-space:pre-wrap;
      line-height:1.2;
      font-weight:700;
    }
    .shape{ width:100%; height:100%; }
    .handle{
      position:absolute;
      width:12px; height:12px;
      border-radius:4px;
      background: rgba(229,231,235,.9);
      border:1px solid rgba(0,0,0,.25);
      right:-6px; bottom:-6px;
      cursor: nwse-resize;
      display:none;
      touch-action: none; /* ✅ important for mobile resize */
    }
    .item.selected .handle{display:block}
    .img{width:100%; height:100%; object-fit:cover; display:block; border-radius:10px;}

    .status{
      padding:10px 12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background: rgba(15,23,42,.55);
    }
    .zoom{ width:140px; }
    .mobileOnly{display:none}

    /* Layers list */
    .layersList{display:flex; flex-direction:column; gap:8px; margin-top:8px;}
    .layerRow{
      display:grid; grid-template-columns: 1fr auto;
      gap:10px; align-items:center;
      padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .layerRow.active{
      border-color: rgba(96,165,250,.5);
      background: rgba(96,165,250,.10);
    }
    .layerTitle{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .layerTitle .name{font-weight:900; font-size:12px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .layerTitle .meta{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .layerBtns{display:flex; gap:6px;}
    .iconBtn{
      width:34px; height:34px;
      display:grid; place-items:center;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      cursor:pointer;
    }
    .iconBtn:hover{border-color: rgba(255,255,255,.22)}
    .iconBtn svg{width:16px; height:16px; opacity:.9}
    .iconBtn.warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10)}

    /* Asset Grid */
    .assetGrid{display:grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap:8px; margin-top:8px;}
    .assetItem{
      width:60px; height:60px; border-radius:8px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); cursor:pointer; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .assetItem:hover{border-color: rgba(96,165,250,.45)}
    .assetItem img{width:100%; height:100%; object-fit:cover;}
    .assetItem svg{width:24px; height:24px; opacity:.7}

    /* Logo Preview */
    #logoPreview{margin-top:8px;}
    #logoPreview img{max-width:100%; max-height:80px; border-radius:8px;}

    /* =========================
       Mobile / Tablet Responsive
       ========================= */
    @media (max-width: 980px){
      .app{
        display:flex;
        flex-direction:column;
        height: 100dvh;
        padding: 8px;
        gap: 8px;
        overflow:hidden;
      }
      .canvasWrap{
        order:1;
        min-width: 0;
        flex: 1 1 auto;
        min-height: 52dvh;
      }
      aside.panel{
        order:2;
        position: fixed;
        left: 8px;
        right: 8px;
        bottom: 8px;
        z-index: 25;
        height: min(74dvh, 700px);
        max-height: 82dvh;
        transform: translateY(calc(100% - 58px));
        transition: transform .28s ease;
        border-radius: 18px;
        overflow: hidden;
      }
      aside.panel.open{
        transform: translateY(0);
      }
      .mobileOnly{
        display:inline-flex;
        align-items:center;
        justify-content:center;
      }
      .topbar{
        position: sticky;
        top: 0;
        z-index: 12;
      }
      .tabs{
        overflow-x:auto;
        overflow-y:hidden;
        flex-wrap:nowrap;
        scrollbar-width:thin;
      }
      .tab{
        min-width:94px;
        font-size:13px;
      }
      .panel-inner{
        padding:12px;
      }
      label{
        font-size:13px;
      }
      input[type="text"], input[type="number"], textarea, select{
        min-height:42px;
      }
      .stage{
        padding: 10px;
        overflow: hidden;
      }
    }

    @media (max-width: 640px){
      .app{ padding: 8px; gap: 8px; }

      .row{ grid-template-columns: 1fr; }
      .row3{ grid-template-columns: 1fr; }

      .tabs{ gap: 8px; }
      .tab{ padding: 9px 10px; font-size: 12px; }

      /* ✅ Only make grouped buttons full width */
      button{ padding: 10px 10px; width: auto; }
      .btns{ gap: 8px; }
      .btns button{ width: 100%; }

      .zoom{ width: 120px; }
      .stage{ overflow: auto; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT PANEL -->
    <aside class="panel" id="leftPanel">
      <div class="title panel-inner">
        <h1>Digital Flyer Maker Pro</h1>
        <div class="badge" id="badgeSize">A4 • 96DPI Edit</div>
      </div>

      <div class="panel-inner">
        <div class="tabs">
          <div class="tab active" id="tabDesign">Design</div>
          <div class="tab" id="tabLayers">Layers</div>
          <div class="tab" id="tabAssets">Assets</div>
          <div class="tab" id="tabEffects">Effects</div>
          <div class="tab" id="tabTemplates">Templates</div>
          <div class="tab" id="tabBrand">Brand</div>
        </div>

        <!-- DESIGN TAB -->
        <div id="designTab">
          <div class="group">
            <h2>Canvas</h2>

            <label>Flyer Size</label>
            <select id="sizePreset"></select>

            <div class="row">
              <div>
                <label>Orientation</label>
                <select id="orientation">
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>
              <div>
                <label>Background Color</label>
                <input id="bgColor" type="color" value="#0b1220">
              </div>
            </div>

            <div class="row">
              <div class="inline">
                <input id="scaleLayout" type="checkbox" checked />
                <label for="scaleLayout" style="margin:0;color:var(--text)">Scale layout when resizing</label>
              </div>
              <div class="inline">
                <input id="snapToGrid" type="checkbox" checked />
                <label for="snapToGrid" style="margin:0;color:var(--text)">Snap to grid (10px)</label>
              </div>
            </div>

            <div class="row">
              <div class="inline">
                <input id="showGuides" type="checkbox" />
                <label for="showGuides" style="margin:0;color:var(--text)">Show print guides</label>
              </div>
              <div class="inline">
                <input id="showCenters" type="checkbox" />
                <label for="showCenters" style="margin:0;color:var(--text)">Show center lines</label>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Show Grid</label>
                <button id="toggleGrid" class="primary" type="button">Toggle</button>
              </div>
              <div>
                <label>Export DPI</label>
                <select id="exportDpi">
                  <option value="96">96 (Web)</option>
                  <option value="150">150 (Print)</option>
                  <option value="300" selected>300 (Pro Print)</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="btns">
              <button type="button" class="ok" id="exportPng">Export PNG</button>
              <button type="button" class="primary" id="exportPdf">Export PDF</button>
              <button type="button" id="downloadJson">Save JSON</button>
              <button type="button" id="uploadJsonBtn">Load JSON</button>
              <input id="uploadJson" type="file" accept="application/json" hidden>
            </div>

            <p class="hint" style="margin:10px 0 0">
              PDF export opens the print dialog. Choose “Save as PDF”.
            </p>
          </div>

          <div class="group">
            <h2>Add Elements</h2>
            <div class="btns">
              <button type="button" class="primary" id="addText">Add Text</button>
              <button type="button" id="addCta">Add Button</button>
              <button type="button" id="addRect">Add Rectangle</button>
              <button type="button" id="addCircle">Add Circle</button>
            </div>

            <label>Upload Image / Logo</label>
            <input id="imgUpload" type="file" accept="image/*" />
            <p class="hint" style="margin:8px 0 0">Uploads stay local in your browser.</p>
          </div>

          <div class="group">
            <h2>Selected Element</h2>

            <div id="noSelection" class="hint">Select something on the flyer to edit.</div>

            <div id="editPanel" style="display:none">
              <label>Name</label>
              <input id="elName" type="text" placeholder="Layer name (optional)"/>

              <label>Type</label>
              <input id="elType" type="text" disabled />

              <div class="row">
                <div>
                  <label>X</label>
                  <input id="posX" type="number" />
                </div>
                <div>
                  <label>Y</label>
                  <input id="posY" type="number" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Width</label>
                  <input id="sizeW" type="number" />
                </div>
                <div>
                  <label>Height</label>
                  <input id="sizeH" type="number" />
                </div>
              </div>

              <div id="textControls">
                <label>Text</label>
                <textarea id="textValue"></textarea>

                <div class="row3">
                  <div>
                    <label>Font</label>
                    <select id="fontFamily">
                      <option value="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" selected>System Sans</option>
                      <option value="Georgia, 'Times New Roman', Times, serif">Serif</option>
                      <option value="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace">Mono</option>
                    </select>
                  </div>
                  <div>
                    <label>Size</label>
                    <input id="fontSize" type="number" min="8" max="220" />
                  </div>
                  <div>
                    <label>Weight</label>
                    <select id="fontWeight">
                      <option value="400">400</option>
                      <option value="600">600</option>
                      <option value="700" selected>700</option>
                      <option value="800">800</option>
                      <option value="900">900</option>
                    </select>
                  </div>
                </div>

                <div class="row3">
                  <div>
                    <label>Text Color</label>
                    <input id="textColor" type="color" value="#ffffff">
                  </div>
                  <div>
                    <label>Align</label>
                    <select id="textAlign">
                      <option value="left">Left</option>
                      <option value="center">Center</option>
                      <option value="right">Right</option>
                    </select>
                  </div>
                  <div>
                    <label>Line Height</label>
                    <input id="lineHeight" type="number" min="0.8" max="2.4" step="0.05" value="1.2">
                  </div>
                </div>

                <div class="row3">
                  <div>
                    <label>Letter Spacing</label>
                    <input id="letterSpacing" type="number" min="-2" max="10" step="0.25" value="0">
                  </div>
                  <div>
                    <label>Padding</label>
                    <input id="textPad" type="number" min="0" max="60" step="1" value="12">
                  </div>
                  <div>
                    <label>BG Opacity</label>
                    <input id="textBgAlpha" type="number" min="0" max="1" step="0.05" value="0">
                  </div>
                </div>

                <label>Background (Text Box)</label>
                <input id="textBg" type="color" value="#000000">
              </div>

              <div id="shapeControls">
                <div class="row3">
                  <div>
                    <label>Fill</label>
                    <input id="shapeFill" type="color" value="#60a5fa">
                  </div>
                  <div>
                    <label>Opacity</label>
                    <input id="shapeAlpha" type="number" min="0" max="1" step="0.05" value="0.25">
                  </div>
                  <div>
                    <label>Border Width</label>
                    <input id="shapeBorderW" type="number" min="0" max="20" value="1">
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>Border</label>
                    <input id="shapeBorder" type="color" value="#60a5fa">
                  </div>
                  <div>
                    <label>Corner Radius (Rect)</label>
                    <input id="shapeRadius" type="number" min="0" max="120" value="12">
                  </div>
                </div>
              </div>

              <div id="imageControls">
                <div class="row">
                  <div>
                    <label>Image Fit</label>
                    <select id="imgFit">
                      <option value="cover">Cover</option>
                      <option value="contain">Contain</option>
                    </select>
                  </div>
                  <div>
                    <label>Corner Radius</label>
                    <input id="imgRadius" type="number" min="0" max="120" value="10">
                  </div>
                </div>
              </div>

              <div id="iconControls" style="display:none">
                <label>Icon Color</label>
                <input id="iconColor" type="color" value="#ffffff">
              </div>

              <div class="divider"></div>

              <label>Arrange</label>
              <div class="btns">
                <button type="button" id="bringFront">Bring Front</button>
                <button type="button" id="sendBack">Send Back</button>
                <button type="button" id="alignLeft">Align Left</button>
                <button type="button" id="alignCenter">Align Center</button>
                <button type="button" id="alignRight">Align Right</button>
                <button type="button" id="distributeHoriz">Distribute H</button>
                <button type="button" id="distributeVert">Distribute V</button>
                <button type="button" id="matchWidth">Match Width</button>
                <button type="button" id="matchHeight">Match Height</button>
              </div>

              <div class="divider"></div>

              <div class="btns">
                <button type="button" id="groupEl">Group</button>
                <button type="button" id="ungroupEl">Ungroup</button>
                <button type="button" class="danger" id="deleteEl">Delete</button>
                <button type="button" id="duplicateEl">Duplicate</button>
              </div>

              <div class="divider"></div>

              <label>Templates</label>
              <div class="btns">
                <button type="button" id="addHeaderTemplate">Header Block</button>
                <button type="button" id="addHeroTemplate">Hero Section</button>
                <button type="button" id="addCallToAction">Call to Action</button>
                <button type="button" id="addFooterTemplate">Footer Block</button>
              </div>
            </div>
          </div>
        </div>

        <!-- LAYERS TAB -->
        <div id="layersTab" style="display:none">
          <div class="group">
            <h2>Layers</h2>
            <div class="hint">Top = front.</div>
            <div class="layersList" id="layersList"></div>
            <div class="divider"></div>
            <div class="btns">
              <button type="button" class="warn" id="moveUp">Move Up</button>
              <button type="button" class="warn" id="moveDown">Move Down</button>
              <button type="button" class="danger" id="deleteLayer">Delete</button>
              <button type="button" class="danger" id="clearAll">Clear Canvas</button>
            </div>
          </div>
        </div>

        <!-- ASSETS TAB -->
        <div id="assetsTab" style="display:none">
          <div class="group">
            <h2>Asset Library</h2>
            <div class="btns">
              <button type="button" class="primary" id="addIcon">Add Icon</button>
              <button type="button" id="addShapeAsset">Add Shape</button>
              <button type="button" id="addPattern">Add Pattern</button>
            </div>
            <div class="divider"></div>
            <h2>Stock Images</h2>
            <div class="btns">
              <button type="button" id="searchStock">Search Stock</button>
              <button type="button" id="uploadAsset">Upload Asset</button>
            </div>
            <input id="stockSearch" type="text" placeholder="Search for images..." />
            <div id="stockResults" class="assetGrid"></div>
            <div class="divider"></div>
            <h2>Templates</h2>
            <div class="btns">
              <button type="button" id="addHeaderTemplate">Header Block</button>
              <button type="button" id="addHeroTemplate">Hero Section</button>
              <button type="button" id="addCallToAction">Call to Action</button>
              <button type="button" id="addFooterTemplate">Footer Block</button>
            </div>
          </div>
        </div>

        <!-- EFFECTS TAB -->
        <div id="effectsTab" style="display:none">
          <div class="group">
            <h2>Effects Panel</h2>
            <div id="noSelectionEffect" class="hint">Select an element to apply effects.</div>
            <div id="effectsPanel" style="display:none">
              <label>Shadow</label>
              <div class="row3">
                <div><input id="shadowX" type="number" placeholder="X" /></div>
                <div><input id="shadowY" type="number" placeholder="Y" /></div>
                <div><input id="shadowBlur" type="number" placeholder="Blur" /></div>
              </div>
              <input id="shadowColor" type="color" value="#000000" />
              <input id="shadowAlpha" type="number" min="0" max="1" step="0.05" value="0.5" />

              <div class="divider"></div>
              <label>Blur</label>
              <input id="blurAmount" type="number" min="0" max="20" step="0.5" value="0" />

              <div class="divider"></div>
              <label>Blend Mode</label>
              <select id="blendMode">
                <option value="normal">Normal</option>
                <option value="multiply">Multiply</option>
                <option value="screen">Screen</option>
                <option value="overlay">Overlay</option>
                <option value="darken">Darken</option>
                <option value="lighten">Lighten</option>
              </select>
            </div>
          </div>
        </div>

        <!-- TEMPLATES TAB -->
        <div id="templatesTab" style="display:none">
          <div class="group">
            <h2>Template Engine</h2>
            <div class="btns">
              <button type="button" class="primary" id="eventTemplate">Event Template</button>
              <button type="button" id="businessTemplate">Business Template</button>
              <button type="button" id="churchTemplate">Church Template</button>
              <button type="button" id="saleTemplate">Sale Template</button>
            </div>
            <div class="divider"></div>
            <h2>Quick Actions</h2>
            <div class="btns">
              <button type="button" id="socialResize">Social Resize</button>
              <button type="button" id="addQR">Add QR Code</button>
              <button type="button" id="addDataBlock">Add Data Block</button>
            </div>
            <div class="divider"></div>
            <h2>QR Code Options</h2>
            <div class="row">
              <div>
                <label>QR Size</label>
                <select id="qrSize">
                  <option value="100">Small (100px)</option>
                  <option value="150" selected>Medium (150px)</option>
                  <option value="200">Large (200px)</option>
                  <option value="300">Extra Large (300px)</option>
                </select>
              </div>
              <div>
                <label>Error Correction</label>
                <select id="qrErrorLevel">
                  <option value="L">Low (7%)</option>
                  <option value="M" selected>Medium (15%)</option>
                  <option value="Q">Quartile (25%)</option>
                  <option value="H">High (30%)</option>
                </select>
              </div>
            </div>
            <div class="divider"></div>
            <h2>QR Code Presets</h2>
            <div class="btns">
              <button type="button" id="qrWebsite">Website</button>
              <button type="button" id="qrPhone">Phone</button>
              <button type="button" id="qrEmail">Email</button>
              <button type="button" id="qrLocation">Location</button>
            </div>
          </div>
        </div>

        <!-- BRAND TAB -->
        <div id="brandTab" style="display:none">
          <div class="group">
            <h2>Brand Kit</h2>
            <div class="btns">
              <button type="button" class="primary" id="saveBrand">Save Brand</button>
              <button type="button" id="loadBrand">Load Brand</button>
              <button type="button" id="resetBrandForm">Reset</button>
            </div>
            <div class="divider"></div>
            <label>Brand Colors</label>
            <div class="row3" id="brandColors">
              <input type="color" id="brandColor1" value="#60a5fa" />
              <input type="color" id="brandColor2" value="#a78bfa" />
              <input type="color" id="brandColor3" value="#22c55e" />
            </div>
            <div class="divider"></div>
            <label>Brand Fonts</label>
            <select id="brandFont1">
              <option value="ui-sans-serif, system-ui">System Sans</option>
              <option value="Georgia, serif">Serif</option>
              <option value="ui-monospace, monospace">Monospace</option>
            </select>
            <select id="brandFont2">
              <option value="ui-sans-serif, system-ui">System Sans</option>
              <option value="Georgia, serif">Serif</option>
              <option value="ui-monospace, monospace">Monospace</option>
            </select>
            <div class="divider"></div>
            <label>Logo Upload</label>
            <input id="logoUpload" type="file" accept="image/*" />
            <div id="logoPreview"></div>
            <div class="btns" style="margin-top:8px">
              <button type="button" id="addLogoToCanvas">Add Logo to Canvas</button>
            </div>
            <div class="divider"></div>
            <label>Business Details</label>
            <input id="brandName" type="text" placeholder="Business name" value="Your Business Name" />
            <input id="brandTagline" type="text" placeholder="Tagline" value="Quality service you can trust" />
            <div class="row">
              <input id="brandPhone" type="text" placeholder="Phone" value="(555) 123-4567" />
              <input id="brandWebsite" type="text" placeholder="Website" value="www.example.com" />
            </div>
            <input id="brandCtaText" type="text" placeholder="Call to action text" value="Get Started Today" />
            <div class="divider"></div>
            <label>Quick Presets</label>
            <div class="btns">
              <button type="button" id="brandPresetCorporate">Corporate</button>
              <button type="button" id="brandPresetWarm">Warm</button>
              <button type="button" id="brandPresetBold">Bold</button>
            </div>
            <div class="divider"></div>
            <label>Brand Actions</label>
            <div class="btns">
              <button type="button" class="primary" id="applyBrandSelected">Apply to Selected</button>
              <button type="button" id="applyBrandAll">Apply to All Elements</button>
              <button type="button" id="addBrandHeader">Add Brand Header</button>
              <button type="button" id="addBrandContact">Add Contact Block</button>
            </div>
          </div>
        </div>

      </div>
    </aside>

    <!-- RIGHT CANVAS -->
    <main class="canvasWrap">
      <div class="topbar">
        <div class="left">
          <span class="kbd" id="topSize">A4</span>
          <span class="kbd" id="topPx">794×1123 px</span>
        </div>
        <div class="right">
          <button type="button" id="mobilePanelToggle" class="mobileOnly">Controls</button>
          <span class="kbd">Zoom</span>
          <input class="zoom" id="zoom" type="range" min="40" max="140" value="100">
          <span class="kbd" id="zoomLabel">100%</span>
        </div>
      </div>

      <div class="stage">
        <div class="paper" id="paper">
          <div class="gridOverlay"></div>
          <div class="centerGuides"></div>
          <div class="guides">
            <div class="guide-bleed" id="guideBleed"></div>
            <div class="guide-safe" id="guideSafe"></div>
          </div>
        </div>
      </div>

      <div class="status">
        <div id="statusLeft">No selection</div>
        <div id="statusRight">Ready</div>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
    // ===== Utilities =====
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const rgba = (hex, a=1) => {
      const h = hex.replace("#","").trim();
      const full = h.length === 3 ? h.split("").map(x=>x+x).join("") : h;
      const r = parseInt(full.slice(0,2),16);
      const g = parseInt(full.slice(2,4),16);
      const b = parseInt(full.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    };
    const inchesToPx = (inches, dpi) => Math.round(inches * dpi);

    // ===== Size presets (inches) =====
    const SIZE_PRESETS = {
      a4:        { label: "A4 (8.27×11.69 in)", wIn: 8.27, hIn: 11.69 },
      letter:    { label: "Letter (8.5×11 in)", wIn: 8.5,  hIn: 11 },
      a5:        { label: "A5 (5.83×8.27 in)", wIn: 5.83, hIn: 8.27 },
      half:      { label: "Half-page (5.5×8.5 in)", wIn: 5.5,  hIn: 8.5 },
      quarter:   { label: "Quarter-page (4.25×5.5 in)", wIn: 4.25, hIn: 5.5 },
      postcard4x6:{ label: "Postcard (4×6 in)", wIn: 4,    hIn: 6 },
      postcard6x9:{ label: "Postcard (6×9 in)", wIn: 6,    hIn: 9 },
      rack35:    { label: "Rack card (3.5×8.5 in)", wIn: 3.5,  hIn: 8.5 },
      rack367:   { label: "Rack card (3.67×8.5 in)", wIn: 3.67, hIn: 8.5 },
    };

    // ===== DOM =====
    const paper = document.getElementById("paper");
    const bgColor = document.getElementById("bgColor");
    const toggleGrid = document.getElementById("toggleGrid");
    const statusLeft = document.getElementById("statusLeft");
    const statusRight = document.getElementById("statusRight");
    const zoom = document.getElementById("zoom");
    const zoomLabel = document.getElementById("zoomLabel");
    const badgeSize = document.getElementById("badgeSize");
    const topSize = document.getElementById("topSize");
    const topPx = document.getElementById("topPx");

    const sizePreset = document.getElementById("sizePreset");
    const orientation = document.getElementById("orientation");
    const scaleLayout = document.getElementById("scaleLayout");
    const exportDpi = document.getElementById("exportDpi");
    const showGuides = document.getElementById("showGuides");
    const showCenters = document.getElementById("showCenters");
    const snapToGrid = document.getElementById("snapToGrid");
    const guideBleed = document.getElementById("guideBleed");
    const guideSafe = document.getElementById("guideSafe");

    const layersList = document.getElementById("layersList");

    // New tab elements
    const noSelectionEffect = document.getElementById("noSelectionEffect");
    const effectsPanel = document.getElementById("effectsPanel");
    const stockSearch = document.getElementById("stockSearch");
    const stockResults = document.getElementById("stockResults");
    const logoPreview = document.getElementById("logoPreview");

    // Tabs
    const tabDesign = document.getElementById("tabDesign");
    const tabLayers = document.getElementById("tabLayers");
    const tabAssets = document.getElementById("tabAssets");
    const tabEffects = document.getElementById("tabEffects");
    const tabTemplates = document.getElementById("tabTemplates");
    const tabBrand = document.getElementById("tabBrand");
    const leftPanel = document.getElementById("leftPanel");
    const mobilePanelToggle = document.getElementById("mobilePanelToggle");
    const designTab = document.getElementById("designTab");
    const layersTab = document.getElementById("layersTab");
    const assetsTab = document.getElementById("assetsTab");
    const effectsTab = document.getElementById("effectsTab");
    const templatesTab = document.getElementById("templatesTab");
    const brandTab = document.getElementById("brandTab");

    // Selected edit
    const noSelection = document.getElementById("noSelection");
    const editPanel = document.getElementById("editPanel");
    const elName = document.getElementById("elName");
    const elType = document.getElementById("elType");
    const posX = document.getElementById("posX");
    const posY = document.getElementById("posY");
    const sizeW = document.getElementById("sizeW");
    const sizeH = document.getElementById("sizeH");

    const textControls = document.getElementById("textControls");
    const textValue = document.getElementById("textValue");
    const fontFamily = document.getElementById("fontFamily");
    const fontSize = document.getElementById("fontSize");
    const fontWeight = document.getElementById("fontWeight");
    const textColor = document.getElementById("textColor");
    const textAlign = document.getElementById("textAlign");
    const lineHeight = document.getElementById("lineHeight");
    const letterSpacing = document.getElementById("letterSpacing");
    const textPad = document.getElementById("textPad");
    const textBg = document.getElementById("textBg");
    const textBgAlpha = document.getElementById("textBgAlpha");

    const shapeControls = document.getElementById("shapeControls");
    const shapeFill = document.getElementById("shapeFill");
    const shapeAlpha = document.getElementById("shapeAlpha");
    const shapeBorder = document.getElementById("shapeBorder");
    const shapeBorderW = document.getElementById("shapeBorderW");
    const shapeRadius = document.getElementById("shapeRadius");

    const imageControls = document.getElementById("imageControls");
    const imgFit = document.getElementById("imgFit");
    const imgRadius = document.getElementById("imgRadius");

    // Icon controls
    const iconColor = document.getElementById("iconColor");

    // Effects controls
    const shadowX = document.getElementById("shadowX");
    const shadowY = document.getElementById("shadowY");
    const shadowBlur = document.getElementById("shadowBlur");
    const shadowColor = document.getElementById("shadowColor");
    const shadowAlpha = document.getElementById("shadowAlpha");
    const blurAmount = document.getElementById("blurAmount");
    const blendMode = document.getElementById("blendMode");

    // ===== State =====
    const EDIT_DPI = 96;
    const BLEED_IN = 0.125;
    const SAFE_IN  = 0.25;
    const SNAP = 10;

    let canvasPresetKey = "a4";
    let canvasLandscape = false;

    let elements = [];
    let selectedId = null;
    let selectedIds = new Set(); // Multi-select support
    let drag = null;
    let resize = null;
    let rotate = null; // Rotation support
    let zCounter = 1;

    // ===== Snapping & Alignment =====
    let alignmentGuides = [];
    let snapThreshold = 8;

    function getSnapLines(element){
      const lines = [];
      // Element edges and center
      lines.push(
        { type: 'vertical', pos: element.x, element: element.id },
        { type: 'vertical', pos: element.x + element.w/2, element: element.id },
        { type: 'vertical', pos: element.x + element.w, element: element.id },
        { type: 'horizontal', pos: element.y, element: element.id },
        { type: 'horizontal', pos: element.y + element.h/2, element: element.id },
        { type: 'horizontal', pos: element.y + element.h, element: element.id }
      );
      return lines;
    }

    function findSnap(element, excludeIds = new Set()){
      const snapLines = [];
      const allLines = [];

      // Collect all snap lines from other elements
      for(const el of elements){
        if(excludeIds.has(el.id)) continue;
        allLines.push(...getSnapLines(el));
      }

      // Check for snaps
      const elementLines = getSnapLines(element);
      for(const elLine of elementLines){
        for(const otherLine of allLines){
          if(elLine.type === otherLine.type){
            const distance = Math.abs(elLine.pos - otherLine.pos);
            if(distance <= snapThreshold){
              snapLines.push({
                type: elLine.type,
                pos: otherLine.pos,
                distance: distance,
                elementLine: elLine,
                otherElement: otherLine.element
              });
            }
          }
        }
      }

      return snapLines;
    }

    function applySnap(element, snapLines){
      let snappedX = element.x;
      let snappedY = element.y;

      for(const snap of snapLines){
        if(snap.type === 'vertical'){
          snappedX = snap.pos - (snap.elementLine.pos - element.x);
        } else if(snap.type === 'horizontal'){
          snappedY = snap.pos - (snap.elementLine.pos - element.y);
        }
      }

      return { x: snappedX, y: snappedY };
    }

    // ===== Undo/Redo System =====
    let history = [];
    let historyIndex = -1;
    const MAX_HISTORY = 50;

    function saveState(){
      const state = JSON.stringify({
        elements: JSON.parse(JSON.stringify(elements)),
        selectedId,
        selectedIds: Array.from(selectedIds),
        zCounter,
        canvasPresetKey,
        canvasLandscape,
        bgColor: bgColor.value
      });

      // Remove future history if we're not at the end
      history = history.slice(0, historyIndex + 1);

      history.push(state);
      historyIndex++;

      // Limit history size
      if(history.length > MAX_HISTORY){
        history.shift();
        historyIndex--;
      }
    }

    function undo(){
      if(historyIndex > 0){
        historyIndex--;
        loadState(history[historyIndex]);
        render();
        renderLayers();
        updateEditPanel();
        setStatus("Undid", "Ready");
      }
    }

    function redo(){
      if(historyIndex < history.length - 1){
        historyIndex++;
        loadState(history[historyIndex]);
        render();
        renderLayers();
        updateEditPanel();
        setStatus("Redid", "Ready");
      }
    }

    function loadState(stateStr){
      const state = JSON.parse(stateStr);
      elements = state.elements;
      selectedId = state.selectedId;
      selectedIds = new Set(state.selectedIds || []);
      zCounter = state.zCounter;
      canvasPresetKey = state.canvasPresetKey || "a4";
      canvasLandscape = state.canvasLandscape || false;
      if(state.bgColor) bgColor.value = state.bgColor;
      paper.style.background = bgColor.value;
    }

    // ===== Helpers =====
    function setStatus(left, right){ statusLeft.textContent = left; statusRight.textContent = right; }
    function getSelected(){ return elements.find(e=>e.id===selectedId) || null; }
    function getSelectedElements(){
      if(selectedId) return [getSelected()].filter(Boolean);
      return Array.from(selectedIds).map(id => elements.find(e => e.id === id)).filter(Boolean);
    }
    function snap(n){ return snapToGrid.checked ? Math.round(n / SNAP) * SNAP : n; }

    function currentCanvasInches(){
      const p = SIZE_PRESETS[canvasPresetKey] || SIZE_PRESETS.a4;
      let wIn = p.wIn, hIn = p.hIn;
      if(canvasLandscape) [wIn,hIn] = [hIn,wIn];
      return { wIn, hIn, base: p.label.split(" (")[0] };
    }
    function currentCanvasPx(){
      const { wIn, hIn } = currentCanvasInches();
      return { wPx: inchesToPx(wIn, EDIT_DPI), hPx: inchesToPx(hIn, EDIT_DPI) };
    }
    function updateSizeLabels(){
      const { wPx, hPx } = currentCanvasPx();
      const { base } = currentCanvasInches();
      badgeSize.textContent = `${base} • ${canvasLandscape ? "Landscape" : "Portrait"} • 96DPI Edit`;
      topSize.textContent = `${base} (${canvasLandscape ? "Land" : "Port"})`;
      topPx.textContent = `${wPx}×${hPx} px`;

      const bleedPx = inchesToPx(BLEED_IN, EDIT_DPI);
      const safePx  = inchesToPx(SAFE_IN,  EDIT_DPI);
      guideBleed.style.inset = `${bleedPx}px`;
      guideSafe.style.inset  = `${safePx}px`;
    }

    function applyCanvasSize({presetKey, landscape, scale}){
      const oldW = paper.clientWidth;
      const oldH = paper.clientHeight;

      canvasPresetKey = presetKey;
      canvasLandscape = landscape;

      const { wPx, hPx } = currentCanvasPx();
      paper.style.width  = wPx + "px";
      paper.style.height = hPx + "px";

      if(scale && oldW && oldH && elements.length){
        const sx = wPx / oldW;
        const sy = hPx / oldH;
        const sFont = Math.min(sx, sy);
        for(const el of elements){
          el.x *= sx; el.y *= sy; el.w *= sx; el.h *= sy;
          if(el.type === "text") el.fontSize *= sFont;
        }
      }

      for(const el of elements){
        el.x = clamp(el.x, 0, wPx - 10);
        el.y = clamp(el.y, 0, hPx - 10);
        el.w = clamp(el.w, 30, wPx - el.x);
        el.h = clamp(el.h, 24, hPx - el.y);
        if(el.type === "text") el.fontSize = clamp(el.fontSize, 8, 260);
      }

      updateSizeLabels();
      render();
      renderLayers();
      updateEditPanel();
      setStatus("Canvas resized", `${wPx}×${hPx}px`);
    }

    function setPaperScale(z, centerMobile=false){
      if(isMobileView() && centerMobile){
        paper.style.position = "absolute";
        paper.style.left = "50%";
        paper.style.top = "50%";
        paper.style.margin = "0";
        paper.style.transformOrigin = "center center";
        paper.style.transform = `translate(-50%, -50%) scale(${z})`;
        return;
      }
      paper.style.position = "relative";
      paper.style.left = "";
      paper.style.top = "";
      paper.style.margin = "";
      paper.style.transformOrigin = "top left";
      paper.style.transform = `scale(${z})`;
    }

    // ===== Auto-fit to screen (mobile friendly) =====
    function autoFitToScreen(force=false){
      if(!force && window.matchMedia("(min-width: 981px)").matches) return;

      const wrap = document.querySelector(".stage");
      if(!wrap) return;

      const maxW = wrap.clientWidth - 24;
      const maxH = wrap.clientHeight - 24;

      const w = paper.clientWidth || 1;
      const h = paper.clientHeight || 1;

      const scaleW = maxW / w;
      const scaleH = maxH / h;

      const z = clamp(Math.min(scaleW, scaleH, 1), 0.4, 1);
      const pct = Math.round(z * 100);

      setPaperScale(z, true);
      zoom.value = pct;
      zoomLabel.textContent = `${pct}%`;
    }

    // ===== PDF sizing injection =====
    function setPrintPageSizeCss(widthIn, heightIn){
      const css = `@page { size: ${widthIn}in ${heightIn}in; margin: 0; }`;
      let tag = document.getElementById("printPageSize");
      if(!tag){
        tag = document.createElement("style");
        tag.id = "printPageSize";
        document.head.appendChild(tag);
      }
      tag.textContent = css;
    }
    function exportPdf(){
      const { wIn, hIn } = currentCanvasInches();
      setPrintPageSizeCss(wIn, hIn);

      const gridWas = paper.classList.contains("show-grid");
      const guidesWas = paper.classList.contains("show-guides");
      const centersWas = paper.classList.contains("show-centers");
      paper.classList.remove("show-grid","show-guides","show-centers");

      setStatus("Export PDF", "Save as PDF");
      window.print();

      paper.classList.toggle("show-grid", gridWas);
      paper.classList.toggle("show-guides", guidesWas);
      paper.classList.toggle("show-centers", centersWas);
    }

    // ===== Elements =====
    function addText(opts={}){
      const id = uid();
      const el = {
        id,
        name: opts.name ?? "Text",
        hidden:false,
        locked: false,
        type:"text",
        groupId: null,
        x: opts.x ?? 70,
        y: opts.y ?? 90,
        w: opts.w ?? 520,
        h: opts.h ?? 90,
        rotation: 0,
        z: ++zCounter,
        text: opts.text ?? "",
        fontFamily: opts.fontFamily ?? "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",
        fontSize: opts.fontSize ?? 36,
        fontWeight: opts.fontWeight ?? 700,
        lineHeight: opts.lineHeight ?? 1.2,
        letterSpacing: opts.letterSpacing ?? 0,
        pad: opts.pad ?? 12,
        color: opts.color ?? "#ffffff",
        align: opts.align ?? "left",
        bg: opts.bg ?? "#000000",
        bgAlpha: opts.bgAlpha ?? 0,
        textShadow: { x: 0, y: 0, blur: 0, color: "#000000", alpha: 1 },
        // Effects
        shadowX: 0, shadowY: 0, shadowBlur: 0, shadowColor: "#000000", shadowAlpha: 0.5,
        blur: 0,
        blendMode: "normal"
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
      setTimeout(()=>{ textValue?.focus(); }, 0);
    }

    function addShape(kind="rect", opts={}){
      const id = uid();
      const el = {
        id,
        name: opts.name ?? (kind === "circle" ? "Circle" : "Rectangle"),
        hidden:false,
        locked: false,
        type:"shape",
        groupId: null,
        kind,
        x: opts.x ?? 60,
        y: opts.y ?? 60,
        w: opts.w ?? (kind === "circle" ? 180 : 680),
        h: opts.h ?? (kind === "circle" ? 180 : 140),
        rotation: 0,
        z: ++zCounter,
        fill: opts.fill ?? "#60a5fa",
        alpha: opts.alpha ?? 0.18,
        border: opts.border ?? "#60a5fa",
        borderW: opts.borderW ?? 1,
        radius: opts.radius ?? 12,
        // Effects
        shadowX: 0, shadowY: 0, shadowBlur: 0, shadowColor: "#000000", shadowAlpha: 0.5,
        blur: 0,
        blendMode: "normal"
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
    }

    function addButton(opts={}){
      const id = uid();
      const el = {
        id,
        name: opts.name ?? "Button",
        hidden:false,
        locked: false,
        type:"text",
        groupId: null,
        x: opts.x ?? 70,
        y: opts.y ?? Math.max(70, paper.clientHeight - 220),
        w: opts.w ?? 520,
        h: opts.h ?? 86,
        rotation: 0,
        z: ++zCounter,
        text: opts.text ?? "",
        fontFamily: opts.fontFamily ?? "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",
        fontSize: opts.fontSize ?? 28,
        fontWeight: opts.fontWeight ?? 900,
        lineHeight: opts.lineHeight ?? 1.05,
        letterSpacing: opts.letterSpacing ?? 0,
        pad: opts.pad ?? 14,
        color: opts.color ?? "#0b1220",
        align: opts.align ?? "center",
        bg: opts.bg ?? "#60a5fa",
        bgAlpha: opts.bgAlpha ?? 1,
        textShadow: { x: 0, y: 0, blur: 0, color: "#000000", alpha: 1 },
        // Effects
        shadowX: 0, shadowY: 0, shadowBlur: 0, shadowColor: "#000000", shadowAlpha: 0.5,
        blur: 0,
        blendMode: "normal"
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
      setTimeout(()=>{ textValue?.focus(); }, 0);
    }

    function addImage(dataUrl, opts={}){
      const id = uid();
      const el = {
        id,
        name: opts.name ?? "Image",
        hidden:false,
        locked: false,
        type:"image",
        groupId: null,
        x: opts.x ?? Math.max(40, paper.clientWidth - 280),
        y: opts.y ?? 220,
        w: opts.w ?? 240,
        h: opts.h ?? 240,
        rotation: 0,
        z: ++zCounter,
        src: dataUrl,
        fit: opts.fit ?? "cover",
        radius: opts.radius ?? 12,
        // Effects
        shadowX: 0, shadowY: 0, shadowBlur: 0, shadowColor: "#000000", shadowAlpha: 0.5,
        blur: 0,
        blendMode: "normal"
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
    }

    function clearAll(){
      elements = [];
      selectedId = null;
      zCounter = 1;
      render();
      renderLayers();
      updateEditPanel();
      setStatus("Canvas cleared", "Ready");
    }

    // ===== Templates =====
    function addHeaderTemplate(){
      // Add title
      addText({
        name: "Header Title",
        x: 40, y: 40, w: 720, h: 80,
        text: "Your Company Name",
        fontSize: 48, fontWeight: 900,
        align: "center",
        color: "#ffffff",
        bgAlpha: 0
      });

      // Add subtitle
      addText({
        name: "Header Subtitle",
        x: 40, y: 140, w: 720, h: 50,
        text: "Professional Services & Solutions",
        fontSize: 24, fontWeight: 400,
        align: "center",
        color: "#cbd5e1",
        bgAlpha: 0
      });

      setStatus("Header template added", "Ready");
    }

    function addHeroTemplate(){
      // Add background shape
      addShape("rect", {
        name: "Hero Background",
        x: 20, y: 200, w: 760, h: 300,
        fill: "#60a5fa", alpha: 0.1,
        border: "#60a5fa", borderW: 2,
        radius: 24
      });

      // Add hero title
      addText({
        name: "Hero Title",
        x: 60, y: 240, w: 680, h: 80,
        text: "Welcome to Our Services",
        fontSize: 42, fontWeight: 800,
        align: "center",
        color: "#ffffff",
        bgAlpha: 0
      });

      // Add hero description
      addText({
        name: "Hero Description",
        x: 80, y: 340, w: 640, h: 120,
        text: "We provide exceptional solutions tailored to your needs. Our team of experts is dedicated to delivering quality results that exceed expectations.",
        fontSize: 18, fontWeight: 400, lineHeight: 1.6,
        align: "center",
        color: "#e2e8f0",
        bgAlpha: 0
      });

      setStatus("Hero template added", "Ready");
    }

    function addCallToAction(){
      // Add CTA button
      addButton({
        name: "CTA Button",
        x: 200, y: 520, w: 400, h: 70,
        text: "Get Started Today",
        fontSize: 24, fontWeight: 700,
        align: "center",
        color: "#0f172a",
        bg: "#60a5fa", bgAlpha: 1
      });

      // Add CTA text
      addText({
        name: "CTA Text",
        x: 100, y: 480, w: 600, h: 40,
        text: "Ready to transform your business?",
        fontSize: 20, fontWeight: 600,
        align: "center",
        color: "#ffffff",
        bgAlpha: 0
      });

      setStatus("Call-to-action template added", "Ready");
    }

    function addFooterTemplate(){
      // Add footer background
      addShape("rect", {
        name: "Footer Background",
        x: 0, y: 600, w: 800, h: 100,
        fill: "#1e293b", alpha: 0.9,
        border: "#334155", borderW: 1,
        radius: 0
      });

      // Add footer text
      addText({
        name: "Footer Text",
        x: 40, y: 620, w: 720, h: 60,
        text: "© 2024 Your Company. All rights reserved. | Contact us: info@company.com | Phone: (555) 123-4567",
        fontSize: 14, fontWeight: 400,
        align: "center",
        color: "#cbd5e1",
        bgAlpha: 0
      });

      setStatus("Footer template added", "Ready");
    }

    // ===== Pointer Drag/Resize (mobile + desktop) =====
    function startDragPointer(e, id){
      const el = elements.find(x=>x.id===id);
      if(!el) return;

      // Get all elements to drag (single, multi-selection, or group with children)
      let elementsToDrag = [];
      if(selectedId === id && el.type === "group"){
        // If dragging a group, include all children
        elementsToDrag = [el, ...elements.filter(e=>e.groupId === el.id)];
      } else if(selectedId === id){
        elementsToDrag = [el];
      } else {
        // Multi-selection
        elementsToDrag = Array.from(selectedIds).map(id => elements.find(e => e.id === id)).filter(Boolean);
      }

      drag = {
        elements: elementsToDrag,
        startX: e.clientX,
        startY: e.clientY,
        initialPositions: elementsToDrag.map(el => ({ x: el.x, y: el.y })),
        excludeIds: new Set(elementsToDrag.map(el => el.id))
      };
      window.addEventListener("pointermove", onDragMovePointer);
      window.addEventListener("pointerup", onDragEndPointer, { once:true });
    }

    function onDragMovePointer(e){
      if(!drag) return;

      const dx = e.clientX - drag.startX;
      const dy = e.clientY - drag.startY;

      // Calculate new positions
      const newElements = drag.elements.map((el, i) => ({
        ...el,
        x: drag.initialPositions[i].x + dx,
        y: drag.initialPositions[i].y + dy
      }));

      // Find snaps for the primary element (first one)
      const primaryEl = newElements[0];
      const snapLines = findSnap(primaryEl, drag.excludeIds);
      alignmentGuides = snapLines.map(snap => ({ type: snap.type, pos: snap.pos }));

      // Apply snapping to all elements
      if(snapLines.length > 0){
        const snapped = applySnap(primaryEl, snapLines);
        const snapDx = snapped.x - primaryEl.x;
        const snapDy = snapped.y - primaryEl.y;

        drag.elements.forEach((el, i) => {
          el.x = drag.initialPositions[i].x + dx + snapDx;
          el.y = drag.initialPositions[i].y + dy + snapDy;
        });
      } else {
        alignmentGuides = [];
        drag.elements.forEach((el, i) => {
          el.x = drag.initialPositions[i].x + dx;
          el.y = drag.initialPositions[i].y + dy;
        });
      }

      render();
      updateEditPanelQuiet();
      const movingEl = drag.elements[0];
      setStatus("Moving", `x:${Math.round(movingEl.x)} y:${Math.round(movingEl.y)}`);
    }

    function onDragEndPointer(){
      alignmentGuides = [];
      drag = null;
      window.removeEventListener("pointermove", onDragMovePointer);
      render();
      renderLayers();
      setStatus("Moved", "Ready");
    }

    function startResizePointer(e, id){
      const el = elements.find(x=>x.id===id);
      if(!el) return;
      const payload = { id, startX: e.clientX, startY: e.clientY, w: el.w, h: el.h };
      if(el.type === "group"){
        const children = elements.filter(x=>x.groupId === el.id);
        payload.children = children.map(c=>({
          id: c.id, x: c.x, y: c.y, w: c.w, h: c.h
        }));
      }
      resize = payload;
      window.addEventListener("pointermove", onResizeMovePointer);
      window.addEventListener("pointerup", onResizeEndPointer, { once:true });
      window.addEventListener("pointercancel", onResizeEndPointer, { once:true });
    }
    function onResizeMovePointer(e){
      if(!resize) return;
      const el = elements.find(x=>x.id===resize.id);
      if(!el) return;
      const dx = e.clientX - resize.startX;
      const dy = e.clientY - resize.startY;
      const newW = snap(clamp(resize.w + dx, 30, paper.clientWidth - el.x));
      const newH = snap(clamp(resize.h + dy, 24, paper.clientHeight - el.y));
      if(el.type === "group" && Array.isArray(resize.children) && resize.children.length){
        const sx = newW / Math.max(1, resize.w);
        const sy = newH / Math.max(1, resize.h);
        resize.children.forEach(ch=>{
          const c = elements.find(x=>x.id===ch.id);
          if(!c) return;
          c.x = snap(clamp(el.x + (ch.x - el.x) * sx, 0, paper.clientWidth - 10));
          c.y = snap(clamp(el.y + (ch.y - el.y) * sy, 0, paper.clientHeight - 10));
          c.w = snap(clamp(ch.w * sx, 30, paper.clientWidth - c.x));
          c.h = snap(clamp(ch.h * sy, 24, paper.clientHeight - c.y));
        });
      }
      el.w = newW;
      el.h = newH;
      render();
      updateEditPanelQuiet();
      setStatus("Resizing", `w:${Math.round(el.w)} h:${Math.round(el.h)}`);
    }
    function onResizeEndPointer(){
      resize = null;
      window.removeEventListener("pointermove", onResizeMovePointer);
      renderLayers();
      setStatus("Resized", "Ready");
    }
    function startRotatePointer(e, id){
      const el = elements.find(x=>x.id===id);
      if(!el) return;
      const rect = paper.getBoundingClientRect();
      const centerX = el.x + el.w/2;
      const centerY = el.y + el.h/2;

      rotate = {
        id,
        startAngle: Math.atan2(e.clientY - rect.top - centerY, e.clientX - rect.left - centerX),
        startRotation: el.rotation || 0
      };
      window.addEventListener("pointermove", onRotateMovePointer);
      window.addEventListener("pointerup", onRotateEndPointer, { once:true });
    }

    function onRotateMovePointer(e){
      if(!rotate) return;
      const el = elements.find(x=>x.id===rotate.id);
      if(!el) return;

      const rect = paper.getBoundingClientRect();
      const centerX = el.x + el.w/2;
      const centerY = el.y + el.h/2;
      const currentAngle = Math.atan2(e.clientY - rect.top - centerY, e.clientX - rect.left - centerX);

      el.rotation = rotate.startRotation + (currentAngle - rotate.startAngle) * (180 / Math.PI);
      el.rotation = ((el.rotation % 360) + 360) % 360; // Normalize to 0-360

      render();
      updateEditPanelQuiet();
      setStatus("Rotating", `${Math.round(el.rotation)}°`);
    }

    function onRotateEndPointer(){
      rotate = null;
      window.removeEventListener("pointermove", onRotateMovePointer);
      renderLayers();
      setStatus("Rotated", "Ready");
    }

    // ===== Render =====
    function render(){
      paper.querySelectorAll(".item, .alignment-guide").forEach(n=>n.remove());
      paper.style.background = bgColor.value;

      const sorted = [...elements].sort((a,b)=>a.z-b.z);
      for(const el of sorted){
        const node = document.createElement("div");
        node.className = "item";
        node.dataset.id = el.id;
        node.style.left = el.x + "px";
        node.style.top = el.y + "px";
        node.style.width = el.w + "px";
        node.style.height = el.h + "px";
        node.style.zIndex = el.z;
        node.style.transform = `rotate(${el.rotation || 0}deg)`;
        node.style.transformOrigin = "center center";

        if(el.hidden) node.classList.add("hidden");
        if(el.locked) node.classList.add("locked");

        // Check if element is selected (directly or via group)
        const isSelected = selectedIds.has(el.id) || el.id === selectedId;
        const isInSelectedGroup = Array.from(selectedIds).some(id => {
          const group = elements.find(e => e.id === id && e.type === "group");
          return group && el.groupId === group.id;
        });
        if(isSelected || isInSelectedGroup) node.classList.add("selected");

        const content = document.createElement("div");
        content.className = "content";

        if(el.type === "group"){
          // Groups are invisible containers - just show selection outline
          content.style.background = "transparent";
          content.style.border = "1px dashed #60a5fa";
          content.style.opacity = "0.5";
        }

        if(el.type === "text"){
          const t = document.createElement("div");
          t.className = "textBox";
          t.textContent = el.text || "";
          t.style.fontFamily = el.fontFamily;
          t.style.fontSize = el.fontSize + "px";
          t.style.fontWeight = el.fontWeight;
          t.style.lineHeight = String(el.lineHeight);
          t.style.letterSpacing = (el.letterSpacing ?? 0) + "px";
          t.style.padding = (el.pad ?? 12) + "px";
          t.style.color = el.color;
          t.style.textAlign = el.align;
          t.style.background = rgba(el.bg, el.bgAlpha);

          // Text shadow
          if(el.textShadow && (el.textShadow.x || el.textShadow.y || el.textShadow.blur)) {
            t.style.textShadow = `${el.textShadow.x || 0}px ${el.textShadow.y || 0}px ${el.textShadow.blur || 0}px ${rgba(el.textShadow.color, el.textShadow.alpha)}`;
          }

          t.style.width = "100%";
          t.style.height = "100%";
          t.style.display = "flex";
          t.style.alignItems = "center";
          t.style.justifyContent = el.align === "left" ? "flex-start" : (el.align === "center" ? "center" : "flex-end");

          // Combine filters
          let filters = [];
          if(el.shadowX || el.shadowY || el.shadowBlur) {
            t.style.boxShadow = `${el.shadowX || 0}px ${el.shadowY || 0}px ${el.shadowBlur || 0}px ${rgba(el.shadowColor, el.shadowAlpha)}`;
          }
          if(el.blur > 0) {
            filters.push(`blur(${el.blur}px)`);
          }
          if(filters.length > 0) {
            t.style.filter = filters.join(" ");
          }
          if(el.blendMode && el.blendMode !== "normal") {
            t.style.mixBlendMode = el.blendMode;
          }
          content.appendChild(t);
        }

        if(el.type === "shape"){
          const s = document.createElement("div");
          s.className = "shape";
          s.style.background = rgba(el.fill, el.alpha);
          s.style.border = `${el.borderW}px solid ${rgba(el.border, 1)}`;
          s.style.width = "100%";
          s.style.height = "100%";
          s.style.borderRadius = el.kind === "circle" ? "999px" : (el.radius ?? 12) + "px";

          // Combine filters
          let filters = [];
          if(el.shadowX || el.shadowY || el.shadowBlur) {
            s.style.boxShadow = `${el.shadowX || 0}px ${el.shadowY || 0}px ${el.shadowBlur || 0}px ${rgba(el.shadowColor, el.shadowAlpha)}`;
          }
          if(el.blur > 0) {
            filters.push(`blur(${el.blur}px)`);
          }
          if(filters.length > 0) {
            s.style.filter = filters.join(" ");
          }
          if(el.blendMode && el.blendMode !== "normal") {
            s.style.mixBlendMode = el.blendMode;
          }
          content.appendChild(s);
        }

        if(el.type === "image"){
          const img = document.createElement("img");
          img.className = "img";
          img.src = el.src;
          img.style.objectFit = el.fit || "cover";
          img.style.borderRadius = (el.radius ?? 12) + "px";

          // Combine filters
          let filters = [];
          if(el.shadowX || el.shadowY || el.shadowBlur) {
            img.style.boxShadow = `${el.shadowX || 0}px ${el.shadowY || 0}px ${el.shadowBlur || 0}px ${rgba(el.shadowColor, el.shadowAlpha)}`;
          }
          if(el.blur > 0) {
            filters.push(`blur(${el.blur}px)`);
          }
          if(filters.length > 0) {
            img.style.filter = filters.join(" ");
          }
          if(el.blendMode && el.blendMode !== "normal") {
            img.style.mixBlendMode = el.blendMode;
          }
          content.appendChild(img);
        }

        if(el.type === "icon"){
          const iconDiv = document.createElement("div");
          iconDiv.innerHTML = el.svg;
          iconDiv.style.width = "100%";
          iconDiv.style.height = "100%";
          iconDiv.style.display = "flex";
          iconDiv.style.alignItems = "center";
          iconDiv.style.justifyContent = "center";
          iconDiv.style.color = el.color || "#ffffff";

          // Combine filters
          let filters = [];
          if(el.shadowX || el.shadowY || el.shadowBlur) {
            iconDiv.style.filter = `drop-shadow(${el.shadowX || 0}px ${el.shadowY || 0}px ${el.shadowBlur || 0}px ${rgba(el.shadowColor, el.shadowAlpha)})`;
          }
          if(el.blur > 0) {
            filters.push(`blur(${el.blur}px)`);
          }
          if(filters.length > 0) {
            iconDiv.style.filter = (iconDiv.style.filter ? iconDiv.style.filter + " " : "") + filters.join(" ");
          }
          if(el.blendMode && el.blendMode !== "normal") {
            iconDiv.style.mixBlendMode = el.blendMode;
          }
          const svg = iconDiv.querySelector("svg");
          if(svg){
            svg.style.width = "80%";
            svg.style.height = "80%";
          }
          content.appendChild(iconDiv);
        }

        // Add rotation handle
        if((selectedIds.has(el.id) || el.id === selectedId) && !el.locked){
          const rotateHandle = document.createElement("div");
          rotateHandle.className = "rotate-handle";
          rotateHandle.style.position = "absolute";
          rotateHandle.style.top = "-20px";
          rotateHandle.style.left = "50%";
          rotateHandle.style.transform = "translateX(-50%)";
          rotateHandle.style.width = "12px";
          rotateHandle.style.height = "12px";
          rotateHandle.style.borderRadius = "50%";
          rotateHandle.style.background = "#60a5fa";
          rotateHandle.style.border = "2px solid white";
          rotateHandle.style.cursor = "alias";
          rotateHandle.title = "Rotate";
          node.appendChild(rotateHandle);
        }

        const handle = document.createElement("div");
        handle.className = "handle";
        handle.title = "Resize";
        node.appendChild(content);
        node.appendChild(handle);

        // ✅ Pointer events: works for mouse + touch
        node.addEventListener("pointerdown", (e) => {
          const dragTarget = (el.groupId && el.type !== "group")
            ? (elements.find(x=>x.id===el.groupId) || el)
            : el;
          if(dragTarget.hidden || dragTarget.locked) return;

          // keep receiving moves even if finger leaves the element
          node.setPointerCapture?.(e.pointerId);

          const isRotateHandle = e.target.classList.contains("rotate-handle");
          const isHandle = e.target.classList.contains("handle");

          if(isRotateHandle){
            e.preventDefault();
            select(dragTarget.id);
            startRotatePointer(e, dragTarget.id);
            return;
          }

          if(isHandle){
            e.preventDefault();
            select(dragTarget.id);
            startResizePointer(e, dragTarget.id);
            return;
          }

          e.preventDefault();
          if(e.shiftKey){
            // Multi-select
            select(dragTarget.id, true);
          } else {
            select(dragTarget.id);
          }
          startDragPointer(e, dragTarget.id);
        });

        // Double-click for inline editing
        node.addEventListener("dblclick", (e) => {
          if(el.type === "text" && !el.locked){
            e.preventDefault();
            startInlineEdit(el);
          }
        });

        paper.appendChild(node);
      }

      // Render alignment guides
      renderAlignmentGuides();

      // deselect when clicking blank area
      paper.onpointerdown = (e) => {
        const t = e.target;
        if(t === paper || t.classList.contains("gridOverlay") || t.classList.contains("guides") || t.classList.contains("guide-bleed") || t.classList.contains("guide-safe") || t.classList.contains("centerGuides") || t.classList.contains("alignment-guide")){
          selectedId = null;
          selectedIds.clear();
          updateEditPanel();
          renderLayers();
          render();
          setStatus("No selection", "Ready");
        }
      };
    }

    function renderAlignmentGuides(){
      // Clear existing guides
      paper.querySelectorAll(".alignment-guide").forEach(g => g.remove());

      if(alignmentGuides.length === 0) return;

      for(const guide of alignmentGuides){
        const guideEl = document.createElement("div");
        guideEl.className = "alignment-guide";

        if(guide.type === "vertical"){
          guideEl.style.position = "absolute";
          guideEl.style.left = guide.pos + "px";
          guideEl.style.top = "0";
          guideEl.style.width = "1px";
          guideEl.style.height = "100%";
          guideEl.style.background = "rgba(96, 165, 250, 0.8)";
          guideEl.style.pointerEvents = "none";
          guideEl.style.zIndex = "1000";
        } else if(guide.type === "horizontal"){
          guideEl.style.position = "absolute";
          guideEl.style.top = guide.pos + "px";
          guideEl.style.left = "0";
          guideEl.style.width = "100%";
          guideEl.style.height = "1px";
          guideEl.style.background = "rgba(96, 165, 250, 0.8)";
          guideEl.style.pointerEvents = "none";
          guideEl.style.zIndex = "1000";
        }

        paper.appendChild(guideEl);
      }
    }

    function select(id, multiSelect = false){
      if(multiSelect){
        if(selectedIds.has(id)){
          selectedIds.delete(id);
          if(selectedIds.size === 0){
            selectedId = null;
          } else if(selectedIds.size === 1){
            selectedId = [...selectedIds][0];
          }
        } else {
          selectedIds.add(id);
          selectedId = null;
        }
      } else {
        selectedId = id;
        selectedIds.clear();
        if(id) selectedIds.add(id);
      }
      updateEditPanel();
      renderLayers();
      render();
      const el = getSelected();
      if(el) setStatus("Selected", el.name || "");
    }

    function startInlineEdit(el){
      const node = paper.querySelector(`[data-id="${el.id}"] .textBox`);
      if(!node) return;

      const textarea = document.createElement("textarea");
      textarea.value = el.text || "";
      textarea.style.position = "absolute";
      textarea.style.left = el.x + "px";
      textarea.style.top = el.y + "px";
      textarea.style.width = el.w + "px";
      textarea.style.height = el.h + "px";
      textarea.style.fontFamily = el.fontFamily;
      textarea.style.fontSize = el.fontSize + "px";
      textarea.style.fontWeight = el.fontWeight;
      textarea.style.lineHeight = String(el.lineHeight);
      textarea.style.letterSpacing = (el.letterSpacing ?? 0) + "px";
      textarea.style.padding = (el.pad ?? 12) + "px";
      textarea.style.color = el.color;
      textarea.style.textAlign = el.align;
      textarea.style.background = rgba(el.bg, el.bgAlpha);
      textarea.style.border = "2px solid #60a5fa";
      textarea.style.borderRadius = "8px";
      textarea.style.resize = "none";
      textarea.style.outline = "none";
      textarea.style.zIndex = "2000";

      // Hide the original text
      node.style.visibility = "hidden";

      textarea.focus();
      textarea.select();

      const finishEdit = () => {
        el.text = textarea.value;
        textarea.remove();
        node.style.visibility = "visible";
        render();
        updateEditPanel();
        setStatus("Text edited", "Ready");
      };

      textarea.addEventListener("blur", finishEdit);
      textarea.addEventListener("keydown", (e) => {
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          finishEdit();
        }
        if(e.key === "Escape"){
          e.preventDefault();
          textarea.remove();
          node.style.visibility = "visible";
        }
      });

      paper.appendChild(textarea);
    }

    // ===== Edit panel =====
    function updateEditPanel(){
      const el = getSelected();
      if(!el){
        noSelection.style.display = "block";
        editPanel.style.display = "none";
        noSelectionEffect.style.display = "block";
        effectsPanel.style.display = "none";
        return;
      }
      noSelection.style.display = "none";
      editPanel.style.display = "block";
      noSelectionEffect.style.display = "none";
      effectsPanel.style.display = "block";

      elName.value = el.name || "";
      elType.value = el.type + (el.type==="shape" ? ` (${el.kind})` : "");

      posX.value = Math.round(el.x);
      posY.value = Math.round(el.y);
      sizeW.value = Math.round(el.w);
      sizeH.value = Math.round(el.h);

      textControls.style.display  = (el.type === "text") ? "block" : "none";
      shapeControls.style.display = (el.type === "shape") ? "block" : "none";
      imageControls.style.display = (el.type === "image") ? "block" : "none";

      if(el.type === "text"){
        textValue.value = el.text ?? "";
        fontFamily.value = el.fontFamily || fontFamily.value;
        fontSize.value = Math.round(el.fontSize);
        fontWeight.value = String(el.fontWeight);
        lineHeight.value = el.lineHeight ?? 1.2;
        letterSpacing.value = el.letterSpacing ?? 0;
        textPad.value = el.pad ?? 12;
        textColor.value = el.color;
        textAlign.value = el.align;
        textBg.value = el.bg;
        textBgAlpha.value = el.bgAlpha;
      }
      if(el.type === "shape"){
        shapeFill.value = el.fill;
        shapeAlpha.value = el.alpha;
        shapeBorder.value = el.border;
        shapeBorderW.value = el.borderW;
        shapeRadius.value = el.radius ?? 12;
      }
      if(el.type === "image"){
        imgFit.value = el.fit || "cover";
        imgRadius.value = el.radius ?? 12;
      }

      // Icon controls
      const iconControls = document.getElementById("iconControls");
      if(iconControls){
        if(el.type === "icon"){
          iconControls.style.display = "block";
          document.getElementById("iconColor").value = el.color || "#ffffff";
        } else {
          iconControls.style.display = "none";
        }
      }

      // Effects (for all element types)
      shadowX.value = el.shadowX ?? 0;
      shadowY.value = el.shadowY ?? 0;
      shadowBlur.value = el.shadowBlur ?? 0;
      shadowColor.value = el.shadowColor ?? "#000000";
      shadowAlpha.value = el.shadowAlpha ?? 0.5;
      blurAmount.value = el.blur ?? 0;
      blendMode.value = el.blendMode ?? "normal";
    }
    function updateEditPanelQuiet(){
      const el = getSelected();
      if(!el) return;
      posX.value = Math.round(el.x);
      posY.value = Math.round(el.y);
      sizeW.value = Math.round(el.w);
      sizeH.value = Math.round(el.h);
    }
    function bindInput(input, fn){
      input.addEventListener("input", () => {
        const el = getSelected();
        if(!el) return;
        fn(el);
        render();
        renderLayers();
        updateEditPanelQuiet();
      });
    }

    // name
    elName.addEventListener("input", ()=>{
      const el = getSelected(); if(!el) return;
      el.name = elName.value;
      renderLayers();
    });

    bindInput(posX, (el)=> el.x = snap(clamp(Number(posX.value)||0, 0, paper.clientWidth-10)));
    bindInput(posY, (el)=> el.y = snap(clamp(Number(posY.value)||0, 0, paper.clientHeight-10)));
    bindInput(sizeW, (el)=> el.w = snap(clamp(Number(sizeW.value)||50, 30, paper.clientWidth - el.x)));
    bindInput(sizeH, (el)=> el.h = snap(clamp(Number(sizeH.value)||30, 24, paper.clientHeight - el.y)));

    // text
    bindInput(textValue, (el)=> el.text = textValue.value);
    bindInput(fontFamily, (el)=> el.fontFamily = fontFamily.value);
    bindInput(fontSize, (el)=> el.fontSize = clamp(Number(fontSize.value)||16, 8, 260));
    bindInput(fontWeight, (el)=> el.fontWeight = Number(fontWeight.value)||700);
    bindInput(lineHeight, (el)=> el.lineHeight = clamp(Number(lineHeight.value)||1.2, 0.8, 2.4));
    bindInput(letterSpacing, (el)=> el.letterSpacing = clamp(Number(letterSpacing.value)||0, -2, 10));
    bindInput(textPad, (el)=> el.pad = clamp(Number(textPad.value)||12, 0, 60));
    bindInput(textColor, (el)=> el.color = textColor.value);
    bindInput(textAlign, (el)=> el.align = textAlign.value);
    bindInput(textBg, (el)=> el.bg = textBg.value);
    bindInput(textBgAlpha, (el)=> el.bgAlpha = clamp(Number(textBgAlpha.value)||0, 0, 1));

    // shape
    bindInput(shapeFill, (el)=> el.fill = shapeFill.value);
    bindInput(shapeAlpha, (el)=> el.alpha = clamp(Number(shapeAlpha.value)||0, 0, 1));
    bindInput(shapeBorder, (el)=> el.border = shapeBorder.value);
    bindInput(shapeBorderW, (el)=> el.borderW = clamp(Number(shapeBorderW.value)||0, 0, 30));
    bindInput(shapeRadius, (el)=> el.radius = clamp(Number(shapeRadius.value)||0, 0, 160));

    // image
    bindInput(imgFit, (el)=> el.fit = imgFit.value);
    bindInput(imgRadius, (el)=> el.radius = clamp(Number(imgRadius.value)||0, 0, 160));

    // icon
    bindInput(iconColor, (el)=> el.color = iconColor.value);

    // effects
    bindInput(shadowX, (el)=> el.shadowX = Number(shadowX.value)||0);
    bindInput(shadowY, (el)=> el.shadowY = Number(shadowY.value)||0);
    bindInput(shadowBlur, (el)=> el.shadowBlur = Number(shadowBlur.value)||0);
    bindInput(shadowColor, (el)=> el.shadowColor = shadowColor.value);
    bindInput(shadowAlpha, (el)=> el.shadowAlpha = clamp(Number(shadowAlpha.value)||0, 0, 1));
    bindInput(blurAmount, (el)=> el.blur = clamp(Number(blurAmount.value)||0, 0, 20));
    bindInput(blendMode, (el)=> el.blendMode = blendMode.value);

    // ===== Layers =====
    const ICON_EYE = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>`;
    const ICON_EYE_OFF = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l18 18"/><path d="M10.6 10.6A3 3 0 0 0 12 15a3 3 0 0 0 2.4-4.4"/><path d="M9.9 4.2A10.7 10.7 0 0 1 12 4c6.5 0 10 8 10 8a18.2 18.2 0 0 1-3.4 4.7"/><path d="M6.1 6.1C3.4 8.2 2 12 2 12s3.5 8 10 8a10.5 10.5 0 0 0 4.2-.9"/></svg>`;
    const ICON_UP = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>`;
    const ICON_DOWN = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg>`;

    function normalizeZ(){
      elements = elements.sort((a,b)=>a.z-b.z).map((e,i)=>({ ...e, z:i+1 }));
      zCounter = elements.length + 1;
    }
    function moveLayer(id, dir){
      normalizeZ();
      const idx = elements.findIndex(e=>e.id===id);
      if(idx<0) return;
      const swapIdx = dir>0 ? Math.min(elements.length-1, idx+1) : Math.max(0, idx-1);
      if(swapIdx === idx) return;
      const tmp = elements[idx].z;
      elements[idx].z = elements[swapIdx].z;
      elements[swapIdx].z = tmp;
      render();
      renderLayers();
    }
    function renderLayers(){
      const sorted = [...elements].sort((a,b)=>b.z-a.z);
      layersList.innerHTML = "";
      for(const el of sorted){
        const row = document.createElement("div");
        row.className = "layerRow" + (el.id===selectedId ? " active" : "");
        row.onclick = ()=> select(el.id);

        const title = document.createElement("div");
        title.className = "layerTitle";
        const nm = document.createElement("div");
        nm.className = "name";
        nm.textContent = el.name || el.type;
        const meta = document.createElement("div");
        meta.className = "meta";
        const inGroup = el.groupId ? " • in group" : "";
        meta.textContent = `${el.type}${el.type==="shape" ? `/${el.kind}` : ""} • z:${el.z}${inGroup}` + (el.hidden ? " • hidden" : "");
        title.appendChild(nm);
        title.appendChild(meta);

        const btns = document.createElement("div");
        btns.className = "layerBtns";

        const eye = document.createElement("div");
        eye.className = "iconBtn";
        eye.innerHTML = el.hidden ? ICON_EYE_OFF : ICON_EYE;
        eye.title = el.hidden ? "Show" : "Hide";
        eye.onclick = (ev)=>{
          ev.stopPropagation();
          el.hidden = !el.hidden;
          if(el.hidden && el.id===selectedId){ selectedId=null; updateEditPanel(); }
          render(); renderLayers();
        };

        const up = document.createElement("div");
        up.className = "iconBtn warn";
        up.innerHTML = ICON_UP;
        up.title = "Move Up";
        up.onclick = (ev)=>{ ev.stopPropagation(); moveLayer(el.id, +1); };

        const down = document.createElement("div");
        down.className = "iconBtn warn";
        down.innerHTML = ICON_DOWN;
        down.title = "Move Down";
        down.onclick = (ev)=>{ ev.stopPropagation(); moveLayer(el.id, -1); };

        btns.appendChild(eye);
        btns.appendChild(up);
        btns.appendChild(down);

        row.appendChild(title);
        row.appendChild(btns);
        layersList.appendChild(row);
      }
    }

    // ===== Asset Library =====
    const ICONS = [
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>', // help
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>', // heart
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>', // document
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', // users
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>', // image
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>', // video
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>', // message
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>' // phone
    ];

    function renderAssetGrid(){
      stockResults.innerHTML = "";
      ICONS.forEach((iconSvg, i) => {
        const item = document.createElement("div");
        item.className = "assetItem";
        item.innerHTML = iconSvg;
        item.onclick = () => addIconAsset(iconSvg);
        stockResults.appendChild(item);
      });
    }

    function addIconAsset(svgContent){
      const id = uid();
      const el = {
        id,
        name: "Icon",
        hidden:false,
        locked: false,
        type:"icon",
        groupId: null,
        x: 100,
        y: 100,
        w: 48,
        h: 48,
        rotation: 0,
        z: ++zCounter,
        svg: svgContent,
        color: "#ffffff",
        // Effects
        shadowX: 0, shadowY: 0, shadowBlur: 0, shadowColor: "#000000", shadowAlpha: 0.5,
        blur: 0,
        blendMode: "normal"
      };
      elements.push(el);
      render();
      select(id);
      renderLayers();
    }

    // ===== Templates =====
    function createEventTemplate(){
      clearAll();
      // Background
      addShape("rect", { name:"Background", x:0, y:0, w:paper.clientWidth, h:paper.clientHeight, fill:"#1a1a2e", alpha:1, borderW:0 });
      // Title
      addText({ name:"Event Title", text:"EVENT TITLE", x:50, y:100, w:paper.clientWidth-100, h:80, fontSize:48, color:"#ffffff", align:"center" });
      // Date
      addText({ name:"Date", text:"December 25, 2024", x:50, y:200, w:paper.clientWidth-100, h:40, fontSize:24, color:"#60a5fa", align:"center" });
      // Description
      addText({ name:"Description", text:"Join us for an amazing event!", x:50, y:260, w:paper.clientWidth-100, h:60, fontSize:18, color:"#cccccc", align:"center" });
      // CTA Button
      addButton({ name:"CTA", text:"RSVP Now", x:paper.clientWidth/2-100, y:paper.clientHeight-120, w:200, h:60 });
    }

    function createBusinessTemplate(){
      clearAll();
      // Header
      addShape("rect", { name:"Header", x:0, y:0, w:paper.clientWidth, h:120, fill:"#60a5fa", alpha:1, borderW:0 });
      addText({ name:"Company", text:"COMPANY NAME", x:50, y:30, w:300, h:60, fontSize:32, color:"#ffffff" });
      // Content
      addText({ name:"Headline", text:"Professional Services", x:50, y:160, w:paper.clientWidth-100, h:50, fontSize:36, color:"#000000" });
      addText({ name:"Subtext", text:"We provide quality solutions for your business needs.", x:50, y:230, w:paper.clientWidth-100, h:40, fontSize:18, color:"#666666" });
      // Contact
      addText({ name:"Contact", text:"Call us: (555) 123-4567\nEmail: info@company.com", x:50, y:paper.clientHeight-100, w:300, h:60, fontSize:16, color:"#333333" });
    }

    function createChurchTemplate(){
      clearAll();
      // Background with gradient
      addShape("rect", { name:"Background", x:0, y:0, w:paper.clientWidth, h:paper.clientHeight, fill:"#2d5a27", alpha:1, borderW:0 });
      // Church name
      addText({ name:"Church Name", text:"Grace Community Church", x:50, y:80, w:paper.clientWidth-100, h:60, fontSize:42, color:"#ffffff", align:"center" });
      // Service info
      addText({ name:"Service", text:"Sunday Service\n9:00 AM & 11:00 AM", x:50, y:180, w:paper.clientWidth-100, h:80, fontSize:28, color:"#f0f0f0", align:"center" });
      // Verse
      addText({ name:"Verse", text:"\"For where two or three gather in my name, there am I with them.\"\n- Matthew 18:20", x:50, y:300, w:paper.clientWidth-100, h:100, fontSize:20, color:"#e8e8e8", align:"center" });
      // Address
      addText({ name:"Address", text:"123 Faith Street\nAnytown, USA 12345", x:50, y:paper.clientHeight-120, w:paper.clientWidth-100, h:60, fontSize:18, color:"#cccccc", align:"center" });
    }

    function createSaleTemplate(){
      clearAll();
      // Sale banner
      addShape("rect", { name:"Sale Banner", x:0, y:0, w:paper.clientWidth, h:150, fill:"#dc2626", alpha:1, borderW:0 });
      addText({ name:"Sale", text:"BIG SALE!", x:50, y:40, w:paper.clientWidth-100, h:70, fontSize:56, color:"#ffffff", align:"center" });
      // Discount
      addText({ name:"Discount", text:"Up to 50% OFF", x:50, y:180, w:paper.clientWidth-100, h:50, fontSize:36, color:"#000000", align:"center" });
      // Products
      addText({ name:"Products", text:"All Items on Sale\nLimited Time Offer", x:50, y:260, w:paper.clientWidth-100, h:60, fontSize:24, color:"#333333", align:"center" });
      // CTA
      addButton({ name:"Shop Now", text:"Shop Now", x:paper.clientWidth/2-120, y:paper.clientHeight-100, w:240, h:60, bg:"#dc2626" });
    }

    // ===== Brand Kit =====
    const DEFAULT_BRAND_KIT = {
      colors: ["#60a5fa", "#a78bfa", "#22c55e"],
      fonts: ["ui-sans-serif, system-ui", "Georgia, serif"],
      logo: null,
      profile: {
        name: "Your Business Name",
        tagline: "Quality service you can trust",
        phone: "(555) 123-4567",
        website: "www.example.com",
        ctaText: "Get Started Today"
      }
    };

    let brandKit = JSON.parse(JSON.stringify(DEFAULT_BRAND_KIT));

    function normalizeBrandKit(input){
      const safe = input && typeof input === "object" ? input : {};
      return {
        colors: Array.isArray(safe.colors) && safe.colors.length >= 3
          ? [safe.colors[0], safe.colors[1], safe.colors[2]]
          : [...DEFAULT_BRAND_KIT.colors],
        fonts: Array.isArray(safe.fonts) && safe.fonts.length >= 2
          ? [safe.fonts[0], safe.fonts[1]]
          : [...DEFAULT_BRAND_KIT.fonts],
        logo: safe.logo || null,
        profile: {
          name: safe.profile?.name || DEFAULT_BRAND_KIT.profile.name,
          tagline: safe.profile?.tagline || DEFAULT_BRAND_KIT.profile.tagline,
          phone: safe.profile?.phone || DEFAULT_BRAND_KIT.profile.phone,
          website: safe.profile?.website || DEFAULT_BRAND_KIT.profile.website,
          ctaText: safe.profile?.ctaText || DEFAULT_BRAND_KIT.profile.ctaText
        }
      };
    }

    function updateBrandPreview(){
      logoPreview.innerHTML = brandKit.logo
        ? `<img src="${brandKit.logo}" style="max-width:100%; max-height:80px; border-radius:8px;">`
        : "";
    }

    function applyBrandKitToForm(){
      document.getElementById("brandColor1").value = brandKit.colors[0];
      document.getElementById("brandColor2").value = brandKit.colors[1];
      document.getElementById("brandColor3").value = brandKit.colors[2];
      document.getElementById("brandFont1").value = brandKit.fonts[0];
      document.getElementById("brandFont2").value = brandKit.fonts[1];
      document.getElementById("brandName").value = brandKit.profile.name;
      document.getElementById("brandTagline").value = brandKit.profile.tagline;
      document.getElementById("brandPhone").value = brandKit.profile.phone;
      document.getElementById("brandWebsite").value = brandKit.profile.website;
      document.getElementById("brandCtaText").value = brandKit.profile.ctaText;
      updateBrandPreview();
    }

    function updateBrandKitFromForm(){
      brandKit = normalizeBrandKit({
        ...brandKit,
        colors: [
          document.getElementById("brandColor1").value,
          document.getElementById("brandColor2").value,
          document.getElementById("brandColor3").value
        ],
        fonts: [
          document.getElementById("brandFont1").value,
          document.getElementById("brandFont2").value
        ],
        profile: {
          name: document.getElementById("brandName").value.trim(),
          tagline: document.getElementById("brandTagline").value.trim(),
          phone: document.getElementById("brandPhone").value.trim(),
          website: document.getElementById("brandWebsite").value.trim(),
          ctaText: document.getElementById("brandCtaText").value.trim()
        }
      });
      updateBrandPreview();
    }

    function saveBrandKit(){
      updateBrandKitFromForm();
      localStorage.setItem("flyerBrandKit", JSON.stringify(brandKit));
      setStatus("Brand kit saved", "Ready");
    }

    function loadBrandKit(){
      const saved = localStorage.getItem("flyerBrandKit");
      if(!saved){
        setStatus("No saved brand", "Nothing in local storage");
        return;
      }
      brandKit = normalizeBrandKit(JSON.parse(saved));
      applyBrandKitToForm();
      setStatus("Brand kit loaded", "Ready");
    }

    function resetBrandForm(){
      brandKit = JSON.parse(JSON.stringify(DEFAULT_BRAND_KIT));
      applyBrandKitToForm();
      setStatus("Brand reset", "Defaults restored");
    }

    function setBrandPreset(preset){
      const presets = {
        corporate: {
          colors: ["#1d4ed8", "#0f172a", "#38bdf8"],
          fonts: ["ui-sans-serif, system-ui", "Georgia, serif"]
        },
        warm: {
          colors: ["#ea580c", "#7c2d12", "#f59e0b"],
          fonts: ["Georgia, serif", "ui-sans-serif, system-ui"]
        },
        bold: {
          colors: ["#e11d48", "#111827", "#22c55e"],
          fonts: ["ui-monospace, monospace", "ui-sans-serif, system-ui"]
        }
      };
      const p = presets[preset];
      if(!p) return;
      brandKit = normalizeBrandKit({ ...brandKit, colors: p.colors, fonts: p.fonts });
      applyBrandKitToForm();
      setStatus("Preset applied", preset);
    }

    function addBrandLogoToCanvas(){
      updateBrandKitFromForm();
      if(!brandKit.logo){
        alert("Upload a logo first in the Brand tab.");
        return;
      }
      addImage(brandKit.logo, {
        name: "Brand Logo",
        x: 40, y: 40, w: 180, h: 120,
        fit: "contain",
        radius: 6
      });
      setStatus("Logo added", "Brand logo placed");
    }

    function applyBrandToList(list){
      if(!Array.isArray(list) || list.length === 0){
        setStatus("Brand apply", "Nothing selected");
        return;
      }
      updateBrandKitFromForm();
      const [primary, secondary] = brandKit.colors;
      const [fontPrimary] = brandKit.fonts;

      list.forEach(el => {
        if(el.type === "text"){
          const isButtonLike = (el.bgAlpha ?? 0) > 0.75 || /button|cta/i.test(el.name || "");
          el.fontFamily = fontPrimary;
          if(isButtonLike){
            el.bg = primary;
            el.bgAlpha = 1;
            el.color = "#ffffff";
            el.align = "center";
          } else {
            el.color = secondary;
          }
        } else if(el.type === "shape"){
          el.fill = primary;
          el.border = secondary;
        } else if(el.type === "icon"){
          el.color = secondary;
        }
      });

      render();
      renderLayers();
      updateEditPanel();
      setStatus("Brand applied", `${list.length} element(s) updated`);
    }

    function applyBrandSelected(){
      const selected = getSelectedElements();
      applyBrandToList(selected);
    }

    function applyBrandAll(){
      applyBrandToList(elements);
    }

    function addBrandHeader(){
      updateBrandKitFromForm();
      const [primary, secondary] = brandKit.colors;
      const [fontPrimary] = brandKit.fonts;

      addText({
        name: "Brand Name",
        text: brandKit.profile.name,
        x: 40, y: 40, w: Math.max(320, paper.clientWidth - 80), h: 70,
        fontFamily: fontPrimary, fontSize: 46, fontWeight: 900,
        color: primary, align: "center", bgAlpha: 0
      });
      addText({
        name: "Brand Tagline",
        text: brandKit.profile.tagline,
        x: 60, y: 108, w: Math.max(320, paper.clientWidth - 120), h: 44,
        fontFamily: fontPrimary, fontSize: 22, fontWeight: 600,
        color: secondary, align: "center", bgAlpha: 0
      });
      setStatus("Brand header added", "Ready");
    }

    function addBrandContact(){
      updateBrandKitFromForm();
      const [primary] = brandKit.colors;
      const [fontPrimary] = brandKit.fonts;
      addText({
        name: "Brand Contact",
        text: `${brandKit.profile.phone}\n${brandKit.profile.website}`,
        x: 40,
        y: Math.max(40, paper.clientHeight - 130),
        w: Math.max(300, paper.clientWidth - 80),
        h: 90,
        fontFamily: fontPrimary,
        fontSize: 22,
        fontWeight: 700,
        color: primary,
        align: "center",
        bg: "#000000",
        bgAlpha: 0
      });
      setStatus("Contact block added", "Ready");
    }

    // ===== QR Code & Data Blocks =====
    let qrLibPromise = null;
    function ensureQrLib(){
      if (window.QRCode && typeof window.QRCode.toCanvas === "function") {
        return Promise.resolve();
      }
      if (qrLibPromise) return qrLibPromise;

      const cdnList = [
        "./qrcode.min.js",
        "https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js",
        "https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.js"
      ];

      qrLibPromise = new Promise((resolve, reject) => {
        let i = 0;
        const tryNext = () => {
          if (window.QRCode && typeof window.QRCode.toCanvas === "function") return resolve();
          if (i >= cdnList.length) return reject(new Error("QR library failed to load."));
          const s = document.createElement("script");
          s.src = cdnList[i++];
          s.async = true;
          s.onload = () => {
            if (window.QRCode && typeof window.QRCode.toCanvas === "function") resolve();
            else tryNext();
          };
          s.onerror = tryNext;
          document.head.appendChild(s);
        };
        tryNext();
      });
      return qrLibPromise;
    }

    async function generateQRCode(qrText){
      const qrSize = parseInt(document.getElementById("qrSize").value) || 150;
      const qrErrorLevel = document.getElementById("qrErrorLevel").value || "M";
      try {
        await ensureQrLib();
      } catch (err) {
        console.error(err);
        setStatus("QR failed", "Could not load QR library");
        alert("QR code library could not load. Check internet connection and refresh.");
        return;
      }

      // Create a temporary canvas to generate QR code
      const tempCanvas = document.createElement("canvas");
      window.QRCode.toCanvas(tempCanvas, qrText, {
        width: qrSize,
        height: qrSize,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        },
        errorCorrectionLevel: qrErrorLevel
      }, function (error) {
        if (error) {
          console.error(error);
          alert("Failed to generate QR code. Please try again.");
          return;
        }

        // Convert canvas to data URL
        const qrDataUrl = tempCanvas.toDataURL("image/png");

        const id = uid();
        const el = {
          id,
          name: "QR Code",
          hidden:false,
          type:"image",
          x: paper.clientWidth - qrSize - 50,
          y: 50,
          w: qrSize,
          h: qrSize,
          z: ++zCounter,
          src: qrDataUrl,
          fit: "contain",
          radius: 8,
          shadowX: 0, shadowY: 0, shadowBlur: 0, shadowColor: "#000000", shadowAlpha: 0.5,
          blur: 0,
          blendMode: "normal"
        };
        elements.push(el);
        render();
        select(id);
        renderLayers();
        setStatus("QR Code added", `${qrSize}px, ${qrErrorLevel} error correction`);
      });
    }

    function addDataBlock(){
      const blockType = prompt("Choose data block type: address, contact, schedule, map", "address");
      let text = "";
      switch(blockType){
        case "address":
          text = "123 Main Street\nCity, State 12345\nUnited States";
          break;
        case "contact":
          text = "Phone: (555) 123-4567\nEmail: info@example.com\nWebsite: www.example.com";
          break;
        case "schedule":
          text = "Monday - Friday: 9AM - 5PM\nSaturday: 10AM - 4PM\nSunday: Closed";
          break;
        case "map":
          text = "📍 Find us at:\nGPS: 40.7128° N, 74.0060° W";
          break;
        default:
          text = "Custom data block";
      }

      addText({ name:`${blockType} Block`, text, x:50, y:paper.clientHeight/2, w:300, h:120, fontSize:16, color:"#333333", bg:"#f0f0f0", bgAlpha:0.8 });
    }
    async function exportToPng(){
      const exportDpiVal = Number(exportDpi.value) || 300;
      const scale = exportDpiVal / EDIT_DPI;

      setStatus("Exporting...", `PNG @ ${exportDpiVal} DPI`);

      const clone = paper.cloneNode(true);
      clone.classList.remove("show-grid","show-guides","show-centers");
      clone.querySelectorAll(".gridOverlay,.guides,.centerGuides").forEach(n=>n.remove());
      clone.querySelectorAll(".item").forEach(n=>n.classList.remove("selected"));

      const w = paper.clientWidth;
      const h = paper.clientHeight;
      const outW = Math.round(w * scale);
      const outH = Math.round(h * scale);

      const serializer = new XMLSerializer();
      const html = serializer.serializeToString(clone);

      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${outW}" height="${outH}">
          <foreignObject width="100%" height="100%">
            <div xmlns="http://www.w3.org/1999/xhtml"
                 style="transform: scale(${scale}); transform-origin: top left; width:${w}px; height:${h}px;">
              ${html}
            </div>
          </foreignObject>
        </svg>
      `;

      const svgBlob = new Blob([svg], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = outW;
        canvas.height = outH;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);

        canvas.toBlob((blob)=>{
          if(!blob){
            setStatus("Export failed", "Try Chrome");
            alert("Export failed in this browser. Try Chrome.");
            return;
          }
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `flyer_${canvasPresetKey}_${canvasLandscape ? "land" : "port"}_${exportDpiVal}dpi.png`;
          a.click();
          setStatus("Exported", a.download);
        }, "image/png");
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        setStatus("Export failed", "Try Chrome");
        alert("Export failed in this browser. Try Chrome.");
      };
      img.src = url;
    }

    // ===== Save/Load =====
    function toJSON(){
      return JSON.stringify({
        version: 5, // Updated version for new features
        editDpi: EDIT_DPI,
        presetKey: canvasPresetKey,
        landscape: canvasLandscape,
        background: bgColor.value,
        showGuides: !!showGuides.checked,
        showCenters: !!showCenters.checked,
        snapToGrid: !!snapToGrid.checked,
        elements,
        brandKit // Include brand kit
      }, null, 2);
    }
    function download(filename, text){
      const blob = new Blob([text], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    // ===== UI wiring =====
    function initSizeDropdown(){
      const order = ["a4","letter","a5","half","quarter","postcard4x6","postcard6x9","rack35","rack367"];
      for(const key of order){
        const p = SIZE_PRESETS[key];
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = p.label;
        sizePreset.appendChild(opt);
      }
      sizePreset.value = canvasPresetKey;
    }
    function onCanvasSettingsChange(){
      const presetKey = sizePreset.value;
      const landscape = (orientation.value === "landscape");
      const scale = !!scaleLayout.checked;
      applyCanvasSize({ presetKey, landscape, scale });
      autoFitToScreen();
    }

    function isMobileView(){
      return window.matchMedia("(max-width: 980px)").matches;
    }
    function syncMobilePanelState(){
      if(!isMobileView()){
        leftPanel.classList.remove("open");
        mobilePanelToggle.textContent = "Controls";
        setPaperScale(Number(zoom.value) / 100, false);
        return;
      }
      mobilePanelToggle.textContent = leftPanel.classList.contains("open") ? "Close" : "Controls";
    }
    mobilePanelToggle.onclick = ()=>{
      leftPanel.classList.toggle("open");
      syncMobilePanelState();
      autoFitToScreen(true);
    };

    // Tabs
    function setTab(which){
      tabDesign.classList.toggle("active", which === "design");
      tabLayers.classList.toggle("active", which === "layers");
      tabAssets.classList.toggle("active", which === "assets");
      tabEffects.classList.toggle("active", which === "effects");
      tabTemplates.classList.toggle("active", which === "templates");
      tabBrand.classList.toggle("active", which === "brand");

      designTab.style.display = (which === "design") ? "block" : "none";
      layersTab.style.display = (which === "layers") ? "block" : "none";
      assetsTab.style.display = (which === "assets") ? "block" : "none";
      effectsTab.style.display = (which === "effects") ? "block" : "none";
      templatesTab.style.display = (which === "templates") ? "block" : "none";
      brandTab.style.display = (which === "brand") ? "block" : "none";
    }
    tabDesign.onclick = ()=>setTab("design");
    tabLayers.onclick = ()=>setTab("layers");
    tabAssets.onclick = ()=>setTab("assets");
    tabEffects.onclick = ()=>setTab("effects");
    tabTemplates.onclick = ()=>setTab("templates");
    tabBrand.onclick = ()=>setTab("brand");

    // Buttons
    document.getElementById("addText").onclick = () => addText({ name:"Text", x:70, y:90, w:520, h:90 });
    document.getElementById("addCta").onclick = () => addButton({ name:"Button" });
    document.getElementById("addRect").onclick = () => addShape("rect",{});
    document.getElementById("addCircle").onclick = () => addShape("circle",{ w:220, h:220, x:Math.max(40, paper.clientWidth - 280), y:220 });

    // New buttons
    document.getElementById("addIcon").onclick = () => setTab("assets");
    document.getElementById("addShapeAsset").onclick = () => addShape("rect", { name:"Shape Asset", x:100, y:100, w:200, h:150 });
    document.getElementById("addPattern").onclick = () => addShape("rect", { name:"Pattern", x:50, y:50, w:paper.clientWidth-100, h:paper.clientHeight-100, fill:"#f0f0f0", alpha:0.1 });
    document.getElementById("searchStock").onclick = () => renderAssetGrid();
    document.getElementById("uploadAsset").onclick = () => document.getElementById("imgUpload").click();

    // Template buttons
    document.getElementById("eventTemplate").onclick = createEventTemplate;
    document.getElementById("businessTemplate").onclick = createBusinessTemplate;
    document.getElementById("churchTemplate").onclick = createChurchTemplate;
    document.getElementById("saleTemplate").onclick = createSaleTemplate;
    document.getElementById("socialResize").onclick = () => alert("Social resize feature - convert to Instagram/Facebook formats");
    document.getElementById("addQR").onclick = () => {
      const qrText = prompt("Enter URL or text for QR code:", "https://example.com");
      if(qrText) generateQRCode(qrText);
    };
    document.getElementById("addDataBlock").onclick = addDataBlock;

    // New template buttons (bind all matches because these IDs appear in multiple tabs)
    document.querySelectorAll("#addHeaderTemplate").forEach(btn => btn.onclick = addHeaderTemplate);
    document.querySelectorAll("#addHeroTemplate").forEach(btn => btn.onclick = addHeroTemplate);
    document.querySelectorAll("#addCallToAction").forEach(btn => btn.onclick = addCallToAction);
    document.querySelectorAll("#addFooterTemplate").forEach(btn => btn.onclick = addFooterTemplate);

    // QR Code preset buttons
    document.getElementById("qrWebsite").onclick = () => {
      const url = prompt("Enter website URL:", "https://example.com");
      if(url) generateQRCode(url);
    };
    document.getElementById("qrPhone").onclick = () => {
      const phone = prompt("Enter phone number:", "+1234567890");
      if(phone) generateQRCode(`tel:${phone}`);
    };
    document.getElementById("qrEmail").onclick = () => {
      const email = prompt("Enter email address:", "info@example.com");
      if(email) generateQRCode(`mailto:${email}`);
    };
    document.getElementById("qrLocation").onclick = () => {
      const location = prompt("Enter location (address or coordinates):", "123 Main St, City, State");
      if(location) generateQRCode(`geo:0,0?q=${encodeURIComponent(location)}`);
    };

    // Brand buttons
    document.getElementById("saveBrand").onclick = saveBrandKit;
    document.getElementById("loadBrand").onclick = loadBrandKit;
    document.getElementById("resetBrandForm").onclick = resetBrandForm;
    document.getElementById("applyBrandSelected").onclick = applyBrandSelected;
    document.getElementById("applyBrandAll").onclick = applyBrandAll;
    document.getElementById("addLogoToCanvas").onclick = addBrandLogoToCanvas;
    document.getElementById("addBrandHeader").onclick = addBrandHeader;
    document.getElementById("addBrandContact").onclick = addBrandContact;
    document.getElementById("brandPresetCorporate").onclick = ()=> setBrandPreset("corporate");
    document.getElementById("brandPresetWarm").onclick = ()=> setBrandPreset("warm");
    document.getElementById("brandPresetBold").onclick = ()=> setBrandPreset("bold");

    document.getElementById("exportPng").onclick = exportToPng;
    document.getElementById("exportPdf").onclick = exportPdf;

    document.getElementById("downloadJson").onclick = ()=>{ download("flyer.json", toJSON()); setStatus("Saved", "flyer.json downloaded"); };
    document.getElementById("uploadJsonBtn").onclick = ()=> document.getElementById("uploadJson").click();

    document.getElementById("uploadJson").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data || !Array.isArray(data.elements)) throw new Error("Invalid");
          canvasPresetKey = (data.presetKey && SIZE_PRESETS[data.presetKey]) ? data.presetKey : "a4";
          canvasLandscape = !!data.landscape;
          sizePreset.value = canvasPresetKey;
          orientation.value = canvasLandscape ? "landscape" : "portrait";

          bgColor.value = data.background || "#0b1220";
          paper.style.background = bgColor.value;

          showGuides.checked = !!data.showGuides;
          showCenters.checked = !!data.showCenters;
          snapToGrid.checked = data.snapToGrid !== false;

          paper.classList.toggle("show-guides", showGuides.checked);
          paper.classList.toggle("show-centers", showCenters.checked);

          elements = data.elements;
          zCounter = elements.reduce((m,x)=>Math.max(m, x.z||1), 1);

          // Load brand kit if available
          if(data.brandKit){
            brandKit = normalizeBrandKit(data.brandKit);
            applyBrandKitToForm();
          }

          applyCanvasSize({ presetKey: canvasPresetKey, landscape: canvasLandscape, scale:false });

          selectedId=null;
          render(); renderLayers(); updateEditPanel();
          setStatus("Loaded", "JSON applied");

          autoFitToScreen();
        }catch(err){
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(f);
      e.target.value = "";
    });

    document.getElementById("imgUpload").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> addImage(reader.result, {});
      reader.readAsDataURL(f);
      e.target.value = "";
    });

    // Logo upload
    document.getElementById("logoUpload").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        brandKit.logo = reader.result;
        updateBrandPreview();
        setStatus("Logo uploaded", "Ready");
      };
      reader.readAsDataURL(f);
      e.target.value = "";
    });

    applyBrandKitToForm();

    // Initialize asset grid
    renderAssetGrid();

    // Grid / Guides / Centers
    toggleGrid.onclick = ()=> paper.classList.toggle("show-grid");
    showGuides.addEventListener("change", ()=> paper.classList.toggle("show-guides", showGuides.checked));
    showCenters.addEventListener("change", ()=> paper.classList.toggle("show-centers", showCenters.checked));

    // Size + orientation
    sizePreset.addEventListener("change", onCanvasSettingsChange);
    orientation.addEventListener("change", onCanvasSettingsChange);

    // Zoom (manual overrides)
    zoom.addEventListener("input", ()=>{
      const z = Number(zoom.value) / 100;
      setPaperScale(z, isMobileView());
      zoomLabel.textContent = `${zoom.value}%`;
    });

    // Background
    bgColor.addEventListener("input", ()=> paper.style.background = bgColor.value);

    // Arrange/Align
    document.getElementById("bringFront").onclick = ()=>{
      const el = getSelected(); if(!el) return;
      el.z = ++zCounter;
      render(); renderLayers();
    };
    document.getElementById("sendBack").onclick = ()=>{
      const el = getSelected(); if(!el) return;
      el.z = 1;
      normalizeZ();
      render(); renderLayers();
    };
    document.getElementById("alignLeft").onclick = ()=>{
      const selectedElements = getSelectedElements();
      if(selectedElements.length === 0) return;
      const leftmost = Math.min(...selectedElements.map(el => el.x));
      selectedElements.forEach(el => el.x = snap(leftmost));
      render(); updateEditPanelQuiet(); renderLayers();
    };
    document.getElementById("alignCenter").onclick = ()=>{
      const selectedElements = getSelectedElements();
      if(selectedElements.length === 0) return;
      const centerX = Math.round(paper.clientWidth / 2);
      selectedElements.forEach(el => el.x = snap(centerX - el.w / 2));
      render(); updateEditPanelQuiet(); renderLayers();
    };
    document.getElementById("alignRight").onclick = ()=>{
      const selectedElements = getSelectedElements();
      if(selectedElements.length === 0) return;
      const rightmost = Math.max(...selectedElements.map(el => el.x + el.w));
      selectedElements.forEach(el => el.x = snap(rightmost - el.w));
      render(); updateEditPanelQuiet(); renderLayers();
    };

    document.getElementById("distributeHoriz").onclick = ()=>{
      const selectedElements = getSelectedElements();
      if(selectedElements.length < 3) return;
      const sorted = selectedElements.sort((a,b)=>a.x - b.x);
      const leftmost = sorted[0].x;
      const rightmost = sorted[sorted.length-1].x + sorted[sorted.length-1].w;
      const totalWidth = rightmost - leftmost;
      const totalElementsWidth = sorted.reduce((sum, el) => sum + el.w, 0);
      const spacing = (totalWidth - totalElementsWidth) / (sorted.length - 1);
      
      let currentX = leftmost;
      sorted.forEach(el => {
        el.x = snap(currentX);
        currentX += el.w + spacing;
      });
      render(); updateEditPanelQuiet(); renderLayers();
    };

    document.getElementById("distributeVert").onclick = ()=>{
      const selectedElements = getSelectedElements();
      if(selectedElements.length < 3) return;
      const sorted = selectedElements.sort((a,b)=>a.y - b.y);
      const topmost = sorted[0].y;
      const bottommost = sorted[sorted.length-1].y + sorted[sorted.length-1].h;
      const totalHeight = bottommost - topmost;
      const totalElementsHeight = sorted.reduce((sum, el) => sum + el.h, 0);
      const spacing = (totalHeight - totalElementsHeight) / (sorted.length - 1);
      
      let currentY = topmost;
      sorted.forEach(el => {
        el.y = snap(currentY);
        currentY += el.h + spacing;
      });
      render(); updateEditPanelQuiet(); renderLayers();
    };

    document.getElementById("matchWidth").onclick = ()=>{
      const selectedElements = getSelectedElements();
      if(selectedElements.length < 2) return;
      const targetWidth = selectedElements[0].w;
      selectedElements.slice(1).forEach(el => el.w = targetWidth);
      render(); updateEditPanelQuiet(); renderLayers();
    };

    document.getElementById("matchHeight").onclick = ()=>{
      const selectedElements = getSelectedElements();
      if(selectedElements.length < 2) return;
      const targetHeight = selectedElements[0].h;
      selectedElements.slice(1).forEach(el => el.h = targetHeight);
      render(); updateEditPanelQuiet(); renderLayers();
    };

    function getGroupChildren(groupId){
      return elements.filter(e=>e.groupId === groupId);
    }
    function updateGroupBounds(groupId){
      const group = elements.find(e=>e.id === groupId && e.type === "group");
      if(!group) return;
      const children = getGroupChildren(groupId);
      if(children.length === 0){
        elements = elements.filter(e=>e.id !== groupId);
        return;
      }
      group.x = Math.min(...children.map(e=>e.x));
      group.y = Math.min(...children.map(e=>e.y));
      group.w = Math.max(...children.map(e=>e.x + e.w)) - group.x;
      group.h = Math.max(...children.map(e=>e.y + e.h)) - group.y;
    }

    function removeSelected(){
      const idsToDelete = new Set();
      if(selectedId) idsToDelete.add(selectedId);
      selectedIds.forEach(id=>idsToDelete.add(id));
      if(idsToDelete.size === 0) return;

      for(const id of [...idsToDelete]){
        const el = elements.find(e=>e.id===id);
        if(el?.type === "group"){
          getGroupChildren(el.id).forEach(ch=>idsToDelete.add(ch.id));
        }
      }

      elements = elements.filter(e=>!idsToDelete.has(e.id));
      selectedId = null;
      selectedIds.clear();
      render(); renderLayers(); updateEditPanel();
      setStatus("Deleted", "Ready");
    }

    function groupSelected(){
      const selectedElements = elements.filter(e=>selectedIds.has(e.id));
      if(selectedElements.length < 2){
        alert("Select at least 2 elements to group.");
        return;
      }
      if(selectedElements.some(e=>e.type === "group")){
        alert("Ungroup existing groups first before creating a new group.");
        return;
      }
      if(selectedElements.some(e=>e.groupId)){
        alert("Some selected elements are already grouped.");
        return;
      }

      const minX = Math.min(...selectedElements.map(e=>e.x));
      const minY = Math.min(...selectedElements.map(e=>e.y));
      const maxX = Math.max(...selectedElements.map(e=>e.x + e.w));
      const maxY = Math.max(...selectedElements.map(e=>e.y + e.h));
      const topZ = Math.max(...selectedElements.map(e=>e.z || 1), 1);

      const group = {
        id: uid(),
        type: "group",
        name: `Group (${selectedElements.length})`,
        x: minX,
        y: minY,
        w: maxX - minX,
        h: maxY - minY,
        z: topZ + 1,
        bg: "#ffffff",
        bgAlpha: 0,
        locked: false,
        hidden: false
      };

      selectedElements.forEach(e=>{
        e.groupId = group.id;
        if(e.z >= group.z) e.z = group.z - 1;
      });
      elements.push(group);
      zCounter = Math.max(zCounter, group.z);
      select(group.id);
      render(); renderLayers(); updateEditPanel();
      setStatus("Grouped", `${selectedElements.length} elements`);
    }

    function ungroupSelected(){
      const group = getSelected();
      if(!group || group.type !== "group") return;
      const children = getGroupChildren(group.id);
      children.forEach(ch=> ch.groupId = null);
      elements = elements.filter(e=>e.id !== group.id);
      if(children[0]) select(children[0].id);
      render(); renderLayers(); updateEditPanel();
      setStatus("Ungrouped", `${children.length} elements`);
    }
    function duplicateSelected(){
      const el = getSelected(); if(!el) return;
      if(el.type === "group"){
        const children = getGroupChildren(el.id);
        if(children.length === 0) return;
        const groupCopyId = uid();
        const groupCopy = JSON.parse(JSON.stringify(el));
        groupCopy.id = groupCopyId;
        groupCopy.name = `${el.name || "Group"} copy`;
        groupCopy.x = clamp(groupCopy.x + 20, 0, paper.clientWidth - 10);
        groupCopy.y = clamp(groupCopy.y + 20, 0, paper.clientHeight - 10);
        groupCopy.z = ++zCounter;
        elements.push(groupCopy);
        children.forEach(ch=>{
          const c = JSON.parse(JSON.stringify(ch));
          c.id = uid();
          c.groupId = groupCopyId;
          c.x = clamp(c.x + 20, 0, paper.clientWidth - 10);
          c.y = clamp(c.y + 20, 0, paper.clientHeight - 10);
          c.z = Math.max(1, (groupCopy.z || 2) - 1);
          elements.push(c);
        });
        updateGroupBounds(groupCopyId);
        render();
        select(groupCopyId);
        renderLayers();
        setStatus("Duplicated", "Group copy created");
        return;
      }

      const copy = JSON.parse(JSON.stringify(el));
      copy.id = uid();
      copy.x = clamp(copy.x + 20, 0, paper.clientWidth - 10);
      copy.y = clamp(copy.y + 20, 0, paper.clientHeight - 10);
      copy.z = ++zCounter;
      elements.push(copy);
      render();
      select(copy.id);
      renderLayers();
      setStatus("Duplicated", "Ready");
    }
    document.getElementById("deleteEl").onclick = removeSelected;
    document.getElementById("duplicateEl").onclick = duplicateSelected;
    document.getElementById("groupEl").onclick = groupSelected;
    document.getElementById("ungroupEl").onclick = ungroupSelected;

    // Layer actions
    document.getElementById("moveUp").onclick = ()=> selectedId && moveLayer(selectedId, +1);
    document.getElementById("moveDown").onclick = ()=> selectedId && moveLayer(selectedId, -1);
    document.getElementById("deleteLayer").onclick = removeSelected;
    document.getElementById("clearAll").onclick = clearAll;

    // Shortcuts (Backspace does NOT delete)
    window.addEventListener("keydown", (e) => {
      const t = e.target;
      const typing =
        t &&
        (t.tagName === "INPUT" ||
         t.tagName === "TEXTAREA" ||
         t.tagName === "SELECT" ||
         t.isContentEditable);

      if (typing) return;

      const el = getSelected();
      const isMac = navigator.platform.toLowerCase().includes("mac");
      const mod = isMac ? e.metaKey : e.ctrlKey;

      // Duplicate: Ctrl/Cmd + D
      if (mod && e.key.toLowerCase() === "d") {
        e.preventDefault();
        duplicateSelected();
        return;
      }

      // Delete element ONLY with Delete key
      if (e.key === "Delete") {
        if (selectedId) {
          e.preventDefault();
          removeSelected();
        }
        return;
      }

      if (!el) return;

      // Move with arrows (Shift = bigger)
      const step = e.shiftKey ? 10 : 2;
      if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(e.key)) {
        e.preventDefault();
        if (e.key === "ArrowLeft")  el.x = snap(clamp(el.x - step, 0, paper.clientWidth - 10));
        if (e.key === "ArrowRight") el.x = snap(clamp(el.x + step, 0, paper.clientWidth - 10));
        if (e.key === "ArrowUp")    el.y = snap(clamp(el.y - step, 0, paper.clientHeight - 10));
        if (e.key === "ArrowDown")  el.y = snap(clamp(el.y + step, 0, paper.clientHeight - 10));
        render();
        updateEditPanelQuiet();
        renderLayers();
      }
    });

    // ===== Init =====
    initSizeDropdown();

    // default canvas A4 portrait
    sizePreset.value = "a4";
    orientation.value = "portrait";
    canvasPresetKey = "a4";
    canvasLandscape = false;

    setPaperScale(1, isMobileView());
    zoom.value = 100;
    zoomLabel.textContent = "100%";

    paper.classList.toggle("show-guides", false);
    paper.classList.toggle("show-centers", false);

    applyCanvasSize({ presetKey:"a4", landscape:false, scale:false });

    // IMPORTANT: start BLANK
    clearAll();

    // Auto-fit on load for small screens, and keep fitting on resize/orientation change
    syncMobilePanelState();
    autoFitToScreen();
    window.addEventListener("resize", ()=>{
      syncMobilePanelState();
      autoFitToScreen();
    });
    window.addEventListener("orientationchange", ()=> setTimeout(()=>{
      syncMobilePanelState();
      autoFitToScreen(true);
    }, 150));
    });
  </script>
</body>
</html>
